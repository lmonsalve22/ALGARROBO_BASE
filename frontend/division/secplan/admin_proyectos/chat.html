<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Inteligente Geoportal - ZhipuAI Integration</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Marked.js para Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- Estilos Generales --- */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Scrollbar personalizada */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- Estilos Chat --- */
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .messages-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message-wrapper {
            display: flex;
            gap: 1rem;
            max-width: 90%;
            animation: fadeIn 0.3s ease-out;
        }

        .message-wrapper.user {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        .message-content {
            padding: 1rem;
            border-radius: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message-wrapper.bot .message-content {
            background-color: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 0.25rem;
        }

        .message-wrapper.user .message-content {
            background-color: #4f46e5;
            /* Indigo 600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .bot .avatar {
            background-color: #e0e7ff;
            color: #4338ca;
        }

        .user .avatar {
            background-color: #c7d2fe;
            color: #312e81;
        }

        .message-meta {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            opacity: 0.7;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .bot .message-meta {
            justify-content: flex-start;
        }

        .user .message-meta {
            justify-content: flex-end;
        }

        /* Markdown Styles dentro del Chat */
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-body p {
            margin-bottom: 0.5em;
        }

        .markdown-body code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.1em 0.3em;
            border-radius: 0.2rem;
            font-family: monospace;
        }

        .user .markdown-body code {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .markdown-body pre {
            background-color: #1e293b;
            color: #f1f5f9;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .markdown-body pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }

        /* Sugerencias */
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .suggestion-chip {
            background-color: white;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .suggestion-chip:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
            transform: translateY(-1px);
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Proyecto Lista */
        .project-card-selected {
            background-color: #eff6ff !important;
            border-color: #4f46e5 !important;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.9rem;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Dots */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header inyectado por layout.js -->
    <div id="headerRender"></div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Aside/Sidebar inyectado por layout.js -->
        <div id="asideRender"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col p-6 overflow-hidden relative">

            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-robot text-indigo-600"></i> Asistente Inteligente ZhipuAI
                    </h2>
                    <p class="text-gray-500 text-sm">Selecciona proyectos y consulta con IA potenciada por GLM-4.</p>
                </div>
            </div>

            <!-- 1. Barra de Filtros -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 flex-shrink-0">
                <div class="flex flex-col md:flex-row gap-4 justify-between items-end md:items-center">

                    <!-- Buscador -->
                    <div class="w-full md:w-1/4">
                        <label for="filterSearch"
                            class="block text-xs font-semibold text-gray-500 uppercase mb-1">Buscar</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filterSearch"
                                class="pl-10 block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2"
                                placeholder="Nombre, c√≥digo...">
                        </div>
                    </div>

                    <!-- Filtros Select -->
                    <div class="flex flex-1 w-full gap-3">
                        <!-- √Årea -->
                        <div class="flex-1">
                            <label for="filterArea"
                                class="block text-xs font-semibold text-gray-500 uppercase mb-1">√Årea</label>
                            <select id="filterArea"
                                class="block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                <option value="">Cargando...</option>
                            </select>
                        </div>

                        <!-- Estado -->
                        <div class="flex-1">
                            <label for="filterStatus"
                                class="block text-xs font-semibold text-gray-500 uppercase mb-1">Estado</label>
                            <select id="filterStatus"
                                class="block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                <option value="">Cargando...</option>
                            </select>
                        </div>

                        <!-- Financiamiento -->
                        <div class="flex-1">
                            <label for="filterFinancing"
                                class="block text-xs font-semibold text-gray-500 uppercase mb-1">Financiamiento</label>
                            <select id="filterFinancing"
                                class="block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                <option value="">Cargando...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="flex gap-2">
                        <button onclick="clearFilters()"
                            class="px-4 py-2 bg-gray-100 text-gray-600 text-sm font-medium rounded-md hover:bg-gray-200 transition">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                        <button onclick="selectAllFiltered()"
                            class="px-4 py-2 bg-indigo-50 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-100 transition">
                            <i class="fas fa-check-double"></i> Sel. Visibles
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Contenedor Flex: Lista Proyectos (Izq) + Chat (Der) -->
            <div class="flex gap-4 flex-1 min-h-0">

                <!-- Columna Izquierda: Lista de Proyectos -->
                <div class="w-1/3 bg-white rounded-lg shadow border border-gray-200 flex flex-col relative">
                    <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center rounded-t-lg">
                        <span class="font-semibold text-gray-700 text-sm">Proyectos Disponibles</span>
                        <span id="visibleCount"
                            class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">0</span>
                    </div>

                    <div id="projectsLoading" class="loading-overlay hidden">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-spinner fa-spin text-indigo-600 text-2xl mb-2"></i>
                            <span class="text-xs text-gray-500">Cargando datos...</span>
                        </div>
                    </div>

                    <div id="projectListContainer" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                        <!-- Items renderizados por JS -->
                    </div>

                    <div class="p-3 border-t border-gray-100 text-xs text-gray-400 bg-gray-50 rounded-b-lg">
                        <i class="fas fa-info-circle mr-1"></i> Selecciona para analizar en el chat.
                    </div>
                </div>

                <!-- Columna Derecha: Chat UI (L√≥gica ZhipuAI) -->
                <div class="w-2/3 chat-container">
                    <!-- Header Chat -->
                    <div
                        class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-sm font-bold text-gray-700">Asistente Municipal (GLM-4)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="chatContextBadge"
                                class="hidden text-xs font-medium bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full flex items-center gap-1">
                                <i class="fas fa-database"></i> <span id="selectedCountMsg">0</span> proyectos en
                                contexto
                            </span>
                            <div class="h-4 w-px bg-gray-300 mx-1"></div>
                            <button onclick="clearChat()" class="text-gray-400 hover:text-red-500 transition"
                                title="Limpiar chat">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="exportConversation()"
                                class="text-gray-400 hover:text-indigo-600 transition" title="Exportar conversaci√≥n">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>

                    <!-- √Årea de Mensajes -->
                    <div class="messages-area custom-scroll" id="messagesArea">
                        <!-- Mensaje de Bienvenida -->
                        <div class="message-wrapper bot">
                            <div class="avatar"><i class="fas fa-robot"></i></div>
                            <div class="flex-1">
                                <div class="message-content markdown-body">
                                    <p><strong>¬°Hola! Soy tu asistente potenciado</strong></p>
                                    <p>Estoy conectado a los datos del Geoportal. Selecciona proyectos de la lista
                                        izquierda y hazme preguntas sobre:</p>
                                    <ul>
                                        <li>An√°lisis de montos y presupuestos.</li>
                                        <li>Estados de avance por √°rea.</li>
                                        <li>Comparaci√≥n entre proyectos.</li>
                                    </ul>
                                </div>
                                <div class="message-meta text-gray-500" id="initial-timestamp">Hoy, --:--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicador escribiendo -->
                    <div id="typingIndicator" class="hidden px-4 py-2 bg-gray-50 flex items-center gap-2">
                        <div class="message-content py-2 px-4 text-xs text-gray-500 bg-gray-100 border-0 shadow-none">
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                        </div>
                    </div>

                    <!-- Input Chat -->
                    <div class="p-4 bg-white border-t border-gray-100">
                        <!-- El formulario maneja el env√≠o correctamente ahora -->
                        <form id="chatForm" class="flex items-end gap-2">
                            <button type="button" id="voiceButton"
                                class="p-2.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition"
                                title="Dictar por voz">
                                <i class="fas fa-microphone"></i>
                            </button>

                            <div class="flex-1 relative">
                                <input type="text" id="chatInput"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-3 pr-12"
                                    placeholder="Escribe tu pregunta aqu√≠..." autocomplete="off">
                                <div id="charCounter" class="absolute bottom-2 right-3 text-[10px] text-gray-400">0/500
                                </div>
                            </div>

                            <button type="submit" id="sendButton"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg shadow-sm transition-colors flex items-center justify-center w-11 h-11">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Contenedor de Toasts -->
    <div id="toast-container"></div>

    <!-- Script de Funcionalidad Unificada -->
    <script>
        // --- CONFIGURACI√ìN ZHIPU AI ---
        const API_KEY = "1dbcda64e67c4d31a7e9e5565efc5cae.M5ZIv5sFPbdOwgKw";
        //const API_URL = "https://api.z.ai/api/paas/v4/chat/completions";
        const API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
        const MODEL_NAME = "GLM-4.5-Flash";
        //const MODEL_NAME = "glm-4.5-flash"; 

        // Configuraci√≥n Chat
        const CHAT_CONFIG = {
            MAX_HISTORY_LENGTH: 10,
            MAX_INPUT_LENGTH: 500
        };

        // Estado de la Aplicaci√≥n
        const AppState = {
            allProjects: [], // Proyectos desde API Geoportal
            selectedIds: new Set(), // IDs seleccionados en UI
            chatHistory: [], // Historial conversaci√≥n Zhipu
            recognition: null, // Voz a Texto
            synthesis: window.speechSynthesis, // Texto a Voz,
            filterProject: []
        };

        // Referencias DOM
        const DOM = {
            // Proyectos
            projectListContainer: document.getElementById('projectListContainer'),
            filterSearch: document.getElementById('filterSearch'),
            filterArea: document.getElementById('filterArea'),
            filterStatus: document.getElementById('filterStatus'),
            filterFinancing: document.getElementById('filterFinancing'),
            visibleCount: document.getElementById('visibleCount'),
            projectsLoading: document.getElementById('projectsLoading'),

            // Chat
            messagesArea: document.getElementById('messagesArea'),
            chatForm: document.getElementById('chatForm'),
            chatInput: document.getElementById('chatInput'),
            typingIndicator: document.getElementById('typingIndicator'),
            voiceButton: document.getElementById('voiceButton'),
            charCounter: document.getElementById('charCounter'),
            chatContextBadge: document.getElementById('chatContextBadge'),
            selectedCountMsg: document.getElementById('selectedCountMsg')
        };

        // --- 1. L√ìGICA DE PROYECTOS (Geoportal) ---

        const API_BASE = 'https://186.67.61.251:8000';

        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            };
        }

        async function loadProjects() {
            try {
                DOM.projectsLoading.classList.remove('hidden');
                const response = await fetch(`${API_BASE}/proyectos`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) throw new Error(`Error API: ${response.status}`);
                AppState.allProjects = await response.json();
                AppState.filterProject = AppState.allProjects;

                initFilters();
            } catch (error) {
                console.error('Error al cargar proyectos:', error);
                DOM.projectListContainer.innerHTML = `
                    <div class="p-4 text-center text-red-500 text-sm">
                        <i class="fas fa-exclamation-circle mb-2"></i><br>
                        Error cargando datos.
                    </div>`;
            } finally {
                DOM.projectsLoading.classList.add('hidden');
            }
        }

        function initFilters() {
            // Listeners
            DOM.filterSearch.addEventListener('input', applyFilters);
            DOM.filterArea.addEventListener('change', applyFilters);
            DOM.filterStatus.addEventListener('change', applyFilters);
            DOM.filterFinancing.addEventListener('change', applyFilters);

            populateDropdowns();
            applyFilters();
        }

        function populateDropdowns() {
            const areas = [...new Set(AppState.allProjects.map(p => p.area).filter(Boolean))].sort();
            const statuses = [...new Set(AppState.allProjects.map(p => p.estado_proyecto).filter(Boolean))].sort();
            const financings = [...new Set(AppState.allProjects.map(p => p.financiamiento).filter(Boolean))].sort();

            fillSelect(DOM.filterArea, areas, "Todas las √°reas");
            fillSelect(DOM.filterStatus, statuses, "Todos los estados");
            fillSelect(DOM.filterFinancing, financings, "Todo el financiamiento");
        }

        function fillSelect(selectEl, options, defaultLabel) {
            selectEl.innerHTML = `<option value="">${defaultLabel}</option>`;
            options.forEach(opt => selectEl.innerHTML += `<option value="${opt}">${opt}</option>`);
        }

        function applyFilters() {
            const txt = DOM.filterSearch.value.toLowerCase();
            const area = DOM.filterArea.value;
            const status = DOM.filterStatus.value;
            const fin = DOM.filterFinancing.value;

            const filtered = AppState.allProjects.filter(p => {
                const matchTxt = (p.nombre && p.nombre.toLowerCase().includes(txt)) ||
                    (p.codigo && p.codigo.toLowerCase().includes(txt));
                const matchArea = area === "" || p.area === area;
                const matchStatus = status === "" || p.estado_proyecto === status;
                const matchFin = fin === "" || p.financiamiento === fin;
                return matchTxt && matchArea && matchStatus && matchFin;
            });
            AppState.filterProject = filtered;

            renderProjectList(filtered);
            DOM.visibleCount.textContent = filtered.length;
        }

        function clearFilters() {
            DOM.filterSearch.value = "";
            DOM.filterArea.value = "";
            DOM.filterStatus.value = "";
            DOM.filterFinancing.value = "";
            AppState.selectedIds.clear();
            updateContextUI();
            applyFilters();
        }

        function selectAllFiltered() {
            const checkboxes = document.querySelectorAll('.project-checkbox');
            checkboxes.forEach(cb => {
                const id = parseInt(cb.value);
                AppState.selectedIds.add(id);
                cb.checked = true;
                const card = cb.closest('.cursor-pointer');
                if (card) card.classList.add('project-card-selected');
            });
            updateContextUI();
        }

        function renderProjectList(list) {
            DOM.projectListContainer.innerHTML = "";
            if (list.length === 0) {
                DOM.projectListContainer.innerHTML = `<div class="p-4 text-center text-gray-400 text-sm">No hay proyectos con estos filtros.</div>`;
                return;
            }

            list.forEach(p => {
                const isSelected = AppState.selectedIds.has(p.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded border border-gray-200 cursor-pointer hover:shadow-md transition-colors ${isSelected ? 'project-card-selected' : 'bg-white hover:bg-gray-50'}`;
                div.onclick = (e) => toggleSelection(p.id, div, e);

                const estado = p.estado_proyecto || 'Sin Estado';
                const monto = p.monto ? formatCompact(p.monto) : '$0';
                const codigo = p.codigo || 'N/A';
                const nombre = p.nombre || 'Sin Nombre';

                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="pt-1">
                            <input type="checkbox" class="project-checkbox w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer" 
                                value="${p.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelection(${p.id}, this.parentElement.parentElement.parentElement, event)">
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate" title="${nombre}">${nombre}</p>
                            <p class="text-xs text-gray-500 mb-1">${codigo} - ${p.area || 'S/A'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium px-2 py-0.5 rounded ${getStatusBadgeColor(estado)}">${estado}</span>
                                <span class="text-xs text-gray-400">${monto}</span>
                            </div>
                        </div>
                    </div>
                `;
                DOM.projectListContainer.appendChild(div);
            });
        }

        function getStatusBadgeColor(status) {
            if (status === 'Ejecuci√≥n') return 'bg-green-100 text-green-700';
            if (status === 'Terminado') return 'bg-gray-100 text-gray-700';
            if (status === 'Licitaci√≥n') return 'bg-yellow-100 text-yellow-700';
            if (status === 'Dise√±o') return 'bg-blue-100 text-blue-700';
            return 'bg-gray-100 text-gray-600';
        }

        function toggleSelection(id, cardEl, event) {
            if (AppState.selectedIds.has(id)) {
                AppState.selectedIds.delete(id);
                cardEl.classList.remove('project-card-selected');
                cardEl.querySelector('input').checked = false;
            } else {
                AppState.selectedIds.add(id);
                cardEl.classList.add('project-card-selected');
                cardEl.querySelector('input').checked = true;
            }
            updateContextUI();
        }

        function updateContextUI() {
            const count = AppState.selectedIds.size;
            DOM.selectedCountMsg.textContent = count;
            if (count > 0) DOM.chatContextBadge.classList.remove('hidden');
            else DOM.chatContextBadge.classList.add('hidden');
        }

        function formatCompact(num) {
            if (!num) return '$0';
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumSignificantDigits: 3 }).format(num);
        }



        // --- 3. L√ìGICA DE CHAT (ZhipuAI Integration) ---

        function initChat() {
            // ‚úÖ SOLUCI√ìN: Solo el evento 'submit' del formulario
            DOM.chatForm.addEventListener('submit', sendMessage);

            DOM.chatInput.addEventListener('input', updateCharCounter);
            DOM.voiceButton.addEventListener('click', toggleVoiceRecognition);

            // Inicializar timestamp
            const now = new Date();
            document.getElementById('initial-timestamp').textContent = `Hoy, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            initializeVoiceRecognition();
        }

        function updateCharCounter() {
            const len = DOM.chatInput.value.length;
            DOM.charCounter.textContent = `${len}/${CHAT_CONFIG.MAX_INPUT_LENGTH}`;
            DOM.charCounter.style.color = len > CHAT_CONFIG.MAX_INPUT_LENGTH ? 'red' : 'inherit';
        }

        // --- Voice Recognition ---
        function initializeVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                DOM.voiceButton.hidden = true;
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            AppState.recognition = new SpeechRecognition();
            AppState.recognition.lang = 'es-ES';
            AppState.recognition.continuous = false;
            AppState.recognition.onresult = (event) => {
                DOM.chatInput.value = event.results[0][0].transcript;
                updateCharCounter();
                sendMessage(); // Auto enviar al terminar de hablar
            };
            AppState.recognition.onerror = resetVoiceButton;
            AppState.recognition.onend = resetVoiceButton;
        }

        function resetVoiceButton() {
            DOM.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            DOM.voiceButton.classList.remove('text-red-500', 'animate-pulse');
            DOM.chatInput.placeholder = "Escribe tu pregunta aqu√≠...";
        }

        function toggleVoiceRecognition() {
            if (!AppState.recognition) return;
            if (DOM.voiceButton.innerHTML.includes('fa-stop')) {
                AppState.recognition.stop();
            } else {
                AppState.recognition.start();
                DOM.voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                DOM.voiceButton.classList.add('text-red-500', 'animate-pulse');
                DOM.chatInput.placeholder = "Escuchando...";
            }
        }

        // --- Core Chat Logic ---
        async function sendMessage(e) {
            // ‚úÖ SOLUCI√ìN: Prevenir comportamiento por defecto del formulario
            if (e) e.preventDefault();

            const text = DOM.chatInput.value.trim();
            if (!text) return;

            if (text.length > CHAT_CONFIG.MAX_INPUT_LENGTH) {
                showToast("El mensaje es muy largo.", "error");
                return;
            }

            // UI Updates
            addMessageToChat('user', text);
            DOM.chatInput.value = '';
            DOM.chatInput.disabled = true;
            DOM.typingIndicator.classList.remove('hidden');
            updateCharCounter();
            DOM.messagesArea.scrollTop = DOM.messagesArea.scrollHeight;

            // Preparar Contexto (Proyectos Seleccionados)
            const selectedProjects = AppState.allProjects.filter(p => AppState.selectedIds.has(p.id));
            const contextData = selectedProjects.length > 0
                ? `Contexto de Proyectos Seleccionados (JSON):\n${JSON.stringify(selectedProjects, null, 2)}\n\nAnaliza estos datos para responder.`
                : "No hay proyectos seleccionados actualmente. Responde de forma general o pide al usuario que seleccione proyectos.";

            try {
                const response = await fetchZhipuResponse(text, contextData);
                DOM.typingIndicator.classList.add('hidden');
                addMessageToChat('bot', response.respuesta, response.preguntas);
            } catch (error) {
                console.error(error);
                DOM.typingIndicator.classList.add('hidden');
                showToast("Error al conectar con la IA: " + error.message, "error");
            } finally {
                DOM.chatInput.disabled = false;
                DOM.chatInput.focus();
            }
        }

        async function fetchZhipuResponse(userMessage, systemContext) {
            console.log(AppState.filterProject)
            AppState.chatHistory.push({ role: "user", content: userMessage });

            // Pasar los datos filtrados actuales al contexto
            // 1. Optimizaci√≥n y Pre-ordenamiento de Datos (Mejora #1 y #2)
            const contextProjects = AppState.filterProject
                .sort((a, b) => a.id - b.id) // Ordenar por ID para consistencia
                .map(p => ({
                    id: p.id,
                    nombre: p.nombre,
                    estado: p.estado_proyecto || "Sin Estado",
                    categoria: p.area || "Sin Categor√≠a",
                    financiamiento: p.financiamiento || "N/A",
                    monto: p.monto || 0,
                    avance: (p.porcentaje_avance || 0) + "%"
                }));

            const dataContext = contextProjects.length > 0
                ? JSON.stringify(contextProjects)
                : "No hay proyectos visibles en la lista actual. Si el usuario pregunta generalidades, indica que necesita limpiar filtros.";

            const promptSistema = `Eres un Auditor Municipal experto en Control de Gesti√≥n (SECPLAN).
            Tu objetivo es auditar los datos y entregar respuestas matem√°ticamente exactas y explicaciones estrat√©gicas.

            DATOS DISPONIBLES (Ordenados por ID):
            ${dataContext}

            DICCIONARIO SEM√ÅNTICO Y EMOJIS (Mapeo Inteligente):
            - **Sin√≥nimos (Mapeo Sem√°ntico):**
                * "Calles", "Pavimento", "Bacheo" -> Busca en Categor√≠a 'Vialidad'.
                * "Colegio", "Escuela", "Clases" -> Busca en Categor√≠a 'Educaci√≥n'.
                * "Luz", "Luminarias", "Postes" -> Busca en Categor√≠a 'Energizaci√≥n'.
                * "Agua", "Alcantarillado" -> Busca en Categor√≠a 'Saneamiento'.
                * "Plaza", "Parque", "Sede" -> Busca en Categor√≠a 'Espacios P√∫blicos'.
            - **Indicadores Visuales (Emojis):**
                * üìù Dise√±o
                * üöß En ejecuci√≥n
                * ‚úÖ Ejecutado / Terminado / Recepcionado
                * üì¢ Licitaci√≥n / Bases
                * ‚ö†Ô∏è Subsanaci√≥n / Reevaluaci√≥n / En preparaci√≥n

            EJEMPLOS DE RAZONAMIENTO (FEW-SHOT LEARNING):
            [Caso 1: Conteo Simple]
            Usuario: "¬øCu√°ntos proyectos de agua hay?"
            Tu Pensamiento: "Palabra clave 'agua' -> Mapeo a 'Saneamiento'. Escaneo lista... ID 114 (Saneamiento), ID 115 (Saneamiento). Total = 2."
            Tu Respuesta: "Actualmente constan **2 proyectos** üíß relacionados con Saneamiento..."

            INSTRUCCIONES DE RAZONAMIENTO "SCRATCHPAD" OBLIGATORIO:
            Antes de responder, DEBES realizar un proceso interno de validaci√≥n paso a paso:
            1.  **B√öSQUEDA POR ID:** Si la pregunta incluye un n√∫mero (ej: 114), verifica primero si corresponde a un ID exacto.
            2.  **CONTEO BASADO EN EVIDENCIA:** Si piden "Cu√°ntos...", recorre mentalmente la lista y cuenta los IDs que cumplen la condici√≥n.
                *   ADVERTENCIA: Si no encuentras nada, di expl√≠citamente que hay 0, no inventes.
            3.  **ADAPTABILIDAD:** 
                *   Si el resultado son **menos de 5 proyectos**: Menci√≥nalos uno por uno por su nombre (en *cursiva*) + Emoji de estado.
                *   Si el resultado son **m√°s de 5 proyectos**: Da el total y destaca casos relevantes (ej: el de mayor monto).

            REGLAS DE FORMATO Y ESTILO:
            - **Moneda:** Siempre en Pesos Chilenos con separador de miles y signo peso (ej: **$150.000.000**).
            - **Estilo:** Usa **Negritas** para cifras clave y *Cursivas* para nombres de proyectos. Usa Emojis para dar contexto visual.
            - **Tono:** Profesional, t√©cnico pero claro.

            ESTRUCTURA DE RESPUESTA REQUERIDA:
            
            [RESPUESTA]
            (Tu an√°lisis de auditor√≠a. Incluye respuesta directa y contexto hol√≠stico.)
            [/RESPUESTA]

            [PREGUNTAS]
            (Genera 3 preguntas de seguimiento DIVERSAS):
            1. (Detalle espec√≠fico financiero o de avance)
            2. (Comparativa con otras √°reas o fuentes de financiamiento)
            3. (Estado cr√≠tico o proyectos pr√≥ximos a t√©rmino)
            [/PREGUNTAS]`;

            const requestBody = {
                model: MODEL_NAME,
                messages: [
                    { role: "system", content: promptSistema },
                    ...AppState.chatHistory.slice(-CHAT_CONFIG.MAX_HISTORY_LENGTH)
                ],
                temperature: 0.1
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API ${response.status}: ${errText}`);
            }

            const data = await response.json();
            const rawContent = data.choices[0].message.content;

            // Parsear respuesta
            let respuestaFinal = "";
            let preguntasFinal = [];

            const matchResp = rawContent.match(/\[RESPUESTA\]([\s\S]*?)\[\/RESPUESTA\]/i);
            const matchPreg = rawContent.match(/\[PREGUNTAS\]([\s\S]*?)\[\/PREGUNTAS\]/i);

            if (matchResp) respuestaFinal = matchResp[1].trim();
            else respuestaFinal = rawContent; // Fallback si el modelo no sigue el formato estricto

            if (matchPreg) {
                const lines = matchPreg[1].split('\n').filter(l => l.trim());
                lines.forEach(l => {
                    const m = l.match(/^\d+\.\s*(.+)/);
                    if (m) preguntasFinal.push(m[1].trim());
                });
            }

            if (preguntasFinal.length === 0) preguntasFinal = ["¬øQu√© m√°s puedes decir?", "¬øPuedes resumir?", "Dame m√°s detalles"];

            AppState.chatHistory.push({ role: "assistant", content: respuestaFinal });

            return { respuesta: respuestaFinal, preguntas: preguntasFinal };
        }

        function addMessageToChat(sender, text, preguntas = []) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${sender}`;

            // Avatar
            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            // Contenido
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content markdown-body';

            if (sender === 'user') {
                contentDiv.textContent = text;
            } else {
                // Parsear Markdown
                contentDiv.innerHTML = marked.parse(sanitizeInput(text));

                // Botones de acci√≥n (Copiar / Hablar)
                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2 mt-3 border-t border-gray-200 pt-2 opacity-60 hover:opacity-100 transition';

                const btnCopy = document.createElement('button');
                btnCopy.className = 'text-xs flex items-center gap-1 hover:text-indigo-600';
                btnCopy.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                btnCopy.onclick = () => { navigator.clipboard.writeText(text); showToast("Texto copiado al portapapeles", "success"); };

                const btnSpeak = document.createElement('button');
                btnSpeak.className = 'text-xs flex items-center gap-1 hover:text-indigo-600';
                btnSpeak.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar';
                btnSpeak.onclick = function () { speakText(text, this); };

                actionsDiv.appendChild(btnCopy);
                actionsDiv.appendChild(btnSpeak);
                contentDiv.appendChild(actionsDiv);

                // Chips de Preguntas Sugeridas
                if (preguntas.length > 0) {
                    const chipsContainer = document.createElement('div');
                    chipsContainer.className = 'suggestion-chips';
                    preguntas.forEach(q => {
                        const chip = document.createElement('button');
                        chip.className = 'suggestion-chip';
                        chip.innerHTML = `<i class="fas fa-arrow-right text-xs"></i> ${q}`;
                        chip.onclick = () => {
                            DOM.chatInput.value = q;
                            // Aqu√≠ llamamos sendMessage() sin evento (null), lo cual es seguro por el chequeo `if (e)`
                            sendMessage();
                        };
                        chipsContainer.appendChild(chip);
                    });
                    contentDiv.appendChild(chipsContainer);
                }
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(contentDiv);

            DOM.messagesArea.appendChild(wrapper);
            DOM.messagesArea.scrollTop = DOM.messagesArea.scrollHeight;
        }

        // --- Utilidades ---

        function sanitizeInput(text) {
            return text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '').replace(/javascript:/gi, '');
        }

        function speakText(text, btn) {
            if (!AppState.synthesis) return;
            if (AppState.synthesis.speaking) {
                AppState.synthesis.cancel();
                btn.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar';
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.onend = () => { btn.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar'; };
            AppState.synthesis.speak(utterance);
            btn.innerHTML = '<i class="fas fa-stop"></i> Detener';
        }

        function clearChat() {
            if (!confirm("¬øEst√°s seguro de que quieres borrar todo el historial del chat?")) return;
            // Mensaje de bienvenida
            DOM.messagesArea.innerHTML = `
                <div class="message-wrapper bot">
                    <div class="avatar"><i class="fas fa-robot"></i></div>
                    <div class="flex-1">
                        <div class="message-content markdown-body">
                            <p><strong>¬°Hola! Soy tu asistente potenciado por ZhipuAI.</strong></p>
                            <p>El chat ha sido reiniciado. Selecciona proyectos y comienza de nuevo.</p>
                        </div>
                        <div class="message-meta text-gray-500">Hoy, ${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            AppState.chatHistory = [];
        }

        function exportConversation() {
            let txt = "Conversaci√≥n Exportada - Asistente Geoportal\n\n";
            DOM.messagesArea.querySelectorAll('.message-wrapper').forEach(wrapper => {
                const isBot = wrapper.classList.contains('bot');
                const role = isBot ? "IA:" : "T√∫:";
                // Solo extraer texto, limpiar un poco
                const content = wrapper.querySelector('.message-content').innerText;
                txt += `${role}\n${content}\n\n`;
            });

            const blob = new Blob([txt], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `chat-geoportal-${Date.now()}.txt`;
            a.click();
            showToast("Conversaci√≥n exportada correctamente", "success");
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';

            let icon = '<i class="fas fa-info-circle"></i>';
            if (type === 'success') icon = '<i class="fas fa-check-circle text-green-400"></i>';
            if (type === 'error') icon = '<i class="fas fa-exclamation-triangle text-red-400"></i>';

            toast.innerHTML = `${icon} <span>${message}</span>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        // --- Inicializaci√≥n Global ---
        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            initChat();
        });

    </script>
    <script src="../../../script/layout.js"></script>
</body>

</html>