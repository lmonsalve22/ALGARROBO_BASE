<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario - Geoportal Municipal</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
    <link rel="stylesheet" href="styles/admin-styles.css">
    <style>
        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --purple: #8b5cf6;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 1;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            transform: scale(0.95);
            transition: transform 0.3s ease;
        }

        .modal.show .modal-content {
            transform: scale(1);
        }

        .fc-event {
            cursor: pointer;
            border: none !important;
            border-radius: 6px !important;
            padding: 3px 8px !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.1s ease;
        }

        .fc-event:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .loading-overlay {
            position: absolute;
            inset: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            border-radius: 0.5rem;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid #e5e7eb;
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* FullCalendar Customization */
        .fc-toolbar-title {
            font-size: 1.5rem !important;
            font-weight: 700;
            color: #1f2937;
        }

        .fc-button {
            border-radius: 0.5rem !important;
            font-weight: 500;
            text-transform: capitalize;
        }

        .fc-button-primary {
            background-color: var(--primary) !important;
            border-color: var(--primary) !important;
        }

        .fc-button-primary:hover {
            background-color: var(--primary-dark) !important;
            border-color: var(--primary-dark) !important;
        }

        .fc-daygrid-day-number {
            font-weight: 600;
            color: #4b5563;
        }

        .fc-col-header-cell-cushion {
            font-weight: 600;
            text-transform: uppercase;
            color: #6b7280;
            font-size: 0.875rem;
            padding-top: 1rem;
            padding-bottom: 1rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800">
    <div id="headerRender"></div>
    <div class="flex min-h-screen">
        <aside id="asideRender" class="w-64 bg-white shadow-xl hidden md:block z-10"></aside>
        <main class="flex-1 p-6 overflow-x-hidden">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800 tracking-tight">Calendario Municipal</h2>
                <p class="text-gray-500 mt-1">Gestión integral de eventos, hitos y actividades</p>
            </div>

            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-8">
                <div class="flex flex-wrap justify-between items-center gap-4">
                    <div class="flex flex-wrap gap-3">
                        <button id="btnNuevoEvento"
                            class="px-5 py-2.5 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition shadow-lg shadow-blue-500/30 flex items-center gap-2 font-medium">
                            <i class="fas fa-plus"></i> Nuevo Evento
                        </button>
                        <button id="btnSincronizar"
                            class="px-5 py-2.5 bg-emerald-600 text-white rounded-xl hover:bg-emerald-700 transition shadow-lg shadow-emerald-500/30 flex items-center gap-2 font-medium">
                            <i class="fas fa-sync-alt"></i> Sincronizar
                        </button>
                    </div>
                    <div id="legendContainer" class="flex items-center gap-4 flex-wrap text-sm">
                        <!-- Leyenda generada dinámicamente -->
                    </div>
                </div>
            </div>

            <!-- Filters Section -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-5 mb-6">
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="md:col-span-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Buscar Proyecto</label>
                        <div class="relative">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            <input type="text" id="filterSearch" placeholder="Nombre, código o sector..."
                                class="w-full pl-9 pr-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Área</label>
                        <select id="filterAreaCalendar"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            <option value="">Todas las áreas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Estado Proyecto</label>
                        <select id="filterStatus"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            <option value="">Todos</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button id="btnClearFilters"
                            class="w-full py-2 bg-gray-100 text-gray-600 rounded-lg hover:bg-gray-200 transition text-sm font-medium">
                            <i class="fas fa-eraser mr-2"></i> Limpiar Filtros
                        </button>
                    </div>
                </div>
            </div>

            <!-- Calendario Full Width -->
            <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 relative">
                <div id="calendarLoading" class="loading-overlay hidden">
                    <div class="spinner"></div>
                </div>
                <!-- Altura mínima para asegurar que se vea bien -->
                <div id="calendar" class="min-h-[700px]"></div>
            </div>
        </main>
    </div>

    <!-- Modal Nuevo/Editar -->
    <div id="eventModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h3 id="modalTitle" class="text-xl font-bold text-gray-800">Nuevo Evento</h3>
                <button id="closeModalBtn"
                    class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">&times;</button>
            </div>
            <form id="eventForm" class="p-6">
                <div class="mb-5">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Título del Evento *</label>
                    <input type="text" id="eventTitle" required
                        class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm">
                </div>
                <div class="mb-5">
                    <label class="block text-gray-700 text-sm font-bold mb-2">Descripción</label>
                    <textarea id="eventDescription" rows="3"
                        class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-blue-500 focus:border-blue-500 outline-none transition shadow-sm"></textarea>
                </div>
                <div class="grid grid-cols-2 gap-5 mb-5">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Fecha Inicio *</label>
                        <input type="date" id="eventStartDate" required
                            class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Fecha Término</label>
                        <input type="date" id="eventEndDate"
                            class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="grid grid-cols-2 gap-5 mb-6">
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Área</label>
                        <select id="eventArea"
                            class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none bg-white">
                            <option value="Vialidad">Vialidad</option>
                            <option value="Saneamiento">Saneamiento</option>
                            <option value="Espacios Públicos">Espacios Públicos</option>
                            <option value="Educación">Educación</option>
                            <option value="Salud">Salud</option>
                            <option value="Municipal" selected>Municipal</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-gray-700 text-sm font-bold mb-2">Ubicación</label>
                        <input type="text" id="eventLocation"
                            class="w-full border border-gray-300 rounded-xl px-4 py-2.5 focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
                <div class="flex justify-between items-center pt-6 border-t border-gray-100">
                    <div id="deleteEventContainer" class="hidden">
                        <button type="button" id="btnDeleteEvent"
                            class="px-4 py-2 bg-red-50 text-red-600 rounded-xl hover:bg-red-100 transition font-medium border border-red-200">
                            <i class="fas fa-trash-alt mr-2"></i>Eliminar
                        </button>
                    </div>
                    <div class="flex gap-3 ml-auto">
                        <button type="button" id="btnCancelModal"
                            class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition font-medium">Cancelar</button>
                        <button type="submit"
                            class="px-6 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-medium shadow-lg shadow-blue-500/30">
                            <i class="fas fa-save mr-2"></i>Guardar
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalle -->
    <div id="detailModal" class="modal">
        <div class="modal-content">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-xl font-bold text-gray-800">Detalle del Evento</h3>
                <button id="closeDetailModalBtn"
                    class="text-gray-400 hover:text-gray-600 text-2xl w-8 h-8 flex items-center justify-center rounded-full hover:bg-gray-200 transition">&times;</button>
            </div>
            <div class="p-6">
                <div class="mb-5">
                    <h4 id="detailTitle" class="text-2xl font-bold text-gray-900 leading-tight"></h4>
                </div>

                <div id="detailProjectInfo" class="mb-5 p-4 bg-blue-50 rounded-xl border border-blue-100 hidden">
                    <div class="flex items-center gap-2 text-blue-700 mb-2">
                        <i class="fas fa-project-diagram"></i>
                        <span class="font-bold text-sm uppercase tracking-wide">Proyecto Asociado</span>
                    </div>
                    <p id="detailProjectName" class="text-gray-800 font-semibold"></p>
                    <p class="text-xs text-blue-600 mt-2 italic flex items-center gap-1">
                        <i class="fas fa-info-circle"></i>
                        Este evento es gestionado automÃ¡ticamente por el proyecto.
                    </p>
                </div>

                <div class="grid grid-cols-2 gap-4 mb-5">
                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Inicio</p>
                        <p id="detailStartDate" class="text-gray-800 font-medium"></p>
                    </div>
                    <div class="p-4 bg-gray-50 rounded-xl border border-gray-100">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-1 tracking-wider">Término</p>
                        <p id="detailEndDate" class="text-gray-800 font-medium"></p>
                    </div>
                </div>

                <div class="mb-5 flex flex-wrap gap-4">
                    <div>
                        <p class="text-xs text-gray-500 uppercase font-bold mb-2 tracking-wider">Área</p>
                        <span id="detailArea"
                            class="inline-block px-4 py-1.5 rounded-full text-sm font-bold bg-blue-100 text-blue-800"></span>
                    </div>
                    <div id="detailLocationContainer" class="hidden">
                        <p class="text-xs text-gray-500 uppercase font-bold mb-2 tracking-wider">Ubicación</p>
                        <p id="detailLocation"
                            class="text-gray-800 flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-lg border border-gray-200">
                            <i class="fas fa-map-marker-alt text-gray-400"></i>
                            <span></span>
                        </p>
                    </div>
                </div>

                <div id="detailDescriptionContainer" class="mb-5 hidden">
                    <p class="text-xs text-gray-500 uppercase font-bold mb-2 tracking-wider">Descripción</p>
                    <div class="bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <p id="detailDescription" class="text-gray-700 leading-relaxed"></p>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                <button onclick="document.getElementById('detailModal').classList.remove('show')"
                    class="px-5 py-2 bg-white border border-gray-300 text-gray-700 rounded-xl hover:bg-gray-50 transition font-medium">
                    Cerrar
                </button>
                <div id="editButtonContainer">
                    <button id="btnEditFromDetail"
                        class="px-5 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 transition font-medium flex items-center gap-2 shadow-lg shadow-blue-500/30">
                        <i class="fas fa-edit"></i> Editar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="../../../script/api.js"></script>
    <script src="../../../script/layout.js"></script>
    <script src="../../../script/help.js"></script>
    <script>document.addEventListener('DOMContentLoaded', () => createHelpButton('calendario'));</script>
    <script src="../../../script/utils.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/es.js"></script>
    <script>
        var CalendarioApp = {
            calendar: null,
            currentEventId: null,
            currentEvent: null,
            eventsData: [],
            areaColors: {
                'Vialidad': '#3B82F6',
                'Saneamiento': '#10B981',
                'Espacios Públicos': '#F59E0B',
                'Educación': '#8B5CF6',
                'Salud': '#EF4444',
                'Municipal': '#6B7280'
            }
        };

        // Initialize
        document.addEventListener('DOMContentLoaded', function () {
            initCalendar();
            initEvents();
            loadAreas(); // Load areas first
            loadEvents();
        });

        // Dynamic Areas Management
        var availableAreas = [];

        function loadAreas() {
            if (typeof api === 'undefined') return;

            api.get('/areas')
                .then(function (areas) {
                    if (Array.isArray(areas)) {
                        availableAreas = areas.filter(a => a.activo);
                        populateAreaSelect(availableAreas);
                        populateFilterAreaSelect(availableAreas);
                        renderLegend(availableAreas);
                    }
                })
                .catch(function (err) {
                    console.error('Error loading areas:', err);
                    var fallback = [
                        { nombre: 'Municipal' },
                        { nombre: 'Vialidad' },
                        { nombre: 'Saneamiento' }
                    ];
                    populateAreaSelect(fallback);
                    populateFilterAreaSelect(fallback);
                });
        }

        function populateAreaSelect(areas) {
            var select = document.getElementById('eventArea');
            select.innerHTML = ''; // Clear existing

            areas.forEach(function (area) {
                var option = document.createElement('option');
                option.value = area.nombre;
                option.textContent = area.nombre;
                select.appendChild(option);
            });

            // Add "Municipal" if not present as a fallback default
            if (!areas.some(a => a.nombre === 'Municipal')) {
                var mun = document.createElement('option');
                mun.value = 'Municipal';
                mun.textContent = 'Municipal';
                select.appendChild(mun);
            }
        }

        function populateFilterAreaSelect(areas) {
            var select = document.getElementById('filterAreaCalendar');
            if (!select) return;
            select.innerHTML = '<option value="">Todas las áreas</option>';

            areas.forEach(function (area) {
                var option = document.createElement('option');
                option.value = area.nombre;
                option.textContent = area.nombre;
                select.appendChild(option);
            });
        }

        function renderLegend(areas) {
            var container = document.getElementById('legendContainer');
            if (!container) return;
            container.innerHTML = '';

            // Ensure unique names
            var uniqueNames = [];
            var seen = new Set();
            areas.forEach(function (a) {
                if (!seen.has(a.nombre)) {
                    seen.add(a.nombre);
                    uniqueNames.push(a.nombre);
                }
            });
            uniqueNames.sort();

            uniqueNames.forEach(function (name) {
                var color = getAreaHexColor(name);

                var div = document.createElement('div');
                div.className = 'flex items-center gap-2 px-3 py-1 rounded-full border border-gray-100 bg-white shadow-sm';
                div.innerHTML = `<span class="w-3 h-3 rounded-full" style="background-color: ${color};"></span>${name}`;
                container.appendChild(div);
            });
        }

        // Helper to get color for any area name
        function getAreaColor(areaName) {
            if (!areaName) return 'bg-gray-100 text-gray-800';

            // Predefined map for common ones
            var map = {
                'Vialidad': 'bg-blue-100 text-blue-800',
                'Saneamiento': 'bg-green-100 text-green-800',
                'Espacios Públicos': 'bg-amber-100 text-amber-800',
                'Educación': 'bg-purple-100 text-purple-800',
                'Salud': 'bg-red-100 text-red-800',
                'Municipal': 'bg-gray-100 text-gray-800',
                'Hito de Proyecto': 'bg-indigo-100 text-indigo-800',
                'Observación': 'bg-orange-100 text-orange-800',
                'General': 'bg-gray-100 text-gray-800'
            };

            if (map[areaName]) return map[areaName];

            // Dynamic color generation for unknown areas
            var colors = [
                'bg-teal-100 text-teal-800',
                'bg-cyan-100 text-cyan-800',
                'bg-pink-100 text-pink-800',
                'bg-rose-100 text-rose-800',
                'bg-fuchsia-100 text-fuchsia-800',
                'bg-lime-100 text-lime-800'
            ];

            // Simple hash
            var hash = 0;
            for (var i = 0; i < areaName.length; i++) {
                hash = areaName.charCodeAt(i) + ((hash << 5) - hash);
            }
            var index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        function getAreaHexColor(areaName) {
            // Mapping for FullCalendar dots/backgrounds
            var map = {
                'Vialidad': '#3B82F6',
                'Saneamiento': '#10B981',
                'Espacios Públicos': '#F59E0B',
                'Educación': '#8B5CF6',
                'Salud': '#EF4444',
                'Municipal': '#6B7280',
                'Hito de Proyecto': '#6366f1',
                'Observación': '#f97316'
            };
            if (map[areaName]) return map[areaName];

            // Generate hex color
            var hash = 0;
            for (var i = 0; i < areaName.length; i++) {
                hash = areaName.charCodeAt(i) + ((hash << 5) - hash);
            }
            var c = (hash & 0x00FFFFFF).toString(16).toUpperCase();
            return '#' + '00000'.substring(0, 6 - c.length) + c;
        }

        function initCalendar() {
            var calendarEl = document.getElementById('calendar');
            CalendarioApp.calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'dayGridMonth',
                locale: 'es',
                height: 750, // Fixed height for consistency
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,listWeek'
                },
                buttonText: {
                    today: 'Hoy',
                    month: 'Mes',
                    week: 'Semana',
                    list: 'Agenda'
                },
                selectable: true,
                editable: false,
                dayMaxEvents: true,
                navLinks: true,
                // FORCE Custom Content Rendering
                eventContent: function (arg) {
                    var props = arg.event.extendedProps || {};
                    var displayText = props.proyecto_nombre || arg.event.title;

                    // Return a DOM structure that mimics standard FC but with our text
                    // We generate HTML to ensure styles like italic or bold can be applied if needed
                    return { html: '<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title fc-sticky">' + displayText + '</div></div></div>' };
                },
                eventClick: function (info) {
                    info.jsEvent.preventDefault();
                    showEventDetails(info.event);
                },
                dateClick: function (info) {
                    openModalForDate(info.dateStr);
                }
            });
            CalendarioApp.calendar.render();
        }

        function initEvents() {
            // New Event Button
            document.getElementById('btnNuevoEvento').addEventListener('click', function () {
                openModalForNewEvent();
            });
            // Sync Button
            document.getElementById('btnSincronizar').addEventListener('click', function () {
                loadEvents();
            });

            // Edit Modal Controls
            document.getElementById('closeModalBtn').addEventListener('click', closeModal);
            document.getElementById('btnCancelModal').addEventListener('click', closeModal);
            document.getElementById('eventModal').addEventListener('click', function (e) {
                if (e.target === this) closeModal();
            });
            document.getElementById('eventForm').addEventListener('submit', function (e) {
                e.preventDefault();
                saveEvent();
            });
            document.getElementById('btnDeleteEvent').addEventListener('click', deleteEvent);

            // Detail Modal Controls
            document.getElementById('closeDetailModalBtn').addEventListener('click', closeDetailModal);
            document.getElementById('detailModal').addEventListener('click', function (e) {
                if (e.target === this) closeDetailModal();
            });
            document.getElementById('btnEditFromDetail').addEventListener('click', editFromDetail);

            // Filter Controls
            var fSearch = document.getElementById('filterSearch');
            if (fSearch) fSearch.addEventListener('input', applyCalendarFilters);

            var fArea = document.getElementById('filterAreaCalendar');
            if (fArea) fArea.addEventListener('change', applyCalendarFilters);

            var fStatus = document.getElementById('filterStatus');
            if (fStatus) fStatus.addEventListener('change', applyCalendarFilters);

            var fClear = document.getElementById('btnClearFilters');
            if (fClear) fClear.addEventListener('click', clearCalendarFilters);
        }

        function clearCalendarFilters() {
            document.getElementById('filterSearch').value = '';
            document.getElementById('filterAreaCalendar').value = '';
            document.getElementById('filterStatus').value = '';
            applyCalendarFilters();
        }

        function applyCalendarFilters() {
            var searchTerm = document.getElementById('filterSearch').value.toLowerCase();
            var area = document.getElementById('filterAreaCalendar').value;
            var status = document.getElementById('filterStatus').value;

            // Filter the source data
            var filtered = CalendarioApp.eventsData.filter(function (evt) {
                var props = evt.extendedProps;

                // 1. Search (Name, Code, Sector)
                var textMatch = true;
                if (searchTerm) {
                    var pName = (props.proyecto_nombre || '').toLowerCase();
                    var eTitle = (props.original_title || evt.title || '').toLowerCase();
                    var sector = (props.sector_nombre || '').toLowerCase();
                    var code = (props.proyecto_id ? String(props.proyecto_id) : ''); // Code fallback to ID or future field

                    textMatch = pName.includes(searchTerm) || eTitle.includes(searchTerm) || sector.includes(searchTerm) || code.includes(searchTerm);
                }

                // 2. Area
                var areaMatch = true;
                if (area) {
                    areaMatch = (props.area === area);
                }

                // 3. Status
                var statusMatch = true;
                if (status) {
                    var s = (props.estado_proyecto || '').toLowerCase();
                    statusMatch = s === status.toLowerCase();
                }

                return textMatch && areaMatch && statusMatch;
            });

            refreshCalendar(filtered);
        }

        function populateStatusFilter(events) {
            var select = document.getElementById('filterStatus');
            if (!select) return;
            var current = select.value;
            // Get unique statuses
            var statuses = new Set();
            events.forEach(function (evt) {
                if (evt.extendedProps && evt.extendedProps.estado_proyecto) {
                    statuses.add(evt.extendedProps.estado_proyecto);
                }
            });

            select.innerHTML = '<option value="">Todos</option>';
            Array.from(statuses).sort().forEach(function (st) {
                var opt = document.createElement('option');
                opt.value = st;
                opt.textContent = st;
                select.appendChild(opt);
            });
            select.value = current;
        }

        // Helper to safe parse API date to YYYY-MM-DD string to avoid timezone shifts
        function safeDateString(dateStr) {
            if (!dateStr) return null;
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return null;
            // Use UTC components to get the exact date sent by server
            var year = d.getUTCFullYear();
            var month = String(d.getUTCMonth() + 1).padStart(2, '0');
            var day = String(d.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function loadEvents() {
            showLoading(true);

            if (typeof api === 'undefined') {
                showLoading(false);
                showToastMessage('Error: Librería API no cargada', 'error');
                return;
            }

            api.get('/calendario_eventos_detalle')
                .then(function (events) {
                    if (!events || !Array.isArray(events)) {
                        showToastMessage('Respuesta inválida del servidor', 'error');
                        return;
                    }

                    CalendarioApp.eventsData = events.map(function (evt) {
                        var areaNombre = evt.area_nombre || evt.origen_tipo || 'Municipal';

                        // FIX: Use safe date string YYYY-MM-DD
                        var start = safeDateString(evt.fecha_inicio);
                        var end = safeDateString(evt.fecha_termino);

                        // Use dynamic color helper
                        var color = getAreaHexColor(areaNombre);

                        // TITLE LOGIC: Use Project Name if available, otherwise Event Title
                        var displayTitle = evt.proyecto_nombre || evt.titulo || '(Sin Título)';

                        return {
                            id: evt.calendario_id,
                            title: displayTitle,
                            start: start,
                            end: end,
                            allDay: true, // Force all day for YYYY-MM-DD strings
                            backgroundColor: color,
                            borderColor: color,
                            extendedProps: {
                                area: areaNombre,
                                description: evt.descripcion || '',
                                proyecto_id: evt.proyecto_id,
                                proyecto_nombre: evt.proyecto_nombre,
                                original_title: evt.titulo,
                                ubicacion: evt.ubicacion || '',
                                financing: evt.financiamiento_nombre || '',
                                estado_proyecto: evt.estado_proyecto,
                                sector_nombre: evt.sector_nombre
                            }
                        };
                    });

                    // Populate status filter dynamically based on data
                    populateStatusFilter(CalendarioApp.eventsData);

                    // Apply filters (which renders calendar)
                    applyCalendarFilters();

                    if (CalendarioApp.eventsData.length > 0) {
                        console.log('Eventos cargados:', CalendarioApp.eventsData.length);
                    } else {
                        showToastMessage('No hay eventos registrados en la base de datos', 'info');
                    }
                })
                .catch(function (error) {
                    console.error('Error cargando eventos:', error);
                    var msg = 'Error de conexión: ' + (error.message || 'Error desconocido');
                    if (error.message && error.message.includes('500')) {
                        msg = 'Error del Servidor (500). Contacte al administrador.';
                    }
                    showToastMessage(msg, 'error');
                })
                .finally(function () {
                    showLoading(false);
                });
        }

        function loadSampleData() {
            var today = new Date().toISOString().split('T')[0];
            CalendarioApp.eventsData = [
                {
                    id: 1,
                    title: 'Evento de ejemplo',
                    start: today,
                    backgroundColor: '#3B82F6',
                    extendedProps: { area: 'Municipal', description: 'Descripción de prueba' }
                }
            ];
            refreshCalendar();
            showLoading(false);
        }

        function refreshCalendar(eventsToList) {
            var data = eventsToList || CalendarioApp.eventsData;

            if (CalendarioApp.calendar) {
                CalendarioApp.calendar.removeAllEvents();
                CalendarioApp.calendar.addEventSource(data);
            }
        }

        function openModalForNewEvent() {
            var today = new Date().toISOString().split('T')[0];
            openModalForDate(today);
        }

        function openModalForDate(date) {
            document.getElementById('eventForm').reset();
            document.getElementById('modalTitle').textContent = 'Nuevo Evento';
            document.getElementById('eventStartDate').value = date;
            document.getElementById('eventEndDate').value = date;

            // Set default area if available in the select, otherwise Municipal
            var areaSelect = document.getElementById('eventArea');
            if (areaSelect.options.length > 0) {
                areaSelect.selectedIndex = 0;
            } else {
                // Should ideally wait for areas to load, but fallback just in case
            }

            CalendarioApp.currentEventId = null;
            document.getElementById('deleteEventContainer').classList.add('hidden');
            showModal();
        }

        function showEventDetails(event) {
            var props = event.extendedProps || {};
            CalendarioApp.currentEventId = event.id;
            CalendarioApp.currentEvent = event;

            var mainTitle = event.title;
            var subTitle = props.original_title || event.title; // Default to title if no original
            var isProjectEvent = false;

            if (props.proyecto_nombre) {
                // If it has a project, the mainTitle IS ALREADY project_name (set in loadEvents)
                // We want the subtitle to be the Hito name (original_title)
                subTitle = props.original_title;
                isProjectEvent = true;
            } else {
                // Formatting for non-project events
                subTitle = "Evento General";
            }

            document.getElementById('detailTitle').textContent = mainTitle;

            // Project Info Box
            var projectInfo = document.getElementById('detailProjectInfo');
            var editBtn = document.getElementById('btnEditFromDetail');

            var infoLabelIcon = projectInfo.querySelector('.flex span');
            if (infoLabelIcon) infoLabelIcon.textContent = isProjectEvent ? "Hito / Evento" : "Tipo";

            if (isProjectEvent) {
                // IT IS A PROJECT EVENT
                document.getElementById('detailProjectName').textContent = subTitle;
                projectInfo.classList.remove('hidden');
                editBtn.classList.add('hidden');
            } else if (props.proyecto_id) {
                // Fallback
                document.getElementById('detailProjectName').textContent = 'Proyecto #' + props.proyecto_id;
                projectInfo.classList.remove('hidden');
                editBtn.classList.add('hidden');
            } else {
                // Normal event
                projectInfo.classList.add('hidden');
                editBtn.classList.remove('hidden');
            }

            // Dates
            var dStart = event.start; // FullCalendar Date Object
            // If it's pure string YYYY-MM-DD, FullCalendar parses it to Date with 00:00 local usually, or UTC depending on config.
            // With allDay:true, it's safer.

            if (!dStart && props.start) dStart = new Date(props.start);

            var options = { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', timeZone: 'UTC' };
            // Using timeZone UTC to display exactly what we parsed

            if (dStart) {
                document.getElementById('detailStartDate').textContent = dStart.toLocaleDateString('es-CL', options);
            }
            // End Date logic...
            if (event.end) {
                document.getElementById('detailEndDate').textContent = event.end.toLocaleDateString('es-CL', options);
            } else {
                document.getElementById('detailEndDate').textContent = document.getElementById('detailStartDate').textContent;
            }

            // Area
            var area = props.area;
            // Map generic types to readable names
            if (area === 'proyectos_hitos') area = 'Hito de Proyecto';
            if (area === 'proyectos_observaciones') area = 'Observación';
            if (!area) area = 'General';

            var areaEl = document.getElementById('detailArea');
            areaEl.textContent = area;
            // Use dynamic color helper
            var badgeClass = getAreaColor(area);
            areaEl.className = 'inline-block px-4 py-1.5 rounded-full text-sm font-bold ' + badgeClass;

            // Description
            var descContainer = document.getElementById('detailDescriptionContainer');
            if (props.description) {
                document.getElementById('detailDescription').textContent = props.description;
                descContainer.classList.remove('hidden');
            } else {
                descContainer.classList.add('hidden');
            }

            // Location
            var locContainer = document.getElementById('detailLocationContainer');
            if (props.ubicacion) {
                document.getElementById('detailLocation').querySelector('span').textContent = props.ubicacion;
                locContainer.classList.remove('hidden');
            } else {
                locContainer.classList.add('hidden');
            }

            document.getElementById('detailModal').classList.add('show');
        }

        function closeDetailModal() {
            document.getElementById('detailModal').classList.remove('show');
        }

        function editFromDetail() {
            // Security check
            var event = CalendarioApp.currentEvent;
            if (!event) return;
            var props = event.extendedProps || {};
            if (props.proyecto_nombre || props.proyecto_id) {
                showToastMessage('Los eventos de proyectos no se pueden editar aquí', 'warning');
                return;
            }

            closeDetailModal();

            document.getElementById('modalTitle').textContent = 'Editar Evento';
            document.getElementById('eventTitle').value = event.title;
            document.getElementById('eventDescription').value = props.description || '';

            var startStr = event.start instanceof Date ? event.start.toISOString().split('T')[0] : event.start.toString().split('T')[0];
            var endStr = event.end ? (event.end instanceof Date ? event.end.toISOString().split('T')[0] : event.end.toString().split('T')[0]) : startStr;

            document.getElementById('eventStartDate').value = startStr;
            document.getElementById('eventEndDate').value = endStr;
            document.getElementById('eventArea').value = props.area || 'Municipal';
            document.getElementById('eventLocation').value = props.ubicacion || '';

            document.getElementById('deleteEventContainer').classList.remove('hidden');
            showModal();
        }

        function showModal() {
            document.getElementById('eventModal').classList.add('show');
            document.getElementById('eventTitle').focus();
        }

        function closeModal() {
            document.getElementById('eventModal').classList.remove('show');
        }

        function saveEvent() {
            var title = document.getElementById('eventTitle').value.trim();
            var description = document.getElementById('eventDescription').value.trim();
            var startDate = document.getElementById('eventStartDate').value;
            var endDate = document.getElementById('eventEndDate').value || startDate;
            var area = document.getElementById('eventArea').value;
            var location = document.getElementById('eventLocation').value.trim();

            if (!title || !startDate) {
                showToastMessage('Título y fecha son obligatorios', 'error');
                return;
            }

            var payload = {
                titulo: title,
                descripcion: description,
                fecha_inicio: startDate,
                fecha_termino: endDate,
                origen_tipo: area,
                ubicacion: location,
                todo_el_dia: true
            };

            if (typeof api === 'undefined') {
                showToastMessage('API no disponible (Modo Demo)', 'warning');
                return;
            }

            var promise;
            if (CalendarioApp.currentEventId) {
                promise = api.put('/calendario_eventos/' + CalendarioApp.currentEventId, payload);
            } else {
                promise = api.post('/calendario_eventos', payload);
            }

            promise
                .then(function () {
                    showToastMessage(CalendarioApp.currentEventId ? 'Evento actualizado' : 'Evento creado', 'success');
                    closeModal();
                    loadEvents();
                })
                .catch(function (error) {
                    console.error('Error guardando evento:', error);
                    showToastMessage('Error al guardar el evento', 'error');
                });
        }

        function deleteEvent() {
            if (!CalendarioApp.currentEventId) return;
            if (!confirm('¿Está seguro de eliminar este evento?')) return;

            if (typeof api !== 'undefined') {
                api.delete('/calendario_eventos/' + CalendarioApp.currentEventId)
                    .then(function () {
                        showToastMessage('Evento eliminado', 'success');
                        closeModal();
                        loadEvents();
                    })
                    .catch(function (error) {
                        console.error('Error eliminando evento:', error);
                        showToastMessage('Error al eliminar', 'error');
                    });
            }
        }

        function showLoading(show) {
            var loader = document.getElementById('calendarLoading');
            if (loader) {
                if (show) loader.classList.remove('hidden');
                else loader.classList.add('hidden');
            }
        }

        function showToastMessage(message, type) {
            if (typeof showToast === 'function') {
                showToast(message, type);
                return;
            }
            console.log('[' + (type || 'info').toUpperCase() + '] ' + message);
        }
    </script>
</body>

</html>