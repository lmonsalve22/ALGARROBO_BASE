<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <script src="../../../script/api.js"></script>
    <script src="../../../script/utils.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente Inteligente Geoportal - ZhipuAI Integration</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Marked.js para Markdown -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- Unified Admin Styles -->
    <link rel="stylesheet" href="styles/admin-styles.css">

    <style>
        /* --- Estilos Generales --- */
        body {
            font-family: 'Inter', system-ui, -apple-system, sans-serif;
        }

        /* Scrollbar personalizada */
        .custom-scroll::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        .custom-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        .custom-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        /* --- Estilos Chat --- */
        .chat-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            background-color: #fff;
            border-radius: 0.5rem;
            border: 1px solid #e2e8f0;
            overflow: hidden;
        }

        .messages-area {
            flex-grow: 1;
            overflow-y: auto;
            padding: 1.5rem;
            scroll-behavior: smooth;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message-wrapper {
            display: flex;
            gap: 1rem;
            max-width: 90%;
            animation: fadeIn 0.3s ease-out;
        }

        .message-wrapper.user {
            flex-direction: row-reverse;
            margin-left: auto;
        }

        .message-content {
            padding: 1rem;
            border-radius: 1rem;
            font-size: 0.95rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .message-wrapper.bot .message-content {
            background-color: #f8fafc;
            color: #334155;
            border: 1px solid #e2e8f0;
            border-bottom-left-radius: 0.25rem;
        }

        .message-wrapper.user .message-content {
            background-color: #4f46e5;
            /* Indigo 600 */
            color: white;
            border-bottom-right-radius: 0.25rem;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3);
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            font-size: 0.9rem;
        }

        .bot .avatar {
            background-color: #e0e7ff;
            color: #4338ca;
        }

        .user .avatar {
            background-color: #c7d2fe;
            color: #312e81;
        }

        .message-meta {
            font-size: 0.75rem;
            margin-top: 0.5rem;
            opacity: 0.7;
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .bot .message-meta {
            justify-content: flex-start;
        }

        .user .message-meta {
            justify-content: flex-end;
        }

        /* Markdown Styles dentro del Chat */
        .markdown-body h1,
        .markdown-body h2,
        .markdown-body h3 {
            font-weight: 700;
            margin-top: 1em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
        }

        .markdown-body ul,
        .markdown-body ol {
            padding-left: 1.5em;
            margin-bottom: 0.5em;
        }

        .markdown-body p {
            margin-bottom: 0.5em;
        }

        .markdown-body code {
            background-color: rgba(0, 0, 0, 0.1);
            padding: 0.1em 0.3em;
            border-radius: 0.2rem;
            font-family: monospace;
        }

        .user .markdown-body code {
            background-color: rgba(255, 255, 255, 0.2);
        }

        .markdown-body pre {
            background-color: #1e293b;
            color: #f1f5f9;
            padding: 0.75rem;
            border-radius: 0.5rem;
            overflow-x: auto;
            margin: 0.5rem 0;
        }

        .markdown-body pre code {
            background-color: transparent;
            color: inherit;
            padding: 0;
        }

        /* Sugerencias */
        .suggestion-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-top: 0.75rem;
        }

        .suggestion-chip {
            background-color: white;
            border: 1px solid #cbd5e1;
            color: #475569;
            padding: 0.4rem 0.8rem;
            border-radius: 999px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.4rem;
        }

        .suggestion-chip:hover {
            background-color: #f1f5f9;
            border-color: #94a3b8;
            transform: translateY(-1px);
        }

        /* Animaciones */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Proyecto Lista */
        .project-card-selected {
            background-color: #eff6ff !important;
            border-color: #4f46e5 !important;
        }

        /* Toast Notification */
        #toast-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .toast {
            background: #1e293b;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            font-size: 0.9rem;
            animation: slideIn 0.3s ease-out;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Loading Dots */
        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out both;
            margin: 0 2px;
        }

        .typing-indicator span:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes typing {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            border-radius: 0.5rem;
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-800 font-sans h-screen flex flex-col overflow-hidden">

    <!-- Header inyectado por layout.js -->
    <div id="headerRender"></div>

    <div class="flex flex-1 overflow-hidden">
        <!-- Aside/Sidebar inyectado por layout.js -->
        <div id="asideRender"></div>

        <!-- Main Content -->
        <main class="flex-1 flex flex-col p-6 overflow-hidden relative">

            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-2xl font-bold text-gray-800 flex items-center gap-2">
                        <i class="fas fa-robot text-indigo-600"></i> Asistente Inteligente ZhipuAI
                    </h2>
                    <p class="text-gray-500 text-sm">Selecciona un proyecto para an치lisis profundo o pregunta sobre la
                        lista filtrada.</p>
                </div>
            </div>

            <!-- 1. Barra de Filtros -->
            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-4 mb-4 flex-shrink-0">
                <div class="flex flex-col md:flex-row gap-4 justify-between items-end md:items-center">

                    <!-- Buscador -->
                    <div class="w-full md:w-1/4">
                        <label for="filterSearch"
                            class="block text-xs font-semibold text-gray-500 uppercase mb-1">Buscar</label>
                        <div class="relative">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fas fa-search text-gray-400"></i>
                            </div>
                            <input type="text" id="filterSearch"
                                class="pl-10 block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2"
                                placeholder="Nombre, c칩digo...">
                        </div>
                    </div>

                    <!-- Filtros Select -->
                    <div class="flex flex-1 w-full gap-3">
                        <!-- 츼rea -->
                        <div class="flex-1">
                            <label for="filterArea"
                                class="block text-xs font-semibold text-gray-500 uppercase mb-1">츼rea</label>
                            <select id="filterArea"
                                class="block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                <option value="">Cargando...</option>
                            </select>
                        </div>

                        <!-- Estado -->
                        <div class="flex-1">
                            <label for="filterStatus"
                                class="block text-xs font-semibold text-gray-500 uppercase mb-1">Estado</label>
                            <select id="filterStatus"
                                class="block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                <option value="">Cargando...</option>
                            </select>
                        </div>

                        <!-- Financiamiento -->
                        <div class="flex-1">
                            <label for="filterFinancing"
                                class="block text-xs font-semibold text-gray-500 uppercase mb-1">Financiamiento</label>
                            <select id="filterFinancing"
                                class="block w-full rounded-md border-gray-300 border shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-2">
                                <option value="">Cargando...</option>
                            </select>
                        </div>
                    </div>

                    <!-- Acciones -->
                    <div class="flex gap-2">
                        <button onclick="clearFilters()"
                            class="px-4 py-2 bg-gray-100 text-gray-600 text-sm font-medium rounded-md hover:bg-gray-200 transition">
                            <i class="fas fa-times"></i> Limpiar
                        </button>
                        <button onclick="selectFirstFiltered()"
                            class="px-4 py-2 bg-indigo-50 text-indigo-600 text-sm font-medium rounded-md hover:bg-indigo-100 transition">
                            <i class="fas fa-check"></i> Sel. Primero
                        </button>
                    </div>
                </div>
            </div>

            <!-- 2. Contenedor Flex: Lista Proyectos (Izq) + Chat (Der) -->
            <div class="flex gap-4 flex-1 min-h-0">

                <!-- Columna Izquierda: Lista de Proyectos -->
                <div class="w-1/3 bg-white rounded-lg shadow border border-gray-200 flex flex-col relative">
                    <div class="p-3 border-b border-gray-100 bg-gray-50 flex justify-between items-center rounded-t-lg">
                        <span class="font-semibold text-gray-700 text-sm">Proyectos Disponibles</span>
                        <span id="visibleCount"
                            class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded-full">0</span>
                    </div>

                    <div id="projectsLoading" class="loading-overlay hidden">
                        <div class="flex flex-col items-center">
                            <i class="fas fa-spinner fa-spin text-indigo-600 text-2xl mb-2"></i>
                            <span class="text-xs text-gray-500">Cargando datos...</span>
                        </div>
                    </div>

                    <div id="projectListContainer" class="flex-1 overflow-y-auto p-2 space-y-2 custom-scroll">
                        <!-- Items renderizados por JS -->
                    </div>

                    <div class="p-3 border-t border-gray-100 text-xs text-gray-400 bg-gray-50 rounded-b-lg">
                        <i class="fas fa-info-circle mr-1"></i> Selecciona 1 proyecto para detalles.
                    </div>
                </div>

                <!-- Columna Derecha: Chat UI (L칩gica ZhipuAI) -->
                <div class="w-2/3 chat-container">
                    <!-- Header Chat -->
                    <div
                        class="px-4 py-3 border-b border-gray-100 flex justify-between items-center bg-gray-50/50 backdrop-blur-sm">
                        <div class="flex items-center gap-2">
                            <div class="w-2 h-2 rounded-full bg-green-500 animate-pulse"></div>
                            <span class="text-sm font-bold text-gray-700">Asistente Municipal (GLM-4)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span id="chatContextBadge"
                                class="hidden text-xs font-medium bg-indigo-100 text-indigo-700 px-2 py-1 rounded-full flex items-center gap-1">
                                <i class="fas fa-file-alt"></i> <span id="selectedCountMsg">0</span>
                            </span>
                            <div class="h-4 w-px bg-gray-300 mx-1"></div>
                            <button onclick="clearChat()" class="text-gray-400 hover:text-red-500 transition"
                                title="Limpiar chat">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button onclick="exportConversation()"
                                class="text-gray-400 hover:text-indigo-600 transition" title="Exportar conversaci칩n">
                                <i class="fas fa-download"></i>
                            </button>
                        </div>
                    </div>

                    <!-- 츼rea de Mensajes -->
                    <div class="messages-area custom-scroll" id="messagesArea">
                        <!-- Mensaje de Bienvenida -->
                        <div class="message-wrapper bot">
                            <div class="avatar"><i class="fas fa-robot"></i></div>
                            <div class="flex-1">
                                <div class="message-content markdown-body">
                                    <p><strong>춰Hola! Soy tu asistente.</strong></p>
                                    <p>Puedes preguntarme sobre la <strong>lista de proyectos filtrada</strong> actual
                                        (ej: "쮺u치ntos proyectos hay?").</p>
                                    <p>O bien, <strong>selecciona un proyecto</strong> espec칤fico para que analice el
                                        texto completo de sus documentos y responda dudas detalladas.</p>
                                </div>
                                <div class="message-meta text-gray-500" id="initial-timestamp">Hoy, --:--</div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicador escribiendo / Procesando -->
                    <div id="typingIndicator" class="hidden px-4 py-2 bg-gray-50 flex items-center gap-2">
                        <div
                            class="message-content py-2 px-4 text-xs text-gray-500 bg-gray-100 border-0 shadow-none flex items-center gap-2">
                            <div id="typingText">Analizando solicitud</div>
                            <div class="typing-indicator"><span></span><span></span><span></span></div>
                        </div>
                    </div>

                    <!-- Input Chat -->
                    <div class="p-4 bg-white border-t border-gray-100">
                        <form id="chatForm" class="flex items-end gap-2">
                            <button type="button" id="voiceButton"
                                class="p-2.5 text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 rounded-full transition"
                                title="Dictar por voz">
                                <i class="fas fa-microphone"></i>
                            </button>

                            <div class="flex-1 relative">
                                <input type="text" id="chatInput"
                                    class="w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 text-sm p-3 pr-12"
                                    placeholder="Escribe tu pregunta aqu칤..." autocomplete="off">
                                <div id="charCounter" class="absolute bottom-2 right-3 text-[10px] text-gray-400">0/500
                                </div>
                            </div>

                            <button type="submit" id="sendButton"
                                class="bg-indigo-600 hover:bg-indigo-700 text-white p-3 rounded-lg shadow-sm transition-colors flex items-center justify-center w-11 h-11">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Contenedor de Toasts -->
    <div id="toast-container"></div>

    <!-- Script de Funcionalidad Unificada -->
    <script>
        // --- CONFIGURACI칍N ZHIPU AI ---
        const API_KEY = "1dbcda64e67c4d31a7e9e5565efc5cae.M5ZIv5sFPbdOwgKw";
        const API_URL = "https://open.bigmodel.cn/api/paas/v4/chat/completions";
        const MODEL_NAME = "GLM-4.6V-Flash";

        // Configuraci칩n Chat
        const CHAT_CONFIG = {
            MAX_HISTORY_LENGTH: 10,
            MAX_INPUT_LENGTH: 500,
            // L칤mite de seguridad para el texto de documentos
            MAX_TEXT_PAYLOAD_LENGTH: 80000
        };

        // --- CONFIGURACI칍N BACKEND ---
        const API_BASE = 'https://186.67.61.251:8000';

        // NUEVO ENDPOINT PARA TEXTO COMPLETO
        const ENDPOINT_PROJECT_TEXT = (projectId) => `${API_BASE}/proyectos/${projectId}/documentos/texto`;

        // Estado de la Aplicaci칩n
        const AppState = {
            allProjects: [],
            selectedIds: new Set(),
            chatHistory: [],
            recognition: null,
            synthesis: window.speechSynthesis,
            filterProject: [], // Lista de proyectos filtrados visibles en UI
            isMarked: false,
            projectMarket: null,  // Proyecto seleccionado individualmente
            projectRawText: null, // Texto de los documentos del proyecto seleccionado
            textCharsCount: 0
        };

        // Referencias DOM
        const DOM = {
            projectListContainer: document.getElementById('projectListContainer'),
            filterSearch: document.getElementById('filterSearch'),
            filterArea: document.getElementById('filterArea'),
            filterStatus: document.getElementById('filterStatus'),
            filterFinancing: document.getElementById('filterFinancing'),
            visibleCount: document.getElementById('visibleCount'),
            projectsLoading: document.getElementById('projectsLoading'),
            messagesArea: document.getElementById('messagesArea'),
            chatForm: document.getElementById('chatForm'),
            chatInput: document.getElementById('chatInput'),
            typingIndicator: document.getElementById('typingIndicator'),
            typingText: document.getElementById('typingText'),
            voiceButton: document.getElementById('voiceButton'),
            charCounter: document.getElementById('charCounter'),
            chatContextBadge: document.getElementById('chatContextBadge'),
            selectedCountMsg: document.getElementById('selectedCountMsg')
        };

        // --- 1. L칍GICA DE PROYECTOS (Geoportal) ---

        // --- 1. L칍GICA DE PROYECTOS (Geoportal) ---

        function getAuthHeaders() {
            const token = localStorage.getItem('authToken');
            return {
                'Content-Type': 'application/json',
                ...(token ? { 'Authorization': `Bearer ${token}` } : {})
            };
        }

        async function loadCatalogs() {
            try {
                const [areas, estados, financiamientos] = await Promise.all([
                    fetch(`${API_BASE}/areas`, { headers: getAuthHeaders() }).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/estados_proyecto`, { headers: getAuthHeaders() }).then(r => r.json()).catch(() => []),
                    fetch(`${API_BASE}/financiamientos`, { headers: getAuthHeaders() }).then(r => r.json()).catch(() => [])
                ]);

                AppState.catalogs = {
                    areas: areas.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '')),
                    estados: estados.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || '')),
                    financiamientos: financiamientos.sort((a, b) => (a.nombre || '').localeCompare(b.nombre || ''))
                };

                populateDropdowns();
            } catch (e) {
                console.error("Error loading catalogs", e);
            }
        }

        async function loadProjects() {
            try {
                DOM.projectsLoading.classList.remove('hidden');
                // Initiate calls in parallel
                const pProjects = fetch(`${API_BASE}/proyectos`, {
                    method: 'GET',
                    headers: getAuthHeaders()
                }).then(r => {
                    if (!r.ok) throw new Error(`Error API: ${r.status}`);
                    return r.json();
                });

                // Wait for catalogs first (or parallel, but we need catalogs for dropdowns)
                if (!AppState.catalogs) await loadCatalogs();

                AppState.allProjects = await pProjects;
                AppState.filterProject = AppState.allProjects;

                initFilters();
            } catch (error) {
                console.error('Error al cargar proyectos:', error);
                DOM.projectListContainer.innerHTML = `
                    <div class="p-4 text-center text-red-500 text-sm">
                        <i class="fas fa-exclamation-circle mb-2"></i><br>
                        Error cargando datos.
                    </div>`;
            } finally {
                DOM.projectsLoading.classList.add('hidden');
            }
        }

        function initFilters() {
            DOM.filterSearch.addEventListener('input', applyFilters);
            DOM.filterArea.addEventListener('change', applyFilters);
            DOM.filterStatus.addEventListener('change', applyFilters);
            DOM.filterFinancing.addEventListener('change', applyFilters);
            // Dropdowns already populated by loadCatalogs -> populateDropdowns
            applyFilters();
        }

        function populateDropdowns() {
            if (!AppState.catalogs) return;

            fillSelect(DOM.filterArea, AppState.catalogs.areas.map(a => a.nombre), "Todas las 치reas");
            fillSelect(DOM.filterStatus, AppState.catalogs.estados.map(e => e.nombre), "Todos los estados");
            fillSelect(DOM.filterFinancing, AppState.catalogs.financiamientos.map(f => f.nombre), "Todo el financiamiento");
        }

        function fillSelect(selectEl, options, defaultLabel) {
            const current = selectEl.value;
            selectEl.innerHTML = `<option value="">${defaultLabel}</option>`;
            options.forEach(opt => selectEl.innerHTML += `<option value="${opt}">${opt}</option>`);
            if (options.includes(current)) selectEl.value = current;
        }

        function applyFilters() {
            const txt = DOM.filterSearch.value.toLowerCase().trim();
            const area = DOM.filterArea.value;
            const status = DOM.filterStatus.value;
            const fin = DOM.filterFinancing.value;

            const filtered = AppState.allProjects.filter(p => {
                const pNombre = p.nombre ? p.nombre.toLowerCase() : "";
                const pCodigo = p.codigo ? p.codigo.toLowerCase() : "";

                const matchTxt = !txt || pNombre.includes(txt) || pCodigo.includes(txt);
                // Use *_nombre properties matching proyecto.html schema
                const matchArea = area === "" || (p.area_nombre || p.area) == area;
                const matchStatus = status === "" || (p.estado_nombre || p.estado_proyecto) == status;
                const matchFin = fin === "" || (p.financiamiento_nombre || p.financiamiento) == fin;

                return matchTxt && matchArea && matchStatus && matchFin;
            });
            AppState.filterProject = filtered;
            renderProjectList(filtered);
            DOM.visibleCount.textContent = filtered.length;
        }

        function clearFilters() {
            DOM.filterSearch.value = "";
            DOM.filterArea.value = "";
            DOM.filterStatus.value = "";
            DOM.filterFinancing.value = "";
            AppState.selectedIds.clear();
            AppState.isMarked = false;
            AppState.projectMarket = null;
            AppState.projectRawText = null;
            AppState.textCharsCount = 0;
            updateContextUI();
            applyFilters();
        }

        function selectFirstFiltered() {
            const currentList = AppState.filterProject;
            if (currentList.length > 0) {
                const firstProject = currentList[0];
                toggleSelection(firstProject.id, null, null);
            } else {
                showToast("No hay proyectos visibles para seleccionar.", "info");
            }
        }

        function renderProjectList(list) {
            DOM.projectListContainer.innerHTML = "";
            if (list.length === 0) {
                DOM.projectListContainer.innerHTML = `<div class="p-4 text-center text-gray-400 text-sm">No hay proyectos con estos filtros.</div>`;
                return;
            }

            list.forEach(p => {
                const isSelected = AppState.selectedIds.has(p.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded border border-gray-200 cursor-pointer hover:shadow-md transition-colors ${isSelected ? 'project-card-selected' : 'bg-white hover:bg-gray-50'}`;
                div.dataset.projectId = p.id;
                div.onclick = (e) => toggleSelection(p.id, div, e);

                const estado = p.estado_proyecto || 'Sin Estado';
                const monto = p.monto ? formatCompact(p.monto) : '$0';
                const codigo = p.codigo || 'N/A';
                const nombre = p.nombre || 'Sin Nombre';

                div.innerHTML = `
                    <div class="flex items-start gap-3">
                        <div class="pt-1">
                            <input type="checkbox" class="project-checkbox w-4 h-4 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 cursor-pointer" 
                                value="${p.id}" ${isSelected ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelection(${p.id}, this.closest('.cursor-pointer'), event)">
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-semibold text-gray-800 truncate" title="${nombre}">${nombre}</p>
                            <p class="text-xs text-gray-500 mb-1">${codigo} - ${p.area || 'S/A'}</p>
                            <div class="flex justify-between items-center">
                                <span class="text-xs font-medium px-2 py-0.5 rounded ${getStatusBadgeColor(estado)}">${estado}</span>
                                <span class="text-xs text-gray-400">${monto}</span>
                            </div>
                        </div>
                    </div>
                `;
                DOM.projectListContainer.appendChild(div);
            });
        }

        function getStatusBadgeColor(status) {
            if (status === 'Ejecuci칩n') return 'bg-green-100 text-green-700';
            if (status === 'Terminado') return 'bg-gray-100 text-gray-700';
            if (status === 'Licitaci칩n') return 'bg-yellow-100 text-yellow-700';
            if (status === 'Dise침o') return 'bg-blue-100 text-blue-700';
            return 'bg-gray-100 text-gray-600';
        }

        function toggleSelection(id, cardEl, event) {
            const isCurrentlySelected = AppState.selectedIds.has(id);

            if (isCurrentlySelected) {
                AppState.selectedIds.delete(id);
                AppState.isMarked = false;
                AppState.projectMarket = null;
                AppState.projectRawText = null;
                AppState.textCharsCount = 0;
            } else {
                AppState.selectedIds.clear();
                AppState.selectedIds.add(id);
                AppState.isMarked = true;
                const projectData = AppState.allProjects.find(p => p.id === id);
                AppState.projectMarket = projectData || null;
            }

            renderProjectList(AppState.filterProject);
            updateContextUI();
        }

        function updateContextUI() {
            const count = AppState.selectedIds.size;

            if (count > 0) {
                DOM.chatContextBadge.classList.remove('hidden');
                let badgeText = "1 Proyecto Seleccionado";
                if (AppState.textCharsCount > 0) {
                    badgeText += ` + Texto (${(AppState.textCharsCount / 1024).toFixed(0)}KB)`;
                }
                DOM.selectedCountMsg.textContent = badgeText;
            } else {
                DOM.chatContextBadge.classList.add('hidden');
            }
        }

        function formatCompact(num) {
            if (!num) return '$0';
            return new Intl.NumberFormat('es-CL', { style: 'currency', currency: 'CLP', maximumSignificantDigits: 3 }).format(num);
        }

        // --- 2. L칍GICA DE CHAT (ZhipuAI Integration) ---

        function initChat() {
            DOM.chatForm.addEventListener('submit', sendMessage);
            DOM.chatInput.addEventListener('input', updateCharCounter);
            DOM.voiceButton.addEventListener('click', toggleVoiceRecognition);

            const now = new Date();
            document.getElementById('initial-timestamp').textContent = `Hoy, ${now.getHours()}:${now.getMinutes().toString().padStart(2, '0')}`;

            initializeVoiceRecognition();
        }

        function updateCharCounter() {
            const len = DOM.chatInput.value.length;
            DOM.charCounter.textContent = `${len}/${CHAT_CONFIG.MAX_INPUT_LENGTH}`;
            DOM.charCounter.style.color = len > CHAT_CONFIG.MAX_INPUT_LENGTH ? 'red' : 'inherit';
        }

        // --- Voice Recognition ---
        function initializeVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                DOM.voiceButton.hidden = true;
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            AppState.recognition = new SpeechRecognition();
            AppState.recognition.lang = 'es-ES';
            AppState.recognition.continuous = false;
            AppState.recognition.onresult = (event) => {
                DOM.chatInput.value = event.results[0][0].transcript;
                updateCharCounter();
                sendMessage();
            };
            AppState.recognition.onerror = resetVoiceButton;
            AppState.recognition.onend = resetVoiceButton;
        }

        function resetVoiceButton() {
            DOM.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            DOM.voiceButton.classList.remove('text-red-500', 'animate-pulse');
            DOM.chatInput.placeholder = "Escribe tu pregunta aqu칤...";
        }

        function toggleVoiceRecognition() {
            if (!AppState.recognition) return;
            if (DOM.voiceButton.innerHTML.includes('fa-stop')) {
                AppState.recognition.stop();
            } else {
                AppState.recognition.start();
                DOM.voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                DOM.voiceButton.classList.add('text-red-500', 'animate-pulse');
                DOM.chatInput.placeholder = "Escuchando...";
            }
        }

        // --- L칍GICA: Fetch de Texto Completo ---
        async function fetchProjectText(projectId) {
            if (AppState.projectRawText && AppState.projectMarket && AppState.projectMarket.id === projectId) {
                return AppState.projectRawText;
            }

            try {
                const response = await fetch(ENDPOINT_PROJECT_TEXT(projectId), {
                    method: 'GET',
                    headers: getAuthHeaders()
                });

                if (!response.ok) {
                    console.warn(`API de texto fall칩 para proyecto ${projectId}: ${response.status}`);
                    return "No se pudo cargar el contenido de los documentos.";
                }

                const data = await response.json();
                let rawText = "";

                if (data && data.texto) {
                    rawText = data.texto;
                    AppState.textCharsCount = data.chars || rawText.length;
                } else {
                    console.warn("La API no devolvi칩 texto v치lido.");
                    AppState.textCharsCount = 0;
                    rawText = "El proyecto no tiene documentos procesados o el contenido est치 vac칤o.";
                }

                AppState.projectRawText = rawText;
                updateContextUI();

                return rawText;

            } catch (error) {
                console.error('Error fetching document text:', error);
                AppState.projectRawText = null;
                return "Ocurri칩 un error al intentar leer los documentos del proyecto.";
            }
        }

        // --- Core Chat Logic ---
        async function sendMessage(e) {
            if (e) e.preventDefault();

            const text = DOM.chatInput.value.trim();
            if (!text) return;

            if (text.length > CHAT_CONFIG.MAX_INPUT_LENGTH) {
                showToast("El mensaje es muy largo.", "error");
                return;
            }

            addMessageToChat('user', text);
            DOM.chatInput.value = '';
            DOM.chatInput.disabled = true;
            DOM.typingIndicator.classList.remove('hidden');
            DOM.typingText.textContent = "Analizando solicitud...";
            updateCharCounter();
            DOM.messagesArea.scrollTop = DOM.messagesArea.scrollHeight;

            try {
                let response;

                if (AppState.isMarked && AppState.projectMarket) {
                    // --- MODO CONTEXTO: PROYECTO SELECCIONADO ---
                    // Usa: AppState.projectMarket + Documentos
                    DOM.typingText.textContent = "Extrayendo y leyendo contenido de documentos...";

                    const rawTextContent = await fetchProjectText(AppState.projectMarket.id);

                    response = await fetchZhipuResponse(text, {
                        mode: 'project_context',
                        projectData: AppState.projectMarket,
                        documentText: rawTextContent
                    });

                } else {
                    // --- MODO GENERAL: SIN PROYECTO ---
                    // Usa: AppState.filterProject (Lista de proyectos visibles)
                    DOM.typingText.textContent = "Analizando lista de proyectos...";

                    response = await fetchZhipuResponse(text, {
                        mode: 'general',
                        filteredProjects: AppState.filterProject
                    });
                }

                DOM.typingIndicator.classList.add('hidden');
                addMessageToChat('bot', response.respuesta, response.preguntas);
            } catch (error) {
                console.error(error);
                DOM.typingIndicator.classList.add('hidden');
                showToast("Error al conectar con la IA: " + error.message, "error");
            } finally {
                DOM.chatInput.disabled = false;
                DOM.chatInput.focus();
                DOM.typingText.textContent = "Analizando solicitud...";
            }
        }

        async function fetchZhipuResponse(userMessage, context) {
            AppState.chatHistory.push({ role: "user", content: userMessage });

            let systemPrompt = "";

            if (context.mode === 'project_context') {
                // --- L칍GICA PARA MODO PROYECTO ---
                // Usamos SOLO el proyecto seleccionado y sus documentos
                let textToInject = context.documentText || "No hay contenido de documentos.";

                if (textToInject.length > CHAT_CONFIG.MAX_TEXT_PAYLOAD_LENGTH) {
                    console.warn(`Texto largo (${textToInject.length} chars). Truncando...`);
                    textToInject = textToInject.substring(0, CHAT_CONFIG.MAX_TEXT_PAYLOAD_LENGTH) + "\n\n[... Contenido truncado ...]";
                }

                const projectJSON = JSON.stringify(context.projectData);

                systemPrompt = `Eres un asistente experto en an치lisis de proyectos municipales.
Est치s analizando UN 칔NICO PROYECTO seleccionado y sus documentos.

DATOS DEL PROYECTO SELECCIONADO:
 ${projectJSON}

CONTENIDO DE LOS DOCUMENTOS:
 ${textToInject}

INSTRUCCIONES:
1. Responde bas치ndote estrictamente en el "CONTENIDO DE LOS DOCUMENTOS" y los datos del proyecto provistos.
2. Ignora cualquier otro proyecto que exista en la base de datos.
3. Si el usuario pregunta algo general sin relaci칩n con el texto del documento, usa los datos del proyecto.
4. Responde siempre en espa침ol y usa formato Markdown.

Formato de salida requerido:
[RESPUESTA]
... (tu respuesta detallada) ...
[/RESPUESTA]
[PREGUNTAS]
1. Pregunta
2. Pregunta
3. Pregunta
[/PREGUNTAS]`;

            } else {
                console.log(context.filteredProjects)
                const totalProyectos = context.filteredProjects.length; // Calculado por JS
                // --- L칍GICA PARA MODO GENERAL ---
                // Usamos AppState.filterProject (Lista de proyectos filtrados)
                const projectsTableMarkdown = (() => {
                    const headers = [
                        "ID",
                        "Nombre",
                        "츼rea",
                        "Estado",
                        "Monto",
                        "Es Prioridad",
                        "Financiamiento Municipal",
                        "Financiamiento"
                    ];

                    let table = `| ${headers.join(" | ")} |\n`;
                    table += `| ${headers.map(() => "---").join(" | ")} |\n`;

                    context.filteredProjects.forEach(p => {
                        table += `| ${p.id ?? ""} | ${p.nombre ?? ""} | ${p.area ?? ""} | ${p.estado_proyecto ?? ""} | ${p.monto ?? ""} | ${p.es_prioridad ?? ""} | ${p.financiamiento_municipal ?? ""} | ${p.financiamiento ?? ""} |\n`;
                    });

                    return table;
                })();
                console.log(projectsTableMarkdown)

                // Mapeamos la lista a un JSON simple para ahorrar tokens pero mantener datos clave
                const projectsListJSON = JSON.stringify(context.filteredProjects.map(p => ({
                    id: p.id,
                    nombre: p.nombre,
                    area: p.area,
                    estado: p.estado_proyecto,
                    monto: p.monto,
                    es_prioridad: p.es_prioridad,
                    financiamiento_municipal: p.financiamiento_municipal,
                    financiamiento: p.financiamiento
                })), null, 0);

                systemPrompt = `Eres un asistente 칰til del Geoportal Municipal.
Actualmente NO hay ning칰n proyecto seleccionado espec칤ficamente.


INSTRUCCIONES:
1. Responde a preguntas utilizando la "LISTA DE PROYECTOS FILTRADOS" como fuente de verdad.
2. Puedes contar proyectos, buscar por estado, 치rea o montos dentro de esta lista.
3. Si el usuario pregunta detalles profundos de documentos, inv칤talo a seleccionar un proyecto espec칤fico de la lista.
4. Responde siempre en espa침ol y usa formato Markdown.
5. Antes de dar la respuesta final, explica brevemente: 'Procesando lista... encontrados X proyectos
6. Considera que los valores de los proyectos estan en pesos chilenos (CLP)
7. Los campos que tiene la tabla de base de datos son: 
    id:Identificador num칠rico 칰nico o correlativo del proyecto en la lista.            
    nombre:T칤tulo o nombre descriptivo del proyecto,
    area:Categor칤a macro o departamento al que pertenece la iniciativa (Ej: Planificaci칩n, Espacios P칰blicos y equipamiento, Vialidad, Salud, Educaci칩n),
    estado:Fase actual en la que se encuentra el proyecto (Ej: Dise침o, En preparaci칩n, En ejecuci칩n, Licitaci칩n, Adjudicado, Ejecutado, Aprobado).,
    monto:Presupuesto estimado o asignado al proyecto (en pesos chilenos, seg칰n el contexto de los datos).,
    es_prioridad:Indicador que se침ala si el proyecto es considerado prioritario por la municipalidad (valores: S칤, No),
    financiamiento_municipal:Indica si el proyecto utiliza fondos propios del municipio (valores: S칤, No).,
    financiamiento:Fuente de financiamiento externo o fondo espec칤fico (Ej: FNDR, PMU, PMB, GORE, FRIL, Circular 33, Sectorial).
8   - Primero enumera internamente todos los proyectos que cumplen la condici칩n
    - Luego cuenta esa enumeraci칩n
    - Finalmente entrega el total   
LISTA DE PROYECTOS FILTRADOS (VISIBLES EN PANTALLA):
 ${projectsTableMarkdown}
NOTA: Hay exactamente ${totalProyectos} proyectos en esta lista. Usa este n칰mero como referencia.

Formato de salida requerido:
[RESPUESTA]
... (tu respuesta detallada) ...
[/RESPUESTA]
[PREGUNTAS]
1. Pregunta
2. Pregunta
3. Pregunta
[/PREGUNTAS]`;
            }

            const requestBody = {
                model: MODEL_NAME,
                messages: [
                    { role: "system", content: systemPrompt },
                    ...AppState.chatHistory.slice(-CHAT_CONFIG.MAX_HISTORY_LENGTH)
                ],
                temperature: 0,
                //max_tokens: 5500   // 游녣 l칤mite de tokens de salida
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API ${response.status}: ${errText}`);
            }

            const data = await response.json();
            const rawContent = data.choices[0].message.content;

            // Parsear respuesta
            let respuestaFinal = "";
            let preguntasFinal = [];

            const matchResp = rawContent.match(/\[RESPUESTA\]([\s\S]*?)\[\/RESPUESTA\]/i);
            const matchPreg = rawContent.match(/\[PREGUNTAS\]([\s\S]*?)\[\/PREGUNTAS\]/i);

            if (matchResp) respuestaFinal = matchResp[1].trim();
            else respuestaFinal = rawContent;

            if (matchPreg) {
                const lines = matchPreg[1].split('\n').filter(l => l.trim());
                lines.forEach(l => {
                    const m = l.match(/^\d+\.\s*(.+)/);
                    if (m) preguntasFinal.push(m[1].trim());
                });
            }

            if (preguntasFinal.length === 0) preguntasFinal = ["쯈u칠 m치s puedo ayudarte?", "쯅ecesitas m치s detalles?", "쮺칩mo proceder?"];

            AppState.chatHistory.push({ role: "assistant", content: respuestaFinal });

            return { respuesta: respuestaFinal, preguntas: preguntasFinal };
        }

        function addMessageToChat(sender, text, preguntas = []) {
            const wrapper = document.createElement('div');
            wrapper.className = `message-wrapper ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'avatar';
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content markdown-body';

            if (sender === 'user') {
                contentDiv.textContent = text;
            } else {
                contentDiv.innerHTML = marked.parse(sanitizeInput(text));

                const actionsDiv = document.createElement('div');
                actionsDiv.className = 'flex gap-2 mt-3 border-t border-gray-200 pt-2 opacity-60 hover:opacity-100 transition';

                const btnCopy = document.createElement('button');
                btnCopy.className = 'text-xs flex items-center gap-1 hover:text-indigo-600';
                btnCopy.innerHTML = '<i class="fas fa-copy"></i> Copiar';
                btnCopy.onclick = () => { navigator.clipboard.writeText(text); showToast("Texto copiado al portapapeles", "success"); };

                const btnSpeak = document.createElement('button');
                btnSpeak.className = 'text-xs flex items-center gap-1 hover:text-indigo-600';
                btnSpeak.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar';
                btnSpeak.onclick = function () { speakText(text, this); };

                actionsDiv.appendChild(btnCopy);
                actionsDiv.appendChild(btnSpeak);
                contentDiv.appendChild(actionsDiv);

                if (preguntas.length > 0) {
                    const chipsContainer = document.createElement('div');
                    chipsContainer.className = 'suggestion-chips';
                    preguntas.forEach(q => {
                        const chip = document.createElement('button');
                        chip.className = 'suggestion-chip';
                        chip.innerHTML = `<i class="fas fa-arrow-right text-xs"></i> ${q}`;
                        chip.onclick = () => {
                            DOM.chatInput.value = q;
                            sendMessage();
                        };
                        chipsContainer.appendChild(chip);
                    });
                    contentDiv.appendChild(chipsContainer);
                }
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(contentDiv);

            DOM.messagesArea.appendChild(wrapper);
            DOM.messagesArea.scrollTop = DOM.messagesArea.scrollHeight;
        }

        function sanitizeInput(text) {
            return text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '').replace(/javascript:/gi, '');
        }

        function speakText(text, btn) {
            if (!AppState.synthesis) return;
            if (AppState.synthesis.speaking) {
                AppState.synthesis.cancel();
                btn.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar';
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.onend = () => { btn.innerHTML = '<i class="fas fa-volume-up"></i> Escuchar'; };
            AppState.synthesis.speak(utterance);
            btn.innerHTML = '<i class="fas fa-stop"></i> Detener';
        }

        function clearChat() {
            if (!confirm("쮼st치s seguro de que quieres borrar todo el historial del chat?")) return;
            DOM.messagesArea.innerHTML = `
                <div class="message-wrapper bot">
                    <div class="avatar"><i class="fas fa-robot"></i></div>
                    <div class="flex-1">
                        <div class="message-content markdown-body">
                            <p><strong>춰Hola! Soy tu asistente.</strong></p>
                            <p>El chat ha sido reiniciado. Puedes preguntar sobre la lista filtrada o seleccionar un proyecto para detalles.</p>
                        </div>
                        <div class="message-meta text-gray-500">Hoy, ${new Date().toLocaleTimeString()}</div>
                    </div>
                </div>
            `;
            AppState.chatHistory = [];
        }

        function exportConversation() {
            let txt = "Conversaci칩n Exportada - Asistente Geoportal\n\n";
            DOM.messagesArea.querySelectorAll('.message-wrapper').forEach(wrapper => {
                const isBot = wrapper.classList.contains('bot');
                const role = isBot ? "IA:" : "T칰:";
                const content = wrapper.querySelector('.message-content').innerText;
                txt += `${role}\n${content}\n\n`;
            });

            const blob = new Blob([txt], { type: 'text/plain' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `chat-geoportal-${Date.now()}.txt`;
            a.click();
            showToast("Conversaci칩n exportada correctamente", "success");
        }

        function showToast(message, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';

            let icon = '<i class="fas fa-info-circle"></i>';
            if (type === 'success') icon = '<i class="fas fa-check-circle text-green-400"></i>';
            if (type === 'error') icon = '<i class="fas fa-exclamation-triangle text-red-400"></i>';

            toast.innerHTML = `${icon} <span>${message}</span>`;

            container.appendChild(toast);

            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transform = 'translateY(10px)';
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadProjects();
            initChat();
        });
    </script>
    <script src="../../../script/layout.js"></script>
</body>

</html>