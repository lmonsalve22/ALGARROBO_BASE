<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chat IA ZhipuAI</title>
    <!-- Dependencias necesarias para la lÃ³gica -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>

    <header>
        <h1>Asistente Virtual</h1>
        <div>
            <button id="dark-mode-toggle" title="Cambiar modo"><i class="fas fa-moon"></i></button>
            <button id="clear-button" title="Limpiar chat"><i class="fas fa-trash"></i></button>
            <button id="export-button" title="Exportar conversaciÃ³n"><i class="fas fa-download"></i></button>
        </div>
    </header>

    <hr>

    <!-- Contenedor del Chat -->
    <main id="chat-container">
        <div class="message bot-message">
            <div class="message-wrapper">
                <div class="bot-avatar"><i class="fas fa-robot"></i></div>
                <div class="message-info">
                    <div class="message-content">Â¡Hola! Soy una inteligencia artificial basada en GLM-4. Â¿En quÃ© puedo ayudarte?</div>
                    <div class="timestamp" id="initial-timestamp">Hoy, --:-- --</div>
                </div>
            </div>
            <br>
        </div>
    </main>

    <!-- Indicador de carga (usando atributo hidden en lugar de style) -->
    <div id="loading-indicator" hidden>La IA estÃ¡ pensando...</div>

    <hr>

    <!-- Ãrea de Input -->
    <footer>
        <div>
            <button id="voice-button" title="Dictar por voz"><i class="fas fa-microphone"></i></button>
            <input type="text" id="user-input" placeholder="Escribe tu mensaje aquÃ­..." autocomplete="off" style="width: 80%;">
            <button id="send-button" title="Enviar mensaje"><i class="fas fa-paper-plane"></i></button>
        </div>
        <div id="char-counter">0/500</div>
    </footer>

    <script>
        // --- CONFIGURACIÃ“N ZHIPU AI ---
        const API_KEY = "1dbcda64e67c4d31a7e9e5565efc5cae.M5ZIv5sFPbdOwgKw";
        const API_URL = "https://api.z.ai/api/paas/v4/chat/completions";
        // Cambiado a "glm-4" porque "glm-4-flash" dio error 1211 (Modelo no existe)
        const MODEL_NAME = "glm-4.5-flash"; 
        
        const USE_MOCK_API = false; 

        const CHAT_CONFIG = {
            MAX_HISTORY_LENGTH: 10,
            MAX_INPUT_LENGTH: 500
        };

        const UIState = {
            historialConversacion: [],
            recognition: null,
            synthesis: window.speechSynthesis
        };

        const DOMElements = {
            chatContainer: document.getElementById('chat-container'),
            userInput: document.getElementById('user-input'),
            sendButton: document.getElementById('send-button'),
            clearButton: document.getElementById('clear-button'),
            exportButton: document.getElementById('export-button'),
            darkModeToggle: document.getElementById('dark-mode-toggle'),
            voiceButton: document.getElementById('voice-button'),
            loadingIndicator: document.getElementById('loading-indicator'),
            charCounter: document.getElementById('char-counter')
        };

        document.addEventListener('DOMContentLoaded', () => {
            DOMElements.sendButton.addEventListener('click', sendMessage);
            DOMElements.clearButton.addEventListener('click', clearChat);
            DOMElements.exportButton.addEventListener('click', exportConversation);
            DOMElements.darkModeToggle.addEventListener('click', toggleDarkMode);
            DOMElements.voiceButton.addEventListener('click', toggleVoiceRecognition);
            
            DOMElements.userInput.addEventListener('keypress', handleKeyPress);
            DOMElements.userInput.addEventListener('input', updateCharCounter);
            
            DOMElements.userInput.focus();
            initializeVoiceRecognition();
            
            // Marcar hora inicial
            const now = new Date();
            document.getElementById('initial-timestamp').textContent = 
                `Hoy, ${now.getHours()}:${now.getMinutes().toString().padStart(2,'0')}`;
        });

        function initializeVoiceRecognition() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                DOMElements.voiceButton.hidden = true;
                return;
            }
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            UIState.recognition = new SpeechRecognition();
            UIState.recognition.lang = 'es-ES';
            UIState.recognition.continuous = false;
            UIState.recognition.onresult = (event) => {
                DOMElements.userInput.value = event.results[0][0].transcript;
                sendMessage();
            };
            UIState.recognition.onerror = resetVoiceButton;
            UIState.recognition.onend = resetVoiceButton;
        }

        function resetVoiceButton() {
            DOMElements.voiceButton.innerHTML = '<i class="fas fa-microphone"></i>';
            DOMElements.userInput.placeholder = "Escribe tu mensaje aquÃ­...";
        }

        function toggleVoiceRecognition() {
            if (!UIState.recognition) return;
            if (DOMElements.voiceButton.innerHTML.includes('fa-stop')) {
                UIState.recognition.stop();
            } else {
                UIState.recognition.start();
                DOMElements.voiceButton.innerHTML = '<i class="fas fa-stop"></i>';
                DOMElements.userInput.placeholder = "Escuchando...";
            }
        }

        function speakText(text, button) {
            if (!UIState.synthesis) return;
            if (UIState.synthesis.speaking) {
                UIState.synthesis.cancel();
                button.innerHTML = '<i class="fas fa-volume-up"></i>';
                return;
            }
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'es-ES';
            utterance.onend = () => { button.innerHTML = '<i class="fas fa-volume-up"></i>'; };
            UIState.synthesis.speak(utterance);
            button.innerHTML = '<i class="fas fa-stop"></i>';
        }

        function handleKeyPress(e) { if (e.key === 'Enter') sendMessage(); }

        async function sendMessage() {
            const message = DOMElements.userInput.value.trim();
            if (!message) return;

            DOMElements.sendButton.disabled = true;
            DOMElements.userInput.disabled = true;

            addMessageToChat('user', message);
            DOMElements.userInput.value = '';
            DOMElements.loadingIndicator.hidden = false;

            try {
                const response = await obtenerRespuesta(message);
                DOMElements.loadingIndicator.hidden = true;
                addMessageToChat('bot', response.respuesta, response.preguntas);
            } catch (error) {
                console.error(error);
                DOMElements.loadingIndicator.hidden = true;
                alert('Error: ' + error.message);
            } finally {
                DOMElements.sendButton.disabled = false;
                DOMElements.userInput.disabled = false;
                DOMElements.userInput.focus();
            }
        }

        function addMessageToChat(sender, message, preguntas = []) {
            const wrapper = document.createElement('div');
            
            const avatar = document.createElement('span');
            avatar.innerHTML = sender === 'user' ? '<i class="fas fa-user"></i>' : '<i class="fas fa-robot"></i>';
            avatar.innerText += " ";

            const info = document.createElement('div');

            const content = document.createElement('div');
            
            if (sender === 'user') {
                content.textContent = message;
                content.style.background = "#eee";
            } else {
                content.innerHTML = marked.parse(sanitizeInput(message));
                
                // Botones bÃ¡sicos
                const btnCopy = document.createElement('button');
                btnCopy.innerText = 'Copiar';
                btnCopy.onclick = () => { navigator.clipboard.writeText(message); alert("Copiado"); };
                
                const btnSpeak = document.createElement('button');
                btnSpeak.innerText = 'ðŸ”Š';
                btnSpeak.onclick = () => speakText(message, btnSpeak);

                content.appendChild(document.createElement('br'));
                content.appendChild(btnCopy);
                content.appendChild(btnSpeak);
            }
            
            info.appendChild(content);
            
            const time = document.createElement('small');
            time.innerText = new Date().toLocaleTimeString();
            info.appendChild(time);

            // Preguntas
            if (sender === 'bot' && preguntas.length > 0) {
                const qDiv = document.createElement('div');
                preguntas.forEach(q => {
                    const btn = document.createElement('button');
                    btn.innerText = `â†ª ${q}`;
                    btn.style.display = 'block';
                    btn.style.width = '100%';
                    btn.style.textAlign = 'left';
                    btn.onclick = () => {
                        DOMElements.userInput.value = q;
                        sendMessage();
                    };
                    qDiv.appendChild(btn);
                });
                info.appendChild(qDiv);
            }

            wrapper.appendChild(avatar);
            wrapper.appendChild(info);
            
            DOMElements.chatContainer.appendChild(wrapper);
            DOMElements.chatContainer.scrollTop = DOMElements.chatContainer.scrollHeight;
        }

        async function obtenerRespuesta(pregunta) {
            UIState.historialConversacion.push({ role: "user", content: pregunta });

            const promptSistema = `Eres un asistente IA amigable.
            Responde en Markdown.
            Genera 3 preguntas de seguimiento al final.
            Formato:
            [RESPUESTA]
            ...
            [/RESPUESTA]
            [PREGUNTAS]
            1. ...
            2. ...
            3. ...
            [/PREGUNTAS]`;

            const requestBody = {
                model: MODEL_NAME,
                messages: [
                    { role: "system", content: promptSistema },
                    ...UIState.historialConversacion.slice(-CHAT_CONFIG.MAX_HISTORY_LENGTH)
                ]
            };

            const response = await fetch(API_URL, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${API_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errText = await response.text();
                throw new Error(`API ${response.status}: ${errText}`);
            }

            const data = await response.json();
            const texto = data.choices[0].message.content;

            let respuestaFinal = "";
            let preguntasFinal = [];

            const matchResp = texto.match(/\[RESPUESTA\]([\s\S]*?)\[\/RESPUESTA\]/i);
            const matchPreg = texto.match(/\[PREGUNTAS\]([\s\S]*?)\[\/PREGUNTAS\]/i);

            if (matchResp) respuestaFinal = matchResp[1].trim();
            else respuestaFinal = texto;

            if (matchPreg) {
                const lines = matchPreg[1].split('\n').filter(l => l.trim());
                lines.forEach(l => {
                    const m = l.match(/^\d+\.\s*(.+)/);
                    if(m) preguntasFinal.push(m[1].trim());
                });
            }

            if (preguntasFinal.length === 0) preguntasFinal = ["Â¿Dime mÃ¡s?", "Â¿CÃ³mo funciona?", "ExplÃ­came mejor"];

            UIState.historialConversacion.push({ role: "assistant", content: respuestaFinal });

            return { respuesta: respuestaFinal, preguntas: preguntasFinal };
        }

        function sanitizeInput(text) {
            return text.replace(/<script\b[^<]*(?:(?!<\/script>)<[^<]*)*<\/script>/gi, '').replace(/javascript:/gi, '');
        }

        function clearChat() {
            if(!confirm("Â¿Borrar chat?")) return;
            DOMElements.chatContainer.innerHTML = '<div class="message bot-message"><div class="message-wrapper"><div class="bot-avatar"><i class="fas fa-robot"></i> </div><div class="message-info"><div class="message-content">Â¡Hola! Soy una inteligencia artificial basada en GLM-4. Â¿En quÃ© puedo ayudarte?</div><div class="timestamp" id="initial-timestamp">Hoy, --:-- --</div></div></div><br></div>';
            UIState.historialConversacion = [];
        }

        function exportConversation() {
            let txt = "Chat Exportado\n";
            DOMElements.chatContainer.querySelectorAll('.message-content').forEach(c => txt += c.textContent + "\n\n");
            const a = document.createElement('a');
            a.href = 'data:text/plain;charset=utf-8,' + encodeURIComponent(txt);
            a.download = 'chat.txt';
            a.click();
        }

        function toggleDarkMode() {
            // Sin CSS, esto no hace mucho visualmente, pero guardamos el estado si se usa estilos externos
            alert("Modo oscuro conmutado (requiere CSS para efecto visual)");
        }
    </script>
</body>
</html>