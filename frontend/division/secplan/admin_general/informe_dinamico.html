<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <script src="../../../script/api.js"></script>
    <script src="../../../script/utils.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Dinámico - Geoportal Municipal</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366f1',
                        secondary: '#ec4899',
                        accent: '#8b5cf6',
                    }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Highcharts core and modules -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/highcharts-3d.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/highcharts-more.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/funnel.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/treemap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/exporting.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/export-data.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/accessibility.js"></script>

    <link rel="stylesheet" href="styles/admin-styles.css">

    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        }

        .header-gradient {
            background: var(--gradient-primary);
            border-radius: 1.5rem;
            padding: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.5);
        }

        #chartContainer {
            height: 600px;
            width: 100%;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>
    <div id="headerRender"></div>

    <div class="flex">
        <div id="asideRender"></div>

        <main class="flex-1 p-6">
            <div class="header-gradient mb-8 animate-fade-in">
                <div class="relative z-10">
                    <div class="flex items-center gap-4 mb-4">
                        <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur">
                            <i class="fas fa-chart-pie text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold">Informe Dinámico</h1>
                            <p class="text-white/80">Analiza la inversión por diferentes categorías mediante gráficos 3D
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 mb-8 animate-fade-in">
                <div class="flex flex-col md:flex-row gap-6 items-end">
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Agrupar proyectos por:</label>
                        <select id="groupByField" onchange="updateChart()"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white transition-all">
                            <option value="area_nombre">Área</option>
                            <option value="lineamiento_estrategico_nombre">Lineamiento Estratégico</option>
                            <option value="financiamiento_nombre">Fuente de Financiamiento</option>
                            <option value="anno_elaboracion">Año de Elaboración</option>
                            <option value="anno_ejecucion">Año de Ejecución</option>
                            <option value="estado_nombre">Estado del Proyecto</option>
                            <option value="etapa_nombre">Etapa del Proyecto</option>
                            <option value="estado_postulacion_nombre">Estado de Postulación</option>
                            <option value="sector_nombre">Sector</option>
                            <option value="profesional_1">Profesional Responsable</option>
                        </select>
                    </div>
                    <div class="flex-1">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Gráfico:</label>
                        <select id="chartType" onchange="updateChart()"
                            class="w-full px-4 py-3 border border-gray-200 rounded-xl focus:ring-2 focus:ring-indigo-500 bg-white transition-all">
                            <option value="pie_3d">Pie Circular 3D</option>
                            <option value="donut_3d">Donut 3D</option>
                            <option value="column_3d">Columnas 3D</option>
                            <option value="bar_3d">Barras 3D</option>
                            <option value="line">Líneas de Tendencia</option>
                            <option value="area">Áreas de Inversión</option>
                            <option value="funnel">Embudo de Etapas/Inversión</option>
                            <option value="pyramid">Pirámide</option>
                            <option value="treemap">Mapa de Árbol (Inversión Relativa)</option>
                            <option value="radial">Gráfico Polar (Radar)</option>
                        </select>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="generarInforme()" class="btn-primary">
                            <i class="fas fa-file-invoice"></i> Generar Informe
                        </button>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-8 animate-fade-in">
                <div id="chartContainer"></div>
            </div>
        </main>
    </div>

    <script src="../../../script/layout.js"></script>
    <script>
        let allProjects = [];

        async function fetchProjects() {
            try {
                // api.js ya gestiona la baseURL y el token de autenticación
                allProjects = await api.get('/proyectos');
                updateChart();
            } catch (error) {
                console.error('Error al cargar proyectos:', error);
                alert('Error al cargar datos: ' + (error.message || 'No se pudo conectar al servidor'));
            }
        }

        function updateChart() {
            if (!allProjects || allProjects.length === 0) return;

            const groupBy = document.getElementById('groupByField').value;
            const chartType = document.getElementById('chartType').value;
            const fieldLabel = document.getElementById('groupByField').options[document.getElementById('groupByField').selectedIndex].text;

            const groupedData = {};
            let totalMonto = 0;

            allProjects.forEach(p => {
                let value = p[groupBy] || 'Sin especificar';
                let monto = parseFloat(p.monto) || 0;
                groupedData[value] = (groupedData[value] || 0) + monto;
                totalMonto += monto;
            });

            const seriesData = Object.keys(groupedData).map(name => ({
                name: name,
                y: groupedData[name],
                percentage: (groupedData[name] / (totalMonto || 1)) * 100
            })).sort((a, b) => b.y - a.y);

            renderChart(seriesData, fieldLabel, totalMonto, chartType);
        }

        function renderChart(data, label, total, type) {
            const commonConfig = {
                chart: {
                    backgroundColor: 'transparent',
                    style: { fontFamily: 'Outfit' }
                },
                title: {
                    text: `Distribución de Inversión por ${label}`,
                    style: { fontSize: '20px', fontWeight: 'bold' }
                },
                subtitle: {
                    text: `Inversión Total: ${formatCurrency(total)}`,
                    style: { fontSize: '16px' }
                },
                tooltip: {
                    pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b><br>Monto: <b>$ {point.y:,.0f}</b>'
                }
            };

            let specificConfig = {};

            switch (type) {
                case 'pie_3d':
                    specificConfig = {
                        chart: { type: 'pie', options3d: { enabled: true, alpha: 45, beta: 0 } },
                        plotOptions: { pie: { depth: 35, dataLabels: { enabled: true, format: '{point.name}: {point.percentage:.1f}%' } } },
                        series: [{ name: 'Inversión', data: data }]
                    };
                    break;
                case 'donut_3d':
                    specificConfig = {
                        chart: { type: 'pie', options3d: { enabled: true, alpha: 45, beta: 0 } },
                        plotOptions: { pie: { innerSize: '60%', depth: 35, dataLabels: { enabled: true, format: '{point.name}: {point.percentage:.1f}%' } } },
                        series: [{ name: 'Inversión', data: data }]
                    };
                    break;
                case 'column_3d':
                    specificConfig = {
                        chart: { type: 'column', options3d: { enabled: true, alpha: 15, beta: 15, depth: 50, viewDistance: 25 } },
                        xAxis: { categories: data.map(d => d.name) },
                        series: [{ name: 'Inversión', data: data.map(d => d.y), colorByPoint: true }]
                    };
                    break;
                case 'bar_3d':
                    specificConfig = {
                        chart: { type: 'bar', options3d: { enabled: true, alpha: 10, beta: 10, depth: 50 } },
                        xAxis: { categories: data.map(d => d.name) },
                        series: [{ name: 'Inversión', data: data.map(d => d.y), colorByPoint: true }]
                    };
                    break;
                case 'line':
                    specificConfig = {
                        chart: { type: 'line' },
                        xAxis: { categories: data.map(d => d.name) },
                        series: [{ name: 'Inversión', data: data.map(d => d.y) }]
                    };
                    break;
                case 'area':
                    specificConfig = {
                        chart: { type: 'area' },
                        xAxis: { categories: data.map(d => d.name) },
                        series: [{ name: 'Inversión', data: data.map(d => d.y) }]
                    };
                    break;
                case 'funnel':
                    specificConfig = {
                        chart: { type: 'funnel' },
                        plotOptions: { funnel: { neckWidth: '30%', neckHeight: '25%', width: '70%', dataLabels: { enabled: true, format: '<b>{point.name}</b>: {point.percentage:.1f}%' } } },
                        series: [{ name: 'Inversión', data: data.map(d => [d.name, d.y]) }]
                    };
                    break;
                case 'pyramid':
                    specificConfig = {
                        chart: { type: 'pyramid' },
                        plotOptions: { pyramid: { dataLabels: { enabled: true, format: '{point.name}' } } },
                        series: [{ name: 'Inversión', data: data.map(d => [d.name, d.y]) }]
                    };
                    break;
                case 'treemap':
                    specificConfig = {
                        chart: { type: 'treemap' },
                        series: [{ layoutAlgorithm: 'squarified', data: data.map(d => ({ name: d.name, value: d.y, colorValue: d.y })) }]
                    };
                    break;
                case 'radial':
                    specificConfig = {
                        chart: { polar: true, type: 'line' },
                        xAxis: { categories: data.map(d => d.name), tickmarkPlacement: 'on', lineWidth: 0 },
                        yAxis: { gridLineInterpolation: 'polygon', lineWidth: 0, min: 0 },
                        series: [{ name: 'Inversión', data: data.map(d => d.y), pointPlacement: 'on' }]
                    };
                    break;
            }

            const finalConfig = Highcharts.merge(commonConfig, specificConfig);
            Highcharts.chart('chartContainer', finalConfig);
        }

        function generarInforme() {
            if (!allProjects || allProjects.length === 0) {
                alert('No hay datos cargados para generar el informe.');
                return;
            }

            const groupBy = document.getElementById('groupByField').value;
            const fieldLabel = document.getElementById('groupByField').options[document.getElementById('groupByField').selectedIndex].text;
            const groupedData = {};

            allProjects.forEach(p => {
                let value = p[groupBy] || 'Sin especificar';
                let monto = parseFloat(p.monto) || 0;
                if (!groupedData[value]) groupedData[value] = { count: 0, total: 0 };
                groupedData[value].count++;
                groupedData[value].total += monto;
            });

            console.table(groupedData);
            alert(`Informe generado para "${fieldLabel}" con ${Object.keys(groupedData).length} categorías analizadas. Los detalles se han exportado a la consola de desarrollador.`);
        }

        document.addEventListener('DOMContentLoaded', () => {
            // checkLoginStatus viene de router.js o utils.js
            if (typeof checkLoginStatus === 'function') {
                checkLoginStatus();
            }
            fetchProjects();
        });
    </script>
</body>

</html>