<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <script src="../../../script/api.js"></script>
    <script src="../../../script/utils.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal - Gestión de Usuarios</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <!-- Unified Admin Styles -->
    <link rel="stylesheet" href="styles/admin-styles.css">
</head>

<body class="bg-gray-50">
    <div id="headerRender"></div>

    <div class="flex">
        <div id="asideRender"></div>

        <main class="flex-1 p-6">
            <div class="max-w-7xl mx-auto">
                <!-- Page Header -->
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Gestión de Usuarios</h1>
                        <p class="text-gray-500 mt-1">Administra los accesos y permisos del sistema</p>
                    </div>
                    <button onclick="openModal()" class="btn-primary flex items-center gap-2">
                        <i class="fas fa-user-plus"></i>
                        Nuevo Usuario
                    </button>
                </div>

                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                    <div class="card-modern p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Usuarios Totales</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="totalUsersCount">0</h3>
                            </div>
                            <div class="bg-blue-100 p-3 rounded-xl text-blue-600">
                                <i class="fas fa-users text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-modern p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Administradores</p>
                                <h3 class="text-2xl font-bold text-gray-800 mt-1" id="adminCount">0</h3>
                            </div>
                            <div class="bg-indigo-100 p-3 rounded-xl text-indigo-600">
                                <i class="fas fa-user-shield text-xl"></i>
                            </div>
                        </div>
                    </div>
                    <div class="card-modern p-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-gray-500 font-medium">Activos Ahora</p>
                                <h3 class="text-2xl font-bold text-green-600 mt-1" id="activeCount">0</h3>
                            </div>
                            <div class="bg-green-100 p-3 rounded-xl text-green-600">
                                <i class="fas fa-signal text-xl"></i>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Users Table -->
                <div class="card-modern overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="text-lg font-semibold text-gray-800">Lista de Usuarios</h2>
                        <div class="relative w-64">
                            <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 text-sm"></i>
                            <input type="text" id="userSearch" onkeyup="filterUsers()" placeholder="Buscar usuario..."
                                class="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm w-full focus:ring-2 focus:ring-blue-500 outline-none">
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-600 text-sm font-semibold uppercase">
                                <tr>
                                    <th class="px-6 py-4">Usuario</th>
                                    <th class="px-6 py-4">División</th>
                                    <th class="px-6 py-4">Rol</th>
                                    <th class="px-6 py-4 text-center">Estado</th>
                                    <th class="px-6 py-4 text-center">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody" class="divide-y divide-gray-100">
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Form -->
    <div id="userModal" class="modal">
        <div class="modal-content max-w-lg">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-xl font-bold text-gray-800" id="modalTitle">Nuevo Usuario</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <form id="userForm" onsubmit="handleSubmit(event)" class="space-y-4">
                <div class="form-group">
                    <label for="nombre">Nombre Completo</label>
                    <input type="text" id="nombre" name="nombre" required placeholder="Ej: Juan Pérez">
                </div>

                <div class="form-group">
                    <label for="email">Correo Electrónico</label>
                    <input type="email" id="email" name="email" required placeholder="juan@algarrobo.cl">
                </div>

                <div class="form-group" id="passwordGroup">
                    <label for="password">Contraseña</label>
                    <input type="password" id="password" name="password" required placeholder="••••••••">
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="division_id">División</label>
                        <select id="division_id" name="division_id" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="role_id">Rol / Nivel</label>
                        <select id="role_id" name="role_id" required>
                            <option value="">Seleccionar...</option>
                        </select>
                    </div>
                </div>

                <div class="checkbox-group mt-4">
                    <input type="checkbox" id="es_activo" name="es_activo" checked>
                    <label for="es_activo" class="mb-0">Usuario Activo</label>
                </div>

                <div class="mt-8 flex justify-end gap-3">
                    <button type="button" onclick="closeModal()"
                        class="px-6 py-2 rounded-lg text-gray-600 hover:bg-gray-100 transition">
                        Cancelar
                    </button>
                    <button type="submit" id="submitBtn" class="btn-primary px-8">
                        Guardar Usuario
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../../script/layout.js"></script>

    <script>
        let users = [];
        let editingUserId = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadInitialData();
        });

        async function loadInitialData() {
            try {
                const [divisiones, roles, usersData] = await Promise.all([
                    api.get('/divisiones'),
                    api.get('/roles'),
                    api.get('/users')
                ]);

                // Poblar selects
                const divSelect = document.getElementById('division_id');
                divisiones.forEach(d => {
                    const opt = new Option(d.nombre, d.division_id);
                    divSelect.add(opt);
                });

                const roleSelect = document.getElementById('role_id');
                roles.forEach(r => {
                    const opt = new Option(`${r.nombre} (${r.nivel_acceso})`, r.role_id);
                    roleSelect.add(opt);
                });

                users = usersData;
                renderUsers();
                updateStats();
            } catch (error) {
                showToast('Error cargando datos', 'error');
            }
        }

        function renderUsers(usersToRender = users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            usersToRender.forEach(user => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-50 transition-colors';

                const statusBadge = user.es_activo
                    ? '<span class="px-2 py-1 bg-green-100 text-green-700 rounded-full text-xs font-semibold">Activo</span>'
                    : '<span class="px-2 py-1 bg-red-100 text-red-700 rounded-full text-xs font-semibold">Inactivo</span>';

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-3">
                            <div class="w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center text-blue-600 font-bold">
                                ${user.nombre?.charAt(0).toUpperCase() || 'U'}
                            </div>
                            <div>
                                <p class="font-medium text-gray-800">${user.nombre}</p>
                                <p class="text-xs text-gray-500">${user.email}</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-600">${user.division_nombre || '-'}</td>
                    <td class="px-6 py-4 text-sm text-gray-600">${user.role_nombre || '-'}</td>
                    <td class="px-6 py-4 text-center">${statusBadge}</td>
                    <td class="px-6 py-4">
                        <div class="flex items-center justify-center gap-2">
                            <button onclick="editUser(${user.user_id})" class="p-2 text-blue-600 hover:bg-blue-50 rounded-lg transition" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleUserStatus(${user.user_id})" class="p-2 text-yellow-600 hover:bg-yellow-50 rounded-lg transition" title="Cambiar Estado">
                                <i class="fas fa-power-off"></i>
                            </button>
                            <button onclick="deleteUser(${user.user_id})" class="p-2 text-red-600 hover:bg-red-50 rounded-lg transition" title="Eliminar">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateStats() {
            document.getElementById('totalUsersCount').textContent = users.length;
            document.getElementById('adminCount').textContent = users.filter(u => u.nivel_acceso === 1).length;
            document.getElementById('activeCount').textContent = users.filter(u => u.es_activo).length;
        }

        function filterUsers() {
            const term = document.getElementById('userSearch').value.toLowerCase();
            const filtered = users.filter(u =>
                u.nombre?.toLowerCase().includes(term) ||
                u.email?.toLowerCase().includes(term)
            );
            renderUsers(filtered);
        }

        function openModal(user = null) {
            editingUserId = user ? user.user_id : null;
            document.getElementById('modalTitle').textContent = user ? 'Editar Usuario' : 'Nuevo Usuario';
            document.getElementById('userForm').reset();

            const passInput = document.getElementById('password');
            if (user) {
                document.getElementById('nombre').value = user.nombre;
                document.getElementById('email').value = user.email;
                document.getElementById('division_id').value = user.division_id || '';
                document.getElementById('role_id').value = user.role_id || '';
                document.getElementById('es_activo').checked = user.es_activo;
                passInput.required = false;
                document.getElementById('passwordGroup').style.opacity = '0.5';
            } else {
                passInput.required = true;
                document.getElementById('passwordGroup').style.opacity = '1';
            }

            document.getElementById('userModal').classList.add('active');
        }

        function closeModal() {
            document.getElementById('userModal').classList.remove('active');
        }

        async function handleSubmit(e) {
            e.preventDefault();
            const formData = utils.serializeForm(e.target);
            formData.es_activo = document.getElementById('es_activo').checked;

            const btn = document.getElementById('submitBtn');
            const originalText = btn.textContent;

            try {
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Guardando...';

                if (editingUserId) {
                    if (!formData.password) delete formData.password;
                    await api.put(`/users/${editingUserId}`, formData);
                    showToast('Usuario actualizado correctamente');
                } else {
                    await api.post('/users', formData);
                    showToast('Usuario creado correctamente');
                }

                closeModal();
                loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        async function toggleUserStatus(id) {
            const user = users.find(u => u.user_id === id);
            if (!user) return;
            try {
                await api.put(`/users/${id}`, { es_activo: !user.es_activo });
                showToast('Estado de usuario cambiado');
                loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        async function deleteUser(id) {
            if (!confirm('¿Estás seguro de eliminar este usuario? Esta acción no se puede deshacer.')) return;
            try {
                await api.delete(`/users/${id}`);
                showToast('Usuario eliminado');
                loadInitialData();
            } catch (error) {
                showToast(error.message, 'error');
            }
        }

        window.onclick = (e) => {
            if (e.target === document.getElementById('userModal')) closeModal();
        };
    </script>
</body>

</html>