<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <script src="../../../script/api.js"></script>
    <script src="../../../script/utils.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Informe Dimensional - Geoportal Municipal</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Outfit', 'sans-serif'] },
                    colors: { primary: '#6366f1', secondary: '#ec4899', accent: '#8b5cf6' }
                }
            }
        }
    </script>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Highcharts core and advanced modules -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/highcharts.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/highcharts-more.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/heatmap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/treemap.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/sunburst.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/exporting.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/highcharts/11.4.1/modules/accessibility.js"></script>

    <!-- Export Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <link rel="stylesheet" href="styles/admin-styles.css">

    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #8b5cf6 50%, #ec4899 100%);
        }

        body {
            font-family: 'Outfit', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
            min-height: 100vh;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        }

        .header-gradient {
            background: var(--gradient-primary);
            border-radius: 1.5rem;
            padding: 2rem;
            color: white;
            position: relative;
            overflow: hidden;
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px -10px rgba(99, 102, 241, 0.5);
        }

        #chartContainer {
            height: 650px;
            width: 100%;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .dimension-select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            background-color: white;
            transition: all 0.3s ease;
            font-size: 0.875rem;
            font-weight: 500;
            outline: none;
        }

        .dimension-select:focus {
            border-color: #6366f1;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }

        /* Estilos para Checkboxes (igual a informe_dinamico.html) */
        .category-checkbox {
            display: none;
        }

        .category-label {
            display: inline-flex;
            align-items: center;
            padding: 0.5rem 1rem;
            background: #f1f5f9;
            border: 1px solid #e2e8f0;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .category-checkbox:checked+.category-label {
            background: #6366f1;
            border-color: #6366f1;
            color: white;
            box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4);
        }

        .category-label:hover {
            border-color: #6366f1;
        }

        /* Estilos UI para Listas de Filtros Modernos (BI Style) */
        .filter-ribbon {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            align-items: center;
        }

        .filter-pill {
            position: relative;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
            padding: 0.4rem 0.75rem;
            font-size: 0.75rem;
            font-weight: 600;
            color: #475569;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            user-select: none;
            min-width: 120px;
        }

        .filter-pill:hover {
            border-color: #6366f1;
            background: #f8fafc;
        }

        .filter-pill.active {
            background: #eef2ff;
            border-color: #6366f1;
            color: #4f46e5;
        }

        .filter-popover {
            position: absolute;
            top: calc(100% + 5px);
            left: 0;
            width: 240px;
            max-height: 300px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            z-index: 100;
            overflow-y: auto;
            padding: 0.5rem;
            display: none;
        }

        .filter-pill.open .filter-popover {
            display: block;
        }

        .dropdown-arrow {
            font-size: 0.6rem;
            opacity: 0.5;
            margin-left: auto;
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .filter-list {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .filter-item {
            display: flex;
            align-items: flex-start;
            padding: 0.5rem;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            width: 100%;
        }

        .filter-item:hover {
            background-color: #f8fafc;
        }

        .filter-checkbox {
            margin-top: 0.15rem;
            margin-right: 0.75rem;
            accent-color: #6366f1;
            width: 1rem;
            height: 1rem;
            flex-shrink: 0;
        }

        .filter-text {
            font-size: 0.8rem;
            color: #1e293b;
            flex: 1;
            user-select: none;
            line-height: 1.2;
            word-break: break-word;
        }

        th.sortable {
            cursor: pointer;
            transition: background 0.2s;
            position: relative;
            padding-right: 2rem !important;
        }

        th.sortable:hover {
            background-color: #f1f5f9;
        }

        .sort-icon {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.7rem;
            opacity: 0.3;
        }

        th.sort-active .sort-icon {
            opacity: 1;
            color: #6366f1;
        }
    </style>
</head>

<body>
    <div id="headerRender"></div>

    <div class="flex">
        <div id="asideRender"></div>

        <main class="flex-1 p-6">
            <div class="header-gradient mb-8 animate-fade-in">
                <div class="relative z-10 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 bg-white/20 rounded-2xl flex items-center justify-center backdrop-blur">
                            <i class="fas fa-layer-group text-2xl"></i>
                        </div>
                        <div>
                            <h1 class="text-3xl font-bold">Informe Dimensional</h1>
                            <p class="text-white/80">Análisis avanzado cruzando dos variables de gestión</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Barra de Filtros Compacta (BI Ribbon) -->
            <div class="glass-panel rounded-xl p-3 mb-6 animate-fade-in relative z-50">
                <div class="flex flex-wrap items-center justify-between gap-4">
                    <div class="filter-ribbon flex-1" id="filterRibbon">
                        <!-- Filtros Popovers -->
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-layer-group text-indigo-400"></i>
                            <span id="label-area">Área: Todas</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-area"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-route text-indigo-400"></i>
                            <span id="label-lineamiento">Línea: Todos</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-lineamiento"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-money-bill-wave text-indigo-400"></i>
                            <span id="label-financiamiento">Financ.: Todos</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-financiamiento"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-calendar-alt text-indigo-400"></i>
                            <span id="label-anno_elaboracion">Elab.: Todas</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-anno_elaboracion"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-calendar-check text-indigo-400"></i>
                            <span id="label-anno_ejecucion">Ejec.: Todas</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-anno_ejecucion"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-tasks text-indigo-400"></i>
                            <span id="label-estado">Estado: Todos</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-estado"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-step-forward text-indigo-400"></i>
                            <span id="label-etapa">Etapa: Todas</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-etapa"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-clipboard-check text-indigo-400"></i>
                            <span id="label-estado_postulacion">Post.: Todos</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-estado_postulacion"
                                onclick="event.stopPropagation()"></div>
                        </div>
                        <div class="filter-pill" onclick="toggleFilterDropdown(this, event)">
                            <i class="fas fa-user-tie text-indigo-400"></i>
                            <span id="label-profesional">Prof.: Todos</span>
                            <i class="fas fa-chevron-down dropdown-arrow"></i>
                            <div class="filter-popover custom-scrollbar" id="filter-profesional"
                                onclick="event.stopPropagation()"></div>
                        </div>
                    </div>
                    <button onclick="limpiarFiltros()"
                        class="px-4 py-2 bg-red-50 hover:bg-red-100 text-red-600 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                        <i class="fas fa-eraser"></i> Limpiar
                    </button>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-6 mb-8 animate-fade-in">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 items-end">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Dimensión 1
                            (Principal):</label>
                        <select id="groupBy1" onchange="handleGroupByChange()" class="dimension-select">
                            <option value="area_nombre">Área</option>
                            <option value="lineamiento_estrategico_nombre">Lineamiento Estratégico</option>
                            <option value="financiamiento_nombre" selected>Financiamiento</option>
                            <option value="estado_nombre">Estado</option>
                            <option value="etapa_nombre">Etapa</option>
                            <option value="sector_nombre">Sector</option>
                            <option value="anno_ejecucion">Año Ejecución</option>
                            <option value="profesional_1">Profesional Responsable</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Dimensión 2
                            (Sub-variable):</label>
                        <select id="groupBy2" onchange="handleGroupByChange()" class="dimension-select">
                            <option value="area_nombre">Área</option>
                            <option value="lineamiento_estrategico_nombre">Lineamiento Estratégico</option>
                            <option value="financiamiento_nombre">Financiamiento</option>
                            <option value="estado_nombre" selected>Estado</option>
                            <option value="etapa_nombre">Etapa</option>
                            <option value="sector_nombre">Sector</option>
                            <option value="anno_ejecucion">Año Ejecución</option>
                            <option value="profesional_1">Profesional Responsable</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Métrica de Análisis:</label>
                        <select id="metricType" onchange="updateChart()" class="dimension-select">
                            <option value="sum_monto">Inversión Total ($)</option>
                            <option value="count">Cantidad de Proyectos (#)</option>
                            <option value="avg_avance">Avance Físico Promedio (%)</option>
                            <option value="sum_ejecutado">Inversión Ejecutada ($)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Tipo de
                            Visualización:</label>
                        <select id="chartType" onchange="updateChart()" class="dimension-select">
                            <option value="heatmap">Mapa de Calor (Intersección)</option>
                            <option value="stacked_bar">Barras Apiladas</option>
                            <option value="stacked_column">Columnas Apiladas</option>
                            <option value="sunburst">Gráfico Solar (Jerárquico)</option>
                            <option value="treemap_hierarchical">Treemap Jerárquico</option>
                            <option value="bubble">Burbujas Comparativas</option>
                        </select>
                    </div>

                    <div
                        class="lg:col-span-4 flex flex-wrap gap-4 items-center justify-between border-t border-gray-100 pt-6 mt-2">
                        <div class="flex-1 min-w-[300px]">
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">
                                <i class="fas fa-filter mr-2"></i>Filtrar por Dimensión 1:
                            </label>
                            <div id="categoryFilters1" class="flex flex-wrap gap-3 max-h-32 overflow-y-auto p-1 mb-4">
                                <!-- Se llena dinámicamente -->
                            </div>

                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wider mb-3">
                                <i class="fas fa-filter mr-2"></i>Filtrar por Dimensión 2:
                            </label>
                            <div id="categoryFilters2" class="flex flex-wrap gap-3 max-h-32 overflow-y-auto p-1">
                                <!-- Se llena dinámicamente -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="glass-panel rounded-2xl p-8 animate-fade-in relative overflow-hidden">
                <div id="chartContainer" class="mb-10"></div>

                <!-- Tabla de Datos -->
                <div id="dataTable" class="mt-8 border-t border-gray-100 pt-8 hidden">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                            <i class="fas fa-table-list text-indigo-500"></i>
                            Análisis Cruzado de Datos
                        </h3>
                        <div class="flex items-center gap-3">
                            <button onclick="exportTable('csv')"
                                class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                                <i class="fas fa-file-csv text-green-600"></i> CSV
                            </button>
                            <button onclick="exportTable('excel')"
                                class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                                <i class="fas fa-file-excel text-green-700"></i> EXCEL
                            </button>
                            <button onclick="exportTable('pdf')"
                                class="px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg text-xs font-bold transition-all flex items-center gap-2">
                                <i class="fas fa-file-pdf text-red-600"></i> PDF
                            </button>
                        </div>
                    </div>
                    <div class="overflow-x-auto rounded-xl border border-gray-200">
                        <table class="w-full text-sm text-left">
                            <thead class="bg-gray-50 border-b border-gray-200">
                                <tr>
                                    <th class="px-6 py-4 font-bold text-gray-600 uppercase tracking-wider sortable sort-active"
                                        id="th-dim1" onclick="sortTable(0)">
                                        Dimensión 1 <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="px-6 py-4 font-bold text-gray-600 uppercase tracking-wider sortable"
                                        id="th-dim2" onclick="sortTable(1)">
                                        Dimensión 2 <i class="fas fa-sort sort-icon"></i></th>
                                    <th class="px-6 py-4 font-bold text-gray-600 uppercase tracking-wider text-right sortable"
                                        id="th-value" onclick="sortTable(2)">Valor <i class="fas fa-sort sort-icon"></i>
                                    </th>
                                    <th class="px-6 py-4 font-bold text-gray-600 uppercase tracking-wider text-right sortable"
                                        onclick="sortTable(3)">
                                        % Part. <i class="fas fa-sort sort-icon"></i></th>
                                </tr>
                            </thead>
                            <tbody id="tableBody" class="divide-y divide-gray-100 bg-white">
                                <!-- Se llena dinámicamente -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../../../script/layout.js"></script>
    <script>
        let allProjects = [];
        let filteredProjects = [];
        let currentSort = { column: 0, direction: 'asc' };

        const currentFilters = {
            area: [], lineamiento: [], financiamiento: [], anno_elaboracion: [],
            anno_ejecucion: [], estado: [], etapa: [], estado_postulacion: [], profesional: []
        };

        const filterFieldMap = {
            'area': 'area_nombre', 'lineamiento': 'lineamiento_estrategico_nombre',
            'financiamiento': 'financiamiento_nombre', 'anno_elaboracion': 'anno_elaboracion',
            'anno_ejecucion': 'anno_ejecucion', 'estado': 'estado_nombre', 'etapa': 'etapa_nombre',
            'estado_postulacion': 'estado_postulacion_nombre', 'profesional': 'profesional_1'
        };

        async function fetchProjects() {
            try {
                allProjects = await api.get('/proyectos');
                filteredProjects = [...allProjects];
                populateFilters();
                applyFilters();
            } catch (error) {
                console.error('Error:', error);
            }
        }

        function limpiarFiltros() {
            Object.keys(currentFilters).forEach(k => currentFilters[k] = []);
            applyFilters();
        }

        const filterLabels = {
            area: 'Área', lineamiento: 'Línea', financiamiento: 'Financ.',
            anno_elaboracion: 'Elab.', anno_ejecucion: 'Ejec.', estado: 'Estado',
            etapa: 'Etapa', estado_postulacion: 'Post.', profesional: 'Prof.'
        };

        function toggleFilterDropdown(element, event) {
            event.stopPropagation();
            const isOpen = element.classList.contains('open');
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('open'));
            if (!isOpen) element.classList.add('open');
        }

        document.addEventListener('click', () => {
            document.querySelectorAll('.filter-pill').forEach(p => p.classList.remove('open'));
        });

        function populateFilters() {
            for (const [filterKey, dataKey] of Object.entries(filterFieldMap)) {
                const container = document.getElementById(`filter-${filterKey}`);
                const pill = container.parentElement;
                const labelElement = document.getElementById(`label-${filterKey}`);
                const currentVals = [...currentFilters[filterKey]];

                // Actualizar etiqueta del Pill
                if (currentVals.length === 0) {
                    labelElement.textContent = `${filterLabels[filterKey]}: Todas`;
                    pill.classList.remove('active');
                } else {
                    const labelStr = currentVals.length === 1 ? currentVals[0] : `${currentVals.length} sel.`;
                    labelElement.textContent = `${filterLabels[filterKey]}: ${labelStr}`;
                    pill.classList.add('active');
                }

                const otherFiltersActive = { ...currentFilters };
                delete otherFiltersActive[filterKey];

                const availableProjects = allProjects.filter(p => {
                    return Object.entries(otherFiltersActive).every(([fK, fV]) => {
                        if (fV.length === 0) return true;
                        return fV.includes(p[filterFieldMap[fK]]);
                    });
                });

                // Opciones basadas en el dataset completo para evitar bloqueos
                const options = [...new Set(allProjects.map(p => p[dataKey]).filter(v => v))].sort();

                const isAllSelected = currentVals.length === 0;
                let html = `
                    <div class="filter-list p-1">
                        <label class="filter-item ${isAllSelected ? 'bg-indigo-50' : ''} mb-1 border-b pb-1">
                            <input type="checkbox" class="filter-checkbox" value="all" onchange="handleFilterChange('${filterKey}', this)" onclick="event.stopPropagation()" ${isAllSelected ? 'checked' : ''}>
                            <span class="filter-text font-bold text-indigo-700">-- VER TODAS --</span>
                        </label>
                `;

                options.forEach(opt => {
                    const optStr = String(opt);
                    const isSelected = currentVals.map(String).includes(optStr);

                    // Conteo cruzado: Ribbon + Chips Dimensión 1 + Chips Dimensión 2
                    const dim1 = document.getElementById('groupBy1').value;
                    const dim2 = document.getElementById('groupBy2').value;
                    const selectedCats1 = Array.from(document.querySelectorAll('#categoryFilters1 .category-checkbox:checked')).map(cb => cb.value);
                    const selectedCats2 = Array.from(document.querySelectorAll('#categoryFilters2 .category-checkbox:checked')).map(cb => cb.value);

                    const hasData = allProjects.some(p => {
                        const val = String(p[dataKey] || '').trim();
                        if (val !== optStr) return false;

                        const ribbonPass = Object.entries(currentFilters).every(([fK, fV]) => {
                            if (fK === filterKey || fV.length === 0) return true;
                            const projectVal = String(p[filterFieldMap[fK]] || '').trim();
                            return fV.includes(projectVal);
                        });

                        // Validar contra ambas dimensiones de abajo
                        const cat1Pass = selectedCats1.length === 0 || selectedCats1.includes(String(p[dim1] || 'Sin especificar'));
                        const cat2Pass = selectedCats2.length === 0 || selectedCats2.includes(String(p[dim2] || 'Sin especificar'));

                        return ribbonPass && cat1Pass && cat2Pass;
                    });

                    html += `
                        <label class="filter-item ${isSelected ? 'bg-indigo-50/50' : ''} ${!hasData && !isSelected ? 'opacity-40' : ''}">
                            <input type="checkbox" class="filter-checkbox filter-${filterKey}-chk" value="${optStr}" onchange="handleFilterChange('${filterKey}', this)" onclick="event.stopPropagation()" ${isSelected ? 'checked' : ''}>
                            <span class="filter-text">${optStr} ${!hasData && !isSelected ? '<span class="text-[10px] opacity-60">(0)</span>' : ''}</span>
                        </label>
                    `;
                });

                html += '</div>';
                container.innerHTML = html;
            }
        }

        function handleFilterChange(filterType, element) {
            if (event) event.stopPropagation();

            if (element && element.value === 'all') {
                if (element.checked) currentFilters[filterType] = [];
            } else if (element) {
                const val = String(element.value);
                const resultSet = new Set(currentFilters[filterType].map(String));

                if (element.checked) {
                    resultSet.add(val);
                } else {
                    resultSet.delete(val);
                }
                currentFilters[filterType] = Array.from(resultSet);
            }
            applyFilters();
        }

        function applyFilters() {
            filteredProjects = allProjects.filter(p => {
                return Object.entries(currentFilters).every(([fK, fV]) => {
                    if (fV.length === 0) return true;
                    const projectVal = String(p[filterFieldMap[fK]] || '').trim();
                    return fV.includes(projectVal);
                });
            });

            // Ciclo robusto: Actualizamos interfaz inferior primero, luego ribbon superior
            handleGroupByChange();
            populateFilters();
        }

        function handleGroupByChange() {
            if (!filteredProjects || filteredProjects.length === 0) {
                document.getElementById('categoryFilters1').innerHTML = '<p class="text-sm text-gray-500">No hay datos</p>';
                document.getElementById('categoryFilters2').innerHTML = '<p class="text-sm text-gray-500">No hay datos</p>';
                updateChart();
                return;
            }

            const renderCheckboxes = (dimId, containerId) => {
                const groupBy = document.getElementById(dimId).value;
                const categories = [...new Set(allProjects.map(p => String(p[groupBy] || 'Sin especificar')))].sort();
                const container = document.getElementById(containerId);
                container.innerHTML = '';

                categories.forEach((cat, index) => {
                    // Solo mostramos chips con datos bajo filtros ribbon
                    const hasData = filteredProjects.some(p => (p[groupBy] || 'Sin especificar') === cat);
                    if (!hasData) return;

                    const id = `chk-${containerId}-${index}`;
                    const html = `
                        <div>
                            <input type="checkbox" id="${id}" value="${cat}" class="category-checkbox" checked onchange="updateChartAndPills()">
                            <label for="${id}" class="category-label">${cat}</label>
                        </div>
                    `;
                    container.insertAdjacentHTML('beforeend', html);
                });
            };

            renderCheckboxes('groupBy1', 'categoryFilters1');
            renderCheckboxes('groupBy2', 'categoryFilters2');

            updateChart();
        }

        function updateChartAndPills() {
            updateChart();
            populateFilters(); // Cascada inversa: Filtros locales actualizan ribbon global
        }

        function updateChart() {
            if (!filteredProjects || filteredProjects.length === 0) {
                if (window.Highcharts) Highcharts.chart('chartContainer', { title: { text: 'No hay proyectos que coincidan con los filtros' } });
                document.getElementById('dataTable').classList.add('hidden');
                return;
            }

            const getSelectedCheckboxes = (containerId) => {
                const checkboxes = document.querySelectorAll(`#${containerId} .category-checkbox:checked`);
                return Array.from(checkboxes).map(checkbox => checkbox.value);
            };

            const selectedCategories1 = getSelectedCheckboxes('categoryFilters1');
            const selectedCategories2 = getSelectedCheckboxes('categoryFilters2');

            if (selectedCategories1.length === 0 || selectedCategories2.length === 0) {
                if (window.Highcharts) Highcharts.chart('chartContainer', { title: { text: 'Seleccione al menos una categoría en ambas dimensiones para visualizar' } });
                document.getElementById('dataTable').classList.add('hidden');
                return;
            }

            const dim1 = document.getElementById('groupBy1').value;
            const dim2 = document.getElementById('groupBy2').value;
            const metric = document.getElementById('metricType').value;
            const type = document.getElementById('chartType').value;

            const label1 = document.getElementById('groupBy1').options[document.getElementById('groupBy1').selectedIndex].text;
            const label2 = document.getElementById('groupBy2').options[document.getElementById('groupBy2').selectedIndex].text;
            const metricLabel = document.getElementById('metricType').options[document.getElementById('metricType').selectedIndex].text;

            // Procesamiento de datos bidimensionales
            const dataMap = new Map();
            const categories1 = new Set();
            const categories2 = new Set();

            // Filtrado base según las selecciones de checkbox
            const baseData = filteredProjects.filter(p => {
                const val1 = p[dim1] || 'Sin especificar';
                const val2 = p[dim2] || 'Sin especificar';
                return selectedCategories1.includes(val1) && selectedCategories2.includes(val2);
            });

            baseData.forEach(p => {
                const val1 = p[dim1] || 'Sin especificar';
                const val2 = p[dim2] || 'Sin especificar';
                categories1.add(val1);
                categories2.add(val2);

                const key = `${val1}||${val2}`;
                if (!dataMap.has(key)) dataMap.set(key, { count: 0, sum_monto: 0, sum_avance: 0 });

                const monto = parseFloat(p.monto) || 0;
                const avance = parseFloat(p.avance_total_porcentaje) || 0;

                const d = dataMap.get(key);
                d.count++;
                d.sum_monto += monto;
                d.sum_avance += avance;
                d.sum_ejecutado = (d.sum_ejecutado || 0) + (monto * (avance / 100));
            });

            renderMultiChart({
                dataMap,
                cat1: Array.from(categories1).sort(),
                cat2: Array.from(categories2).sort(),
                metric, type, label1, label2, metricLabel
            });

            renderMultiTable({
                dataMap,
                cat1: Array.from(categories1).sort(),
                cat2: Array.from(categories2).sort(),
                metric, label1, label2, metricLabel
            });
        }

        function renderMultiTable(cfg) {
            const { dataMap, cat1, cat2, metric, label1, label2, metricLabel } = cfg;
            const tableDiv = document.getElementById('dataTable');
            const tbody = document.getElementById('tableBody');

            tableDiv.classList.remove('hidden');
            document.getElementById('th-dim1').innerHTML = `${label1.toUpperCase()} <i class="fas fa-sort sort-icon"></i>`;
            document.getElementById('th-dim2').innerHTML = `${label2.toUpperCase()} <i class="fas fa-sort sort-icon"></i>`;
            document.getElementById('th-value').innerHTML = `${metricLabel.toUpperCase()} <i class="fas fa-sort sort-icon"></i>`;

            const isCurrency = metric.includes('monto') || metric.includes('ejecutado');
            const isPercent = metric.includes('avance');

            tbody.innerHTML = '';

            // Calcular Gran Total para participación
            let grandTotal = 0;
            cat1.forEach(v1 => {
                cat2.forEach(v2 => {
                    const d = dataMap.get(`${v1}||${v2}`);
                    if (d && (d.sum_monto > 0 || d.count > 0)) {
                        if (metric === 'sum_monto') grandTotal += d.sum_monto;
                        else if (metric === 'count') grandTotal += d.count;
                        else if (metric === 'avg_avance') grandTotal += (d.sum_avance / d.count);
                        else if (metric === 'sum_ejecutado') grandTotal += d.sum_ejecutado;
                    }
                });
            });

            cat1.forEach(v1 => {
                cat2.forEach(v2 => {
                    const key = `${v1}||${v2}`;
                    const d = dataMap.get(key);

                    if (d && (d.sum_monto > 0 || d.count > 0)) {
                        let value = 0;
                        if (metric === 'sum_monto') value = d.sum_monto;
                        else if (metric === 'count') value = d.count;
                        else if (metric === 'avg_avance') value = d.sum_avance / d.count;
                        else if (metric === 'sum_ejecutado') value = d.sum_ejecutado;

                        const participation = grandTotal > 0 ? (value / grandTotal) * 100 : 0;
                        const row = document.createElement('tr');
                        row.className = 'hover:bg-indigo-50/30 transition-colors';

                        const formattedValue = isCurrency ? formatCurrency(value) : `${value.toLocaleString('es-CL', { maximumFractionDigits: 1 })}${isPercent ? '%' : ''}`;

                        row.innerHTML = `
                            <td class="px-6 py-4 font-medium text-gray-700">${v1}</td>
                            <td class="px-6 py-4 text-gray-600">${v2}</td>
                            <td class="px-6 py-4 text-right font-mono font-bold text-indigo-700">${formattedValue}</td>
                            <td class="px-6 py-4 text-right">
                                <span class="px-2 py-1 bg-indigo-50 text-indigo-700 rounded-md font-bold text-xs">
                                    ${participation.toFixed(1)}%
                                </span>
                            </td>
                        `;
                        tbody.appendChild(row);
                    }
                });
            });

            // Aplicar orden inicial o persistente
            sortTable(currentSort.column, true);
        }

        function sortTable(columnIndex, isInitial = false) {
            const table = document.querySelector('table');
            const tbody = document.getElementById('tableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const ths = table.querySelectorAll('th');

            if (!isInitial) {
                if (currentSort.column === columnIndex) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = columnIndex;
                    currentSort.direction = 'asc';
                }
            }

            // Actualizar UI de encabezados
            ths.forEach((th, idx) => {
                th.classList.remove('sort-active');
                const icon = th.querySelector('.sort-icon');
                if (icon) icon.className = 'fas fa-sort sort-icon';

                if (idx === currentSort.column) {
                    th.classList.add('sort-active');
                    if (icon) {
                        icon.className = currentSort.direction === 'asc' ? 'fas fa-sort-up sort-icon' : 'fas fa-sort-down sort-icon';
                    }
                }
            });

            const sortedRows = rows.sort((a, b) => {
                let cellA = a.cells[columnIndex].textContent.trim();
                let cellB = b.cells[columnIndex].textContent.trim();

                // Limpiar valores para ordenamiento numérico
                const cleanValue = (val) => {
                    if (val.includes('%')) return parseFloat(val.replace('%', ''));
                    if (val.includes('$')) return parseFloat(val.replace(/\$|\./g, '').replace(',', '.'));
                    const num = parseFloat(val.replace(/\./g, '').replace(',', '.'));
                    return isNaN(num) ? val.toLowerCase() : num;
                };

                const valA = cleanValue(cellA);
                const valB = cleanValue(cellB);

                if (typeof valA === 'number' && typeof valB === 'number') {
                    return currentSort.direction === 'asc' ? valA - valB : valB - valA;
                }

                return currentSort.direction === 'asc'
                    ? String(valA).localeCompare(String(valB))
                    : String(valB).localeCompare(String(valA));
            });

            tbody.innerHTML = '';
            sortedRows.forEach(row => tbody.appendChild(row));
        }

        function exportTable(format) {
            const label1 = document.getElementById('groupBy1').options[document.getElementById('groupBy1').selectedIndex].text;
            const label2 = document.getElementById('groupBy2').options[document.getElementById('groupBy2').selectedIndex].text;
            const metric = document.getElementById('metricType').options[document.getElementById('metricType').selectedIndex].text;
            const fileName = `Analisis_Dimensional_${label1}_v_${label2}`;

            const rows = [];
            const headers = [label1, label2, metric, '% Part.'];

            document.querySelectorAll('#tableBody tr').forEach(tr => {
                rows.push(Array.from(tr.querySelectorAll('td')).map(td => td.textContent.trim()));
            });

            if (format === 'csv') {
                let csvContent = headers.join(',') + '\n' + rows.map(r => r.join(',')).join('\n');
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${fileName}.csv`;
                link.click();
            } else if (format === 'excel') {
                const worksheet = XLSX.utils.aoa_to_sheet([headers, ...rows]);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Dimensiones");
                XLSX.writeFile(workbook, `${fileName}.xlsx`);
            } else if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.setFontSize(18);
                doc.text('Análisis Dimensional - Geoportal Municipal', 14, 22);
                doc.setFontSize(11);
                doc.setTextColor(100);
                doc.text(`${metric} por ${label1} y ${label2}`, 14, 30);
                doc.autoTable({
                    head: [headers],
                    body: rows,
                    startY: 35,
                    headStyles: { fillColor: [99, 102, 241] }
                });
                doc.save(`${fileName}.pdf`);
            }
        }

        function renderMultiChart(cfg) {
            const { dataMap, cat1, cat2, metric, type, label1, label2, metricLabel } = cfg;

            let series = [];
            let options = {
                chart: { backgroundColor: 'transparent', style: { fontFamily: 'Outfit' } },
                title: { text: `${metricLabel} por ${label1} y ${label2}`, style: { fontWeight: 'bold' } },
                tooltip: { shared: true }
            };

            const getValue = (v1, v2) => {
                const d = dataMap.get(`${v1}||${v2}`);
                if (!d) return 0;
                if (metric === 'sum_monto') return d.sum_monto;
                if (metric === 'count') return d.count;
                if (metric === 'avg_avance') return d.sum_avance / d.count;
                if (metric === 'sum_ejecutado') return d.sum_ejecutado;
                return 0;
            };

            switch (type) {
                case 'heatmap':
                    const heatData = [];
                    cat1.forEach((v1, i) => {
                        cat2.forEach((v2, j) => {
                            heatData.push([i, j, getValue(v1, v2)]);
                        });
                    });
                    options.chart.type = 'heatmap';
                    options.xAxis = { categories: cat1, title: { text: label1 } };
                    options.yAxis = { categories: cat2, title: { text: label2 }, reversed: true };
                    options.colorAxis = { min: 0, minColor: '#f8fafc', maxColor: '#6366f1' };
                    options.series = [{ name: metricLabel, data: heatData, dataLabels: { enabled: true, color: '#000000', style: { textOutline: 'none', fontSize: '10px' } } }];
                    break;

                case 'stacked_column':
                case 'stacked_bar':
                    options.chart.type = type === 'stacked_column' ? 'column' : 'bar';
                    options.plotOptions = { [options.chart.type]: { stacking: 'normal' } };
                    options.xAxis = { categories: cat1 };
                    series = cat2.map(v2 => ({
                        name: v2,
                        data: cat1.map(v1 => getValue(v1, v2))
                    }));
                    options.series = series;
                    break;

                case 'sunburst':
                    const sunData = [{ id: '0.0', parent: '', name: 'Total' }];
                    cat1.forEach(v1 => {
                        sunData.push({ id: v1, parent: '0.0', name: v1 });
                        cat2.forEach(v2 => {
                            const val = getValue(v1, v2);
                            if (val > 0) {
                                sunData.push({ id: `${v1}-${v2}`, parent: v1, name: v2, value: val });
                            }
                        });
                    });
                    options.series = [{ type: 'sunburst', data: sunData, allowDrillToNode: true, cursor: 'pointer', dataLabels: { format: '{point.name}' } }];
                    break;

                case 'treemap_hierarchical':
                    const treeData = [];
                    cat1.forEach(v1 => {
                        treeData.push({ id: v1, name: v1, color: Highcharts.getOptions().colors[treeData.length % 10] });
                        cat2.forEach(v2 => {
                            const val = getValue(v1, v2);
                            if (val > 0) {
                                treeData.push({ name: v2, parent: v1, value: val });
                            }
                        });
                    });
                    options.series = [{ type: 'treemap', layoutAlgorithm: 'squarified', allowTraversingTree: true, data: treeData }];
                    break;

                case 'bubble':
                    const bubbleData = [];
                    cat1.forEach((v1, i) => {
                        cat2.forEach((v2, j) => {
                            const val = getValue(v1, v2);
                            if (val > 0) bubbleData.push({ x: i, y: j, z: val, name: `${v1} / ${v2}` });
                        });
                    });
                    options.chart.type = 'bubble';
                    options.xAxis = { categories: cat1 };
                    options.yAxis = { categories: cat2 };
                    options.series = [{ data: bubbleData, name: metricLabel }];
                    break;
            }

            Highcharts.chart('chartContainer', options);
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof checkLoginStatus === 'function') checkLoginStatus();
            fetchProjects();
        });
    </script>
</body>

</html>