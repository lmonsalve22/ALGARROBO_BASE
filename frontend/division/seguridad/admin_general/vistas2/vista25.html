<!-- Vista 25: Auditor√≠a de Datos y Calidad ‚Äî STOP + CEAD + Conjunto -->
<div class="card mb-lg">
    <div class="location-source-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 600; letter-spacing: 0.5px;">
            <i class="fa-solid fa-database"></i> <span class="comuna-fill">CARGANDO...</span>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span>AUDITOR√çA DE INTEGRIDAD (STOP + CEAD)</span>
        </div>
        <div id="sourceBadgeContainer"></div>
    </div>

    <div class="question-section"
        style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); 
            border-left: 4px solid var(--color-primary); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
        <h2 style="font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin: 0; letter-spacing: -0.02em;">
            ¬øQu√© tan confiable es la informaci√≥n que estamos viendo?
        </h2>
        <p style="color: var(--color-text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">Evaluaci√≥n de la
            integridad, consistencia y completitud de ambas fuentes de datos (STOP semanal y CEAD mensual) para
            garantizar la validez de los an√°lisis presentados.</p>
    </div>

    <!-- Veredicto General -->
    <div class="alert alert--info" style="margin-top: 1.5rem; margin-bottom: 2rem;">
        <strong>ü§ñ Diagn√≥stico General:</strong> <span id="v25_health_desc">Analizando integridad...</span>
    </div>

    <!-- ‚ïê‚ïê‚ïê PUNTUACI√ìN GLOBAL ‚ïê‚ïê‚ïê -->
    <div
        style="text-align: center; padding: 2rem; background: linear-gradient(135deg, #f8fafc 0%, #eef2ff 100%); border-radius: 12px; border: 1px dashed #cbd5e1; margin-bottom: 2rem;">
        <div
            style="font-size: 0.85rem; font-weight: 700; color: #64748b; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 1px;">
            Puntuaci√≥n General de Salud de Datos</div>
        <div id="v25_health_score" style="font-size: 4.5rem; font-weight: 900; color: #1e293b; line-height: 1;">--%
        </div>
        <div id="v25_health_grade" style="font-size: 0.85rem; font-weight: 700; color: #94a3b8; margin-top: 6px;">-
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SECCI√ìN: STOP (Semanal) ‚ïê‚ïê‚ïê -->
    <div style="margin-bottom: 2.5rem;">
        <div
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.25rem; border-bottom: 2px solid #3b82f6; padding-bottom: 8px;">
            <div style="width: 10px; height: 10px; background: #3b82f6; border-radius: 50%;"></div>
            <h3 style="margin: 0; font-size: 1.05rem; font-weight: 800; color: #1e293b;">Fuente STOP ‚Äî Datos Semanales
            </h3>
            <div id="v25_stop_badge"
                style="margin-left: auto; font-size: 0.75rem; padding: 3px 10px; border-radius: 20px; font-weight: 700; background: #f1f5f9; color: #64748b;">
                ‚Äì</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <!-- STOP: Registros -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #3b82f6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Registros Cargados</div>
                <div id="v25_stop_records" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--</div>
            </div>
            <!-- STOP: Semanas -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #3b82f6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Semanas Cubiertas</div>
                <div id="v25_stop_weeks" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--</div>
            </div>
            <!-- STOP: Delitos √önicos -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #3b82f6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Delitos √önicos</div>
                <div id="v25_stop_crimes" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--</div>
            </div>
            <!-- STOP: Completitud -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #3b82f6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Completitud</div>
                <div id="v25_stop_completion" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--%</div>
            </div>
        </div>

        <!-- STOP: Detalles expandidos -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
            <div class="card" style="padding: 1rem;">
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px;">Semanas Sin Datos
                    (Gaps)</div>
                <div id="v25_stop_gaps" style="font-size: 0.85rem; color: #334155;">Calculando...</div>
            </div>
            <div class="card" style="padding: 1rem;">
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px;">Outliers
                    Detectados (|Z| > 5)</div>
                <div id="v25_stop_outliers" style="font-size: 0.85rem; color: #334155;">Calculando...</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SECCI√ìN: CEAD (Mensual) ‚ïê‚ïê‚ïê -->
    <div style="margin-bottom: 2.5rem;">
        <div
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.25rem; border-bottom: 2px solid #8b5cf6; padding-bottom: 8px;">
            <div style="width: 10px; height: 10px; background: #8b5cf6; border-radius: 50%;"></div>
            <h3 style="margin: 0; font-size: 1.05rem; font-weight: 800; color: #1e293b;">Fuente CEAD ‚Äî Datos Mensuales
            </h3>
            <div id="v25_cead_badge"
                style="margin-left: auto; font-size: 0.75rem; padding: 3px 10px; border-radius: 20px; font-weight: 700; background: #f1f5f9; color: #64748b;">
                ‚Äì</div>
        </div>

        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 1rem;">
            <!-- CEAD: Registros -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #8b5cf6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Registros Cargados</div>
                <div id="v25_cead_records" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--</div>
            </div>
            <!-- CEAD: Periodos -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #8b5cf6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Periodos Cubiertos</div>
                <div id="v25_cead_periods" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--</div>
            </div>
            <!-- CEAD: Delitos √önicos -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #8b5cf6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Delitos √önicos</div>
                <div id="v25_cead_crimes" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--</div>
            </div>
            <!-- CEAD: Completitud -->
            <div class="card" style="padding: 1.25rem; text-align: center; border-left: 3px solid #8b5cf6;">
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Completitud</div>
                <div id="v25_cead_completion" style="font-size: 1.6rem; font-weight: 900; color: #1e293b;">--%</div>
            </div>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1rem;">
            <div class="card" style="padding: 1rem;">
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px;">Meses Sin Datos
                    (Gaps)</div>
                <div id="v25_cead_gaps" style="font-size: 0.85rem; color: #334155;">Calculando...</div>
            </div>
            <div class="card" style="padding: 1rem;">
                <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 6px;">Outliers
                    Detectados (|Z| > 5)</div>
                <div id="v25_cead_outliers" style="font-size: 0.85rem; color: #334155;">Calculando...</div>
            </div>
        </div>
    </div>

    <!-- ‚ïê‚ïê‚ïê SECCI√ìN: CONJUNTO ‚ïê‚ïê‚ïê -->
    <div style="margin-bottom: 2rem;">
        <div
            style="display: flex; align-items: center; gap: 10px; margin-bottom: 1.25rem; border-bottom: 2px solid #0ea5e9; padding-bottom: 8px;">
            <div style="width: 10px; height: 10px; background: #0ea5e9; border-radius: 50%;"></div>
            <h3 style="margin: 0; font-size: 1.05rem; font-weight: 800; color: #1e293b;">Evaluaci√≥n del Conjunto</h3>
        </div>

        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.5rem;">
            <!-- Latencia STOP -->
            <div class="card" style="padding: 1.25rem; text-align: center;">
                <div style="font-size: 2rem; color: #3b82f6; margin-bottom: 8px;"><i class="fa-solid fa-clock"></i>
                </div>
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Latencia STOP</div>
                <div id="v25_lat_stop" style="font-size: 1.4rem; font-weight: 900; color: #1e293b;">-- d√≠as</div>
            </div>
            <!-- Latencia CEAD -->
            <div class="card" style="padding: 1.25rem; text-align: center;">
                <div style="font-size: 2rem; color: #8b5cf6; margin-bottom: 8px;"><i class="fa-solid fa-clock"></i>
                </div>
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Latencia CEAD</div>
                <div id="v25_lat_cead" style="font-size: 1.4rem; font-weight: 900; color: #1e293b;">-- d√≠as</div>
            </div>
            <!-- Cobertura Cruzada -->
            <div class="card" style="padding: 1.25rem; text-align: center;">
                <div style="font-size: 2rem; color: #0ea5e9; margin-bottom: 8px;"><i class="fa-solid fa-link"></i></div>
                <div
                    style="font-size: 0.7rem; font-weight: 600; color: #94a3b8; text-transform: uppercase; margin-bottom: 6px;">
                    Fuentes Activas</div>
                <div id="v25_sources_active" style="font-size: 1.4rem; font-weight: 900; color: #1e293b;">--/2</div>
            </div>
        </div>

        <!-- Tabla resumen comparativa -->
        <div class="card" style="padding: 1.25rem; margin-top: 1rem; overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse; font-size: 0.8rem;">
                <thead>
                    <tr style="border-bottom: 2px solid #e2e8f0;">
                        <th style="text-align: left; padding: 8px 12px; color: #64748b; font-weight: 700;">M√©trica</th>
                        <th style="text-align: center; padding: 8px 12px; color: #3b82f6; font-weight: 700;">STOP</th>
                        <th style="text-align: center; padding: 8px 12px; color: #8b5cf6; font-weight: 700;">CEAD</th>
                        <th style="text-align: center; padding: 8px 12px; color: #0ea5e9; font-weight: 700;">Veredicto
                        </th>
                    </tr>
                </thead>
                <tbody id="v25_summary_table">
                    <tr>
                        <td colspan="4" style="text-align:center; padding: 1.5rem; color: #94a3b8;">Calculando...</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Disclaimer -->
    <div style="padding: 1rem; border-top: 1px solid #e2e8f0; font-size: 0.75rem; color: #94a3b8; font-style: italic;">
        Esta auditor√≠a verifica que los datasets cargados en memoria presenten integridad suficiente para sustentar los
        modelos de tendencia y las comparaciones estad√≠sticas.
        Puntuaciones menores al 70% invalidan las proyecciones de largo plazo.
    </div>
</div>


<!-- Nota Metodol√≥gica -->
<div class="row" style="margin-top: 2rem;">
    <div
        style="background-color: #f8fafc; border-left: 4px solid #cbd5e1; padding: 1rem; border-radius: 4px; color: #64748b; font-size: 0.85rem; line-height: 1.5;">
        <strong>Nota Metodol√≥gica:</strong> La <strong>completitud</strong> se calcula comparando los periodos cargados
        vs. los esperados dentro del rango real del dataset (primera a √∫ltima fecha, no un valor fijo). Los
        <strong>outliers</strong> se detectan mediante Z-Score (|Z| > 5) sobre las series totales. La
        <strong>latencia</strong> indica d√≠as desde el √∫ltimo dato disponible. El <strong>score global</strong> pondera
        35% completitud STOP, 30% completitud CEAD, 20% ausencia de outliers y 15% ausencia de gaps en ambas fuentes.
    </div>
</div>

<script>
    (async function initVista25() {
        // --- Wait for both data sources (tolerant: no reject) ---
        const waitForSources = () => new Promise(resolve => {
            const start = Date.now();
            const check = () => {
                const hasStop = window.STATE_DATA?.isLoaded;
                const hasCead = window.STATE_DATA_CEAD?.isLoaded;
                if (hasStop || hasCead || Date.now() - start > 12000) {
                    resolve({ hasStop, hasCead });
                    return;
                }
                setTimeout(check, 200);
            };
            check();
        });

        const { hasStop, hasCead } = await waitForSources();

        if (!hasStop && !hasCead) {
            document.getElementById('v25_health_desc').textContent = 'No se pudieron cargar datos de ninguna fuente.';
            document.getElementById('v25_health_desc').parentElement.className = 'alert alert--danger';
            return;
        }

        const S_STOP = hasStop ? window.STATE_DATA : null;
        const S_CEAD = hasCead ? window.STATE_DATA_CEAD : null;
        const C = window.COLS || {};
        const C2 = window.COLS_CEAD || {};

        // Fill comuna name
        const comuna = S_STOP?.comunaName || S_CEAD?.comunaName || 'Sin datos';
        document.querySelectorAll('.comuna-fill').forEach(el => el.textContent = comuna);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUDITOR√çA STOP
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let stopScore = 0;
        let stopOutliers = 0;
        let stopGaps = 0;
        let stopLatDays = '--';

        if (hasStop) {
            const rawData = S_STOP.allData || [];
            const totalHist = (S_STOP.allDataHistory_total || []).filter(Boolean);
            const allHist = (S_STOP.allDataHistory || []).filter(Boolean);

            const totalRecords = rawData.length + totalHist.length;
            const idKey = C.ID_SEMANA || 'id_semana';

            // Unique weeks and crimes
            const weekSet = new Set();
            const crimeSet = new Set();
            allHist.forEach(r => {
                if (r[idKey]) weekSet.add(r[idKey]);
                const d = r[C.DELITO || 'delito'];
                if (d && d !== 'Total' && d !== 'TOTAL') crimeSet.add(d);
            });
            totalHist.forEach(r => { if (r[idKey]) weekSet.add(r[idKey]); });

            const numWeeks = weekSet.size;
            const numCrimes = crimeSet.size;

            // Completitud din√°mica: rango real entre primera y √∫ltima semana
            const sortedW = [...weekSet].sort((a, b) => a - b);
            const expectedWeeks = sortedW.length > 1 ? (sortedW[sortedW.length - 1] - sortedW[0] + 1) : Math.max(numWeeks, 1);
            const completionStop = Math.min(100, (numWeeks / expectedWeeks) * 100);

            // Gap detection: consecutive week IDs
            const gaps = [];
            for (let i = 1; i < sortedW.length; i++) {
                const diff = sortedW[i] - sortedW[i - 1];
                if (diff > 1) {
                    const missing = diff - 1;
                    gaps.push(`${missing} sem entre S${sortedW[i - 1]}‚ÄìS${sortedW[i]}`);
                    stopGaps += missing;
                }
            }

            // Outlier detection on total history
            if (totalHist.length > 5) {
                const casosKey = C.CASOS_ACTUAL || 'casos_semana_actual';
                const vals = totalHist.map(r => r[casosKey] || 0);
                const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
                const std = Math.sqrt(vals.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / vals.length);
                if (std > 0) stopOutliers = vals.filter(v => Math.abs((v - mean) / std) > 5).length;
            }

            // Latency
            if (totalHist.length > 0) {
                const lastWeek = totalHist.reduce((max, r) => Math.max(max, r[idKey] || 0), 0);
                const lastRow = totalHist.find(r => r[idKey] === lastWeek);
                if (lastRow) {
                    const yr = lastRow['a√±o'] || lastRow.anio;
                    const wk = lastRow['semana_numero'];
                    if (yr && wk) {
                        // Approximate: week * 7 days from Jan 1
                        const approxDate = new Date(yr, 0, 1 + (wk - 1) * 7);
                        stopLatDays = Math.max(0, Math.floor((Date.now() - approxDate) / 86400000));
                    }
                }
            }

            stopScore = completionStop;

            // Render STOP
            document.getElementById('v25_stop_records').textContent = totalRecords.toLocaleString();
            document.getElementById('v25_stop_weeks').textContent = numWeeks;
            document.getElementById('v25_stop_crimes').textContent = numCrimes;
            document.getElementById('v25_stop_completion').textContent = completionStop.toFixed(0) + '%';
            document.getElementById('v25_stop_completion').style.color = completionStop > 85 ? '#10b981' : completionStop > 60 ? '#f59e0b' : '#ef4444';
            document.getElementById('v25_stop_gaps').innerHTML = stopGaps === 0
                ? '<span style="color:#10b981; font-weight:700;">0 gaps ‚Äî Serie continua ‚úì</span>'
                : `<span style="color:#f59e0b; font-weight:700;">${stopGaps} semanas faltantes</span><br><span style="font-size:0.75rem;color:#94a3b8;">${gaps.slice(0, 3).join(' ¬∑ ')}${gaps.length > 3 ? ' ‚Ä¶' : ''}</span>`;
            document.getElementById('v25_stop_outliers').innerHTML = stopOutliers === 0
                ? '<span style="color:#10b981; font-weight:700;">0 ‚Äî Sin anomal√≠as ‚úì</span>'
                : `<span style="color:#f59e0b; font-weight:700;">${stopOutliers} valores extremos</span>`;

            const stopBadge = document.getElementById('v25_stop_badge');
            stopBadge.textContent = completionStop > 85 ? '‚úì SALUDABLE' : completionStop > 60 ? '‚ö† PARCIAL' : '‚úó DEGRADADO';
            stopBadge.style.background = completionStop > 85 ? '#dcfce7' : completionStop > 60 ? '#fef3c7' : '#fee2e2';
            stopBadge.style.color = completionStop > 85 ? '#16a34a' : completionStop > 60 ? '#d97706' : '#dc2626';
        } else {
            document.getElementById('v25_stop_records').textContent = 'N/D';
            document.getElementById('v25_stop_weeks').textContent = 'N/D';
            document.getElementById('v25_stop_crimes').textContent = 'N/D';
            document.getElementById('v25_stop_completion').textContent = '0%';
            document.getElementById('v25_stop_completion').style.color = '#ef4444';
            document.getElementById('v25_stop_gaps').innerHTML = '<span style="color:#ef4444;">Fuente no disponible</span>';
            document.getElementById('v25_stop_outliers').innerHTML = '<span style="color:#ef4444;">Fuente no disponible</span>';
            document.getElementById('v25_stop_badge').textContent = '‚úó SIN DATOS';
            document.getElementById('v25_stop_badge').style.background = '#fee2e2';
            document.getElementById('v25_stop_badge').style.color = '#dc2626';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // AUDITOR√çA CEAD
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        let ceadScore = 0;
        let ceadOutliers = 0;
        let ceadGaps = 0;
        let ceadLatDays = '--';

        if (hasCead) {
            const allHist = (S_CEAD.allDataHistory || []).filter(Boolean);
            const totalHist = (S_CEAD.allDataHistory_total || []).filter(Boolean);
            const totalRecords = allHist.length + totalHist.length;

            const idKey = C2.ID_PERIODO || 'id_periodo';
            const casosKey = C2.CASOS_ACTUAL || 'frecuencia';

            const periodSet = new Set();
            const crimeSetC = new Set();
            allHist.forEach(r => {
                if (r[idKey]) periodSet.add(r[idKey]);
                const d = r[C2.DELITO || 'delito'];
                if (d && d !== 'Total' && d !== 'TOTAL') crimeSetC.add(d);
            });
            totalHist.forEach(r => { if (r[idKey]) periodSet.add(r[idKey]); });

            const numPeriods = periodSet.size;
            const numCrimesC = crimeSetC.size;

            // Completitud din√°mica: meses entre primer y √∫ltimo periodo real
            const sortedP = [...periodSet].sort((a, b) => a - b);
            const firstP = sortedP[0], lastP = sortedP[sortedP.length - 1];
            const expectedPeriods = sortedP.length > 1
                ? (Math.floor(lastP / 100) - Math.floor(firstP / 100)) * 12 + (lastP % 100 - firstP % 100) + 1
                : Math.max(numPeriods, 1);
            const completionCead = Math.min(100, (numPeriods / expectedPeriods) * 100);

            // Gap detection (YYYYMM) ‚Äî reuses sortedP from completitud
            const gaps = [];
            for (let i = 1; i < sortedP.length; i++) {
                const prev = sortedP[i - 1];
                const curr = sortedP[i];
                const prevY = Math.floor(prev / 100), prevM = prev % 100;
                const currY = Math.floor(curr / 100), currM = curr % 100;
                const diffMonths = (currY - prevY) * 12 + (currM - prevM);
                if (diffMonths > 1) {
                    const missing = diffMonths - 1;
                    gaps.push(`${missing}m entre ${prev}‚Äì${curr}`);
                    ceadGaps += missing;
                }
            }

            // Outlier detection
            if (totalHist.length > 5) {
                const vals = totalHist.map(r => r[casosKey] || 0);
                const mean = vals.reduce((a, b) => a + b, 0) / vals.length;
                const std = Math.sqrt(vals.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / vals.length);
                if (std > 0) ceadOutliers = vals.filter(v => Math.abs((v - mean) / std) > 5).length;
            }

            // Latency ‚Äî uses lastP from completitud block (already declared)
            if (sortedP.length > 0) {
                const yr = Math.floor(lastP / 100);
                const mo = lastP % 100;
                const lastDate = new Date(yr, mo - 1, 1);
                ceadLatDays = Math.max(0, Math.floor((Date.now() - lastDate) / 86400000));
            }

            ceadScore = completionCead;

            // Render CEAD
            document.getElementById('v25_cead_records').textContent = totalRecords.toLocaleString();
            document.getElementById('v25_cead_periods').textContent = numPeriods;
            document.getElementById('v25_cead_crimes').textContent = numCrimesC;
            document.getElementById('v25_cead_completion').textContent = completionCead.toFixed(0) + '%';
            document.getElementById('v25_cead_completion').style.color = completionCead > 85 ? '#10b981' : completionCead > 60 ? '#f59e0b' : '#ef4444';
            document.getElementById('v25_cead_gaps').innerHTML = ceadGaps === 0
                ? '<span style="color:#10b981; font-weight:700;">0 gaps ‚Äî Serie continua ‚úì</span>'
                : `<span style="color:#f59e0b; font-weight:700;">${ceadGaps} meses faltantes</span><br><span style="font-size:0.75rem;color:#94a3b8;">${gaps.slice(0, 3).join(' ¬∑ ')}${gaps.length > 3 ? ' ‚Ä¶' : ''}</span>`;
            document.getElementById('v25_cead_outliers').innerHTML = ceadOutliers === 0
                ? '<span style="color:#10b981; font-weight:700;">0 ‚Äî Sin anomal√≠as ‚úì</span>'
                : `<span style="color:#f59e0b; font-weight:700;">${ceadOutliers} valores extremos</span>`;

            const ceadBdg = document.getElementById('v25_cead_badge');
            ceadBdg.textContent = completionCead > 85 ? '‚úì SALUDABLE' : completionCead > 60 ? '‚ö† PARCIAL' : '‚úó DEGRADADO';
            ceadBdg.style.background = completionCead > 85 ? '#dcfce7' : completionCead > 60 ? '#fef3c7' : '#fee2e2';
            ceadBdg.style.color = completionCead > 85 ? '#16a34a' : completionCead > 60 ? '#d97706' : '#dc2626';
        } else {
            document.getElementById('v25_cead_records').textContent = 'N/D';
            document.getElementById('v25_cead_periods').textContent = 'N/D';
            document.getElementById('v25_cead_crimes').textContent = 'N/D';
            document.getElementById('v25_cead_completion').textContent = '0%';
            document.getElementById('v25_cead_completion').style.color = '#ef4444';
            document.getElementById('v25_cead_gaps').innerHTML = '<span style="color:#ef4444;">Fuente no disponible</span>';
            document.getElementById('v25_cead_outliers').innerHTML = '<span style="color:#ef4444;">Fuente no disponible</span>';
            document.getElementById('v25_cead_badge').textContent = '‚úó SIN DATOS';
            document.getElementById('v25_cead_badge').style.background = '#fee2e2';
            document.getElementById('v25_cead_badge').style.color = '#dc2626';
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // EVALUACI√ìN DEL CONJUNTO
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        const activeSources = (hasStop ? 1 : 0) + (hasCead ? 1 : 0);
        document.getElementById('v25_sources_active').textContent = `${activeSources}/2`;
        document.getElementById('v25_sources_active').style.color = activeSources === 2 ? '#10b981' : '#f59e0b';

        document.getElementById('v25_lat_stop').textContent = hasStop ? `${stopLatDays} d√≠as` : 'N/D';
        document.getElementById('v25_lat_stop').style.color = (typeof stopLatDays === 'number' && stopLatDays < 15) ? '#10b981' : '#f59e0b';
        document.getElementById('v25_lat_cead').textContent = hasCead ? `${ceadLatDays} d√≠as` : 'N/D';
        document.getElementById('v25_lat_cead').style.color = (typeof ceadLatDays === 'number' && ceadLatDays < 45) ? '#10b981' : '#f59e0b';

        // Health Score: 35% STOP + 30% CEAD + 20% outlier penalty + 15% gap penalty
        const totalOutliers = stopOutliers + ceadOutliers;
        const totalGaps = stopGaps + ceadGaps;
        const outlierPenalty = Math.max(0, 100 - totalOutliers * 10);
        const gapPenalty = Math.max(0, 100 - totalGaps * 3);
        let health = (stopScore * 0.35) + (ceadScore * 0.30) + (outlierPenalty * 0.20) + (gapPenalty * 0.15);
        health = Math.min(100, Math.max(0, health));

        const hEl = document.getElementById('v25_health_score');
        hEl.textContent = `${health.toFixed(0)}%`;
        hEl.style.color = health > 90 ? '#10b981' : health > 70 ? '#f59e0b' : '#ef4444';

        const gradeEl = document.getElementById('v25_health_grade');
        if (health > 90) gradeEl.textContent = 'GRADO A ‚Äî Excelente';
        else if (health > 80) gradeEl.textContent = 'GRADO B ‚Äî Bueno';
        else if (health > 70) gradeEl.textContent = 'GRADO C ‚Äî Aceptable';
        else if (health > 50) gradeEl.textContent = 'GRADO D ‚Äî Deficiente';
        else gradeEl.textContent = 'GRADO F ‚Äî Cr√≠tico';
        gradeEl.style.color = hEl.style.color;

        // Summary table
        const verdict = (val, good, warn) => {
            if (typeof val !== 'number') return '<span style="color:#94a3b8;">N/D</span>';
            if (val >= good) return `<span style="color:#10b981; font-weight:700;">‚úì</span>`;
            if (val >= warn) return `<span style="color:#f59e0b; font-weight:700;">‚ö†</span>`;
            return `<span style="color:#ef4444; font-weight:700;">‚úó</span>`;
        };
        const fmt = (v) => typeof v === 'number' ? v.toFixed(0) + '%' : 'N/D';
        const fmtN = (v) => typeof v === 'number' ? v : 'N/D';

        const rows = [
            ['Completitud', fmt(stopScore), fmt(ceadScore), verdict((stopScore + ceadScore) / 2, 85, 60)],
            ['Outliers', fmtN(stopOutliers), fmtN(ceadOutliers), verdict(100 - totalOutliers * 10, 90, 70)],
            ['Gaps (periodos sin datos)', fmtN(stopGaps), fmtN(ceadGaps), verdict(100 - (stopGaps + ceadGaps) * 2, 90, 70)],
            ['Latencia (d√≠as)', fmtN(stopLatDays), fmtN(ceadLatDays), verdict(typeof stopLatDays === 'number' ? 100 - stopLatDays : 0, 85, 50)],
        ];

        document.getElementById('v25_summary_table').innerHTML = rows.map(([label, vStop, vCead, verd]) => `
            <tr style="border-bottom: 1px solid #f1f5f9;">
                <td style="padding: 8px 12px; font-weight: 600; color: #334155;">${label}</td>
                <td style="padding: 8px 12px; text-align: center; color: #334155;">${vStop}</td>
                <td style="padding: 8px 12px; text-align: center; color: #334155;">${vCead}</td>
                <td style="padding: 8px 12px; text-align: center;">${verd}</td>
            </tr>
        `).join('');

        // Diagnostic text
        const desc = document.getElementById('v25_health_desc');
        if (health > 90) {
            desc.textContent = `Ambas fuentes presentan integridad excepcional (${activeSources}/2 activas, ${totalOutliers} outliers). Los modelos predictivos operan con m√°xima confianza estad√≠stica.`;
            desc.parentElement.className = 'alert alert--success';
        } else if (health > 70) {
            desc.textContent = `Integridad aceptable (${activeSources}/2 fuentes, ${stopGaps + ceadGaps} gaps, ${totalOutliers} outliers). Precisi√≥n marginal reducida en proyecciones largas.`;
            desc.parentElement.className = 'alert alert--warning';
        } else {
            desc.textContent = `Integridad comprometida. ${!hasStop ? 'STOP no disponible. ' : ''}${!hasCead ? 'CEAD no disponible. ' : ''}${totalOutliers} outliers y ${stopGaps + ceadGaps} gaps detectados. Cautela en interpretaci√≥n de modelos.`;
            desc.parentElement.className = 'alert alert--danger';
        }

        // IA Integration
        if (typeof IAModule !== 'undefined') {
            IAModule.getInterpretation('vista25').then(txt => {
                const el = document.getElementById('v25_ia_analysis');
                if (el) el.innerHTML = txt;
            });
        }
    })();
</script>