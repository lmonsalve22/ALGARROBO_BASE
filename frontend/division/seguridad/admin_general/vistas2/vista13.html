<!-- Vista 13: Cl√∫ster de Comunas Similares -->
<div class="card mb-lg">
    <div class="location-source-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 600; letter-spacing: 0.5px;">
            <i class="fa-solid fa-users-rays"></i> <span class="comuna-fill">CARGANDO...</span>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span>CL√öSTER SOCIO-DEMOGR√ÅFICO</span>
        </div>
        <div id="sourceBadgeContainer"></div>
    </div>

    <div class="question-section"
        style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); 
            border-left: 4px solid var(--color-primary); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
        <h2 style="font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin: 0; letter-spacing: -0.02em;">
            ¬øC√≥mo nos comparamos con comunas similares?
        </h2>
        <p style="color: var(--color-text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">
            An√°lisis de desempe√±o relativo frente a comunas "gemelas" agrupadas por rango poblacional y perfil
            socioecon√≥mico para una evaluaci√≥n justa del desempe√±o.
            <span
                style="display:block; margin-top:5px; font-weight:700; color:var(--color-primary); font-size:0.85rem;">
                <i class="fa-regular fa-calendar"></i> <span id="v13_date_display">--</span>
            </span>
        </p>
    </div>

    <div class="alert alert--info" style="margin-top: 1.5rem;">
        <strong>ü§ñ An√°lisis de Situaci√≥n:</strong> <span id="v13_ia_analysis">Cargando an√°lisis...</span>
    </div>

    <!-- Cluster Performance KPIs -->
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1.25rem; margin-bottom: 2rem;">
        <div class="card" style="padding: 1.5rem; border-bottom: 4px solid #4f46e5;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px;">CL√öSTER POBLACIONAL
            </div>
            <div id="v13_cluster_name" style="font-size: 1.1rem; font-weight: 800; color: #1e293b;">Rango: -- a -- hab.
            </div>
        </div>
        <div class="card" style="padding: 1.5rem; border-bottom: 4px solid #4f46e5;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px;">POSICI√ìN EN CL√öSTER
            </div>
            <div id="v13_cluster_rank" style="font-size: 1.5rem; font-weight: 900; color: #1e293b;">-- de --
            </div>
        </div>
        <div class="card" style="padding: 1.5rem; border-bottom: 4px solid #4f46e5;">
            <div style="font-size: 0.75rem; font-weight: 700; color: #64748b; margin-bottom: 5px;">ESTADO VS CL√öSTER
            </div>
            <div id="v13_cluster_status" style="font-size: 1.1rem; font-weight: 800; color: #1e293b;">
                Calculando...
            </div>
        </div>
    </div>

    <!-- Temporal Comparisons Title -->
    <div
        style="font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 0.1em; margin-bottom: 0.75rem; border-bottom: 1px solid #f1f5f9; padding-bottom: 4px;">
        <i class="fa-solid fa-clock-rotate-left"></i> Referencial Temporal en Cl√∫ster
    </div>
    <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 0.8rem; margin-bottom: 2rem;">
        <div id="v13_rank_prev_container" class="card" style="transition: all 0.3s ease;"></div>
        <div id="v13_rank_lastyear_container" class="card" style="transition: all 0.3s ease;"></div>
        <div id="v13_rank_acum_container" class="card" style="transition: all 0.3s ease;"></div>
    </div>

    <!-- Ranking Evolution Chart -->
    <div class="card chart-card" style="padding: 1.5rem; margin-bottom: 2rem;">
        <h3 class="section-title mb-lg"
            style="font-size: 1rem; color: #1e293b; display: flex; justify-content: space-between;">
            <span><i class="fa-solid fa-arrow-trend-up" style="color: #4f46e5;"></i> Evoluci√≥n de Posici√≥n en el
                Cl√∫ster</span>
            <div style="font-size: 0.75rem; color: #64748b; font-weight: 600;">Hist√≥rico 12 Semanas (Rank 1 = Mayor
                Tasa)</div>
        </h3>
        <div class="chart-wrapper" style="height: 380px;">
            <canvas id="v13_chart_rank_history"></canvas>
        </div>
    </div>

    <!-- Cluster Historical Matrix -->
    <div class="card atomic-block" style="padding: 1.5rem; margin-bottom: 2rem;">
        <h4
            style="margin: 0 0 1.25rem 0; font-size: 0.9rem; font-weight: 800; color: #1e293b; border-bottom: 1px solid #f1f5f9; padding-bottom: 8px; display:flex; justify-content: space-between;">
            <span>Matriz de Riesgo Hist√≥rica (Ranking Cl√∫ster)</span>
            <span style="font-size: 0.7rem; font-weight: 600; color: #64748b;">COLOR = POSICI√ìN EN
                CL√öSTER</span>
        </h4>
        <div id="v13_heatmap_years" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
            <!-- Filled by JS -->
        </div>
    </div>

    <!-- Nota Metodol√≥gica Estandarizada -->
    <div class="row" style="margin-top: 2rem;">
        <div
            style="background-color: #f8fafc; border-left: 4px solid #cbd5e1; padding: 1.25rem; border-radius: 4px; color: #64748b; font-size: 0.85rem; line-height: 1.6;">
            <strong>Nota Metodol√≥gica:</strong> El an√°lisis por <strong>Cl√∫ster</strong> constituye el est√°ndar superior
            de evaluaci√≥n institucional, superando el sesgo poblacional de las comparativas regionales tradicionales. Al
            agrupar las comunas seg√∫n tramos de poblaci√≥n similares, este modelo normaliza variables cr√≠ticas como
            presupuestos operativos, infraestructura urbana y desaf√≠os estructurales compartidos. Estar en los √∫ltimos
            lugares del cl√∫ster indica una brecha de gesti√≥n relativa que no puede atribuirse al contexto pa√≠s, ya que
            sus pares enfrentan desaf√≠os similares. Esta vista permite evaluar si los patrones son estacionales o
            sist√©micos dentro de su grupo par.
        </div>
    </div>

    <script>
        (async function initVista13_V2() {
            const waitForData = () => {
                return new Promise((resolve) => {
                    const check = () => {
                        if (window.STATE_DATA && window.STATE_DATA.isLoaded) resolve();
                        else setTimeout(check, 100);
                    };
                    check();
                });
            };

            await waitForData();
            const S = window.STATE_DATA;
            const C = window.COLS;

            document.querySelectorAll('.comuna-fill').forEach(el => el.textContent = S.comunaName);

            // Date Display
            const dateEl = document.getElementById('v13_date_display');
            if (dateEl) {
                const d = S.semanaDetalle || `Semana ${S.currentSemana}`;
                const y = S.allDataHistory_total.find(r => r[C.ID_SEMANA] === S.currentSemana)?.[C.ANIO] || new Date().getFullYear();
                dateEl.textContent = `${d} (${y})`;
            }

            // Cluster and Population Logic
            const factorPob = S.allDataHistory.find(r => r[C.ID_SEMANA] === S.currentSemana)?.[C.FACTOR_POBLACION] || 2.5;
            const poblacion = Math.round(factorPob * 100000);

            // Define Cluster (User Request Step 835)
            // Try to get from data, else calc
            const currentRow = S.allDataHistory_total.find(r => r[C.ID_SEMANA] === S.currentSemana) || {};
            let clusterText = currentRow[C.CLASE_POBLACION];

            if (!clusterText) {
                if (poblacion > 100000) clusterText = 'M√°s de 100.000';
                else if (poblacion >= 50000) clusterText = 'Entre 50.000 y 100.000';
                else if (poblacion >= 20000) clusterText = 'Entre 20.000 y 50.000';
                else if (poblacion >= 5000) clusterText = 'Entre 5.000 y 20.000';
                else if (poblacion >= 1000) clusterText = 'Entre 1.000 y 5.000';
                else clusterText = 'Menos de 1.000';
            }

            document.getElementById('v13_cluster_name').textContent = clusterText;

            // Map back to ranges for Chart Axis
            let low = 0, high = 2000000;
            switch (clusterText) {
                case 'M√°s de 100.000': low = 100000; high = Math.max(2000000, poblacion * 1.5); break; // Santiago!
                case 'Entre 50.000 y 100.000': low = 50000; high = 100000; break;
                case 'Entre 20.000 y 50.000': low = 20000; high = 50000; break;
                case 'Entre 5.000 y 20.000': low = 5000; high = 20000; break;
                case 'Entre 1.000 y 5.000': low = 1000; high = 5000; break;
                case 'Menos de 1.000': low = 0; high = 1000; break;
                default: low = 0; high = 100000; // Fallback
            }

            // Mock Cluster Rank (Using RANK_CLUSTER_PROY if Available)
            const totalRow = S.allDataHistory_total.find(r => r[C.ID_SEMANA] === S.currentSemana) || {};

            console.log("üõ†Ô∏è [V13 Debug] Mapping C.RANK_CLUSTER_SEM:", C.RANK_CLUSTER_SEM);
            console.log("üõ†Ô∏è [V13 Debug] Valor en totalRow:", totalRow[C.RANK_CLUSTER_SEM]);

            let rawRank = totalRow[C.RANK_CLUSTER_SEM];
            let cRank = (rawRank === 999 || !rawRank) ? '--' : rawRank;

            // Dynamic look-up for Cluster Total from Config
            const clusterTotals = S.clusterConfig || {};
            const cTotal = clusterTotals[clusterText] || 30; // Fallback to 30 if key missing

            console.log("üõ†Ô∏è [V13 Debug] Cluster:", clusterText, "| Total en Config:", cTotal);

            document.getElementById('v13_cluster_rank').textContent = cRank === '--' ? '--' : `${cRank} de ${cTotal}`;

            const statusEl = document.getElementById('v13_cluster_status');
            if (cRank === '--') {
                statusEl.textContent = 'SIN DATOS';
                statusEl.style.color = '#94a3b8';
            } else {
                const cPct = cRank / cTotal;
                if (cPct < 0.3) { statusEl.textContent = 'PEOR DEL CL√öSTER'; statusEl.style.color = '#ef4444'; }
                else if (cPct > 0.7) { statusEl.textContent = 'L√çDER DE SEGURIDAD'; statusEl.style.color = '#10b981'; }
                else { statusEl.textContent = 'DESEMPE√ëO PROMEDIO'; statusEl.style.color = '#64748b'; }
            }

            // --- Temporal Logic Implementation ---
            // Prev Week
            const prevRow = S.allDataHistory_total.find(r => r[C.ID_SEMANA] === (S.currentSemana - 1));
            const rawRankPrev = prevRow ? prevRow[C.RANK_CLUSTER_SEM] : null;
            const rankPrev = (rawRankPrev === 999 || !rawRankPrev) ? '--' : rawRankPrev;

            // Last Year
            const currentYear = totalRow[C.ANIO];
            const currentWeekNum = totalRow[C.SEMANA_ANO];
            const lastYearRow = S.allDataHistory_total.find(r => r[C.ANIO] == (currentYear - 1) && r[C.SEMANA_ANO] == currentWeekNum);
            const rawRankLY = lastYearRow ? lastYearRow[C.RANK_CLUSTER_SEM] : null;
            const rankLastYear = (rawRankLY === 999 || !rawRankLY) ? '--' : rawRankLY;

            // Acumulado
            const rankAcum = totalRow[C.RANK_CLUSTER_ACUM] || '--';

            const renderRefCardV13 = (id, label, pastRank, currentRank, icon, tooltip) => {
                const el = document.getElementById(id);
                if (!el) return;

                const isDataReady = pastRank !== '--' && currentRank !== '--' && pastRank !== null;
                const diff = isDataReady ? (currentRank - pastRank) : 0; // Rank 1 = Worst. 5 -> 10 = Improvement. 10 - 5 = +5.

                let color = '#94a3b8';
                let bg = '#f8fafc';
                let labelStatus = 'ESTABLE';
                let iconStatus = 'fa-minus';

                if (!isDataReady) {
                    labelStatus = 'SIN DATOS';
                } else if (diff > 0) { // Moving away from Rank 1 (e.g. 5 to 10)
                    color = '#10b981';
                    bg = '#f0fdf4';
                    labelStatus = `MEJORA +${diff}`;
                    iconStatus = 'fa-arrow-up';
                } else if (diff < 0) { // Moving towards Rank 1 (e.g. 10 to 5)
                    color = '#ef4444';
                    bg = '#fef2f2';
                    labelStatus = `DETERIORO ${Math.abs(diff)}`;
                    iconStatus = 'fa-arrow-down';
                }

                el.title = tooltip;
                el.style.borderTop = `4px solid ${color}`;
                el.style.background = bg;
                el.style.padding = '1rem';
                el.style.display = 'flex';
                el.style.flexDirection = 'column';
                el.style.alignItems = 'center';
                el.style.gap = '8px';

                el.innerHTML = `
                    <div style="font-size: 0.65rem; font-weight: 800; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">
                        <i class="fa-solid ${icon}"></i> ${label}
                    </div>
                    <div style="display: flex; align-items: center; justify-content: center; gap: 10px; margin: 2px 0;">
                        <div style="text-align: center;">
                            <span style="display: block; font-size: 0.55rem; color: #94a3b8; font-weight: 700;">ANTES</span>
                            <span style="font-size: 0.9rem; color: #94a3b8; font-weight: 600;">${pastRank}${isDataReady ? '¬∞' : ''}</span>
                        </div>
                        <i class="fa-solid fa-right-long" style="color: #cbd5e1; font-size: 0.8rem; margin-top: 8px;"></i>
                        <div style="text-align: center;">
                            <span style="display: block; font-size: 0.55rem; color: var(--color-primary); font-weight: 700;">HOY</span>
                            <span style="font-size: 1.4rem; color: #1e293b; font-weight: 900; line-height: 1;">${currentRank}¬∞</span>
                        </div>
                    </div>
                    <div style="background: ${color}; color: white;     font-size: 0.6rem; font-weight: 800; padding: 3px 10px; border-radius: 20px; display: inline-flex; align-items: center; justify-content: center; gap: 4px; white-space: nowrap; box-shadow: 0 1px 2px rgba(0,0,0,0.1); letter-spacing: 0.02em;">
                        <i class="fa-solid ${iconStatus}"></i> ${labelStatus}
                    </div>
                `;
            };

            renderRefCardV13('v13_rank_prev_container', 'Semana Anterior', rankPrev, cRank, 'fa-clock', 'Cambio respecto a la semana pasada en el cl√∫ster');
            renderRefCardV13('v13_rank_lastyear_container', 'Misma Sem. A√±o Ant.', rankLastYear, cRank, 'fa-calendar-check', 'Comparaci√≥n con el cl√∫ster en el mismo periodo del a√±o anterior');
            renderRefCardV13('v13_rank_acum_container', 'Posici√≥n Acumulada', rankAcum, cRank, 'fa-layer-group', 'Posici√≥n seg√∫n total acumulado anual del cl√∫ster');


            // --- Rank History Chart (User Request Change) ---
            // Get last 12 weeks of ranking
            const last12 = S.allDataHistory_total
                .filter(r => r[C.ID_SEMANA] <= S.currentSemana && r[C.ID_SEMANA] > (S.currentSemana - 12))
                .sort((a, b) => a[C.ID_SEMANA] - b[C.ID_SEMANA]);

            const labels = last12.map(r => `Semana ${r[C.SEMANA]}/${r[C.ANIO]}`);
            const dataRank = last12.map(r => {
                const rVal = r[C.RANK_CLUSTER_SEM];
                return (rVal === 999 || !rVal) ? null : rVal;
            });

            const ctx = document.getElementById('v13_chart_rank_history').getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Ranking (1 = Mayor Riesgo)',
                            data: dataRank,
                            backgroundColor: 'rgba(79, 70, 229, 0.1)',
                            borderColor: '#4f46e5',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#4f46e5',
                            pointRadius: 5,
                            fill: true,
                            tension: 0.3
                        }
                    ]
                },
                plugins: [ChartDataLabels], // Necessary for Chart.js v3+
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: { padding: { top: 25, right: 10 } },
                    scales: {
                        y: {
                            reverse: true, // Rank 1 at Top
                            min: 1,
                            max: cTotal,
                            title: { display: true, text: 'Posici√≥n Ranking', font: { weight: 'bold' } },
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                stepSize: Math.ceil(cTotal / 10),
                                callback: (v) => `${v}¬∞`
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        datalabels: {
                            display: true,
                            align: 'top',
                            offset: 4,
                            backgroundColor: '#fff',
                            borderRadius: 4,
                            color: '#4f46e5',
                            font: { size: 10, weight: 'bold' },
                            formatter: (v) => v ? `${v}¬∞` : '',
                            padding: 2
                        },
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (c) => `Posici√≥n: ${c.raw} de ${cTotal}`
                            }
                        }
                    }
                }
            });

            // --- Historical Matrix (Cluster Trajectory) ---
            const years = [...new Set(S.allDataHistory_total.map(r => r[C.ANIO]))].sort();
            const heatmap = document.getElementById('v13_heatmap_years');

            let lastAvg = null;
            heatmap.innerHTML = years.map(yr => {
                const rows = S.allDataHistory_total.filter(r => r[C.ANIO] === yr);
                if (rows.length === 0) return '';

                const values = rows.map(r => r[C.RANK_CLUSTER_SEM]).filter(v => v !== 999 && v > 0);
                if (values.length === 0) return '';

                const sum = values.reduce((a, b) => a + b, 0);
                const avgRank = Math.round(sum / values.length);

                // Delta Logic: Green if Improved (Rank Number Increases), Red if Deteriorated (Rank Number Decreases)
                let color = '#94a3b8'; // Neutral gray for first year or no change
                let trendIcon = '';

                if (lastAvg !== null) {
                    if (avgRank > lastAvg) {
                        color = '#10b981'; // Improved (Green)
                        trendIcon = '<i class="fa-solid fa-caret-up" style="position: absolute; top: -5px; right: -5px; color: #059669; font-size: 0.85rem; text-shadow: 0 0 4px white;"></i>';
                    } else if (avgRank < lastAvg) {
                        color = '#ef4444'; // Deteriorated (Red)
                        trendIcon = '<i class="fa-solid fa-caret-down" style="position: absolute; bottom: -5px; right: -5px; color: #dc2626; font-size: 0.85rem; text-shadow: 0 0 4px white;"></i>';
                    }
                }

                console.log(`%c[V13 Matrix] A√±o ${yr}`, "color: #4f46e5; font-weight: bold;", {
                    avg: avgRank,
                    lastAvg: lastAvg,
                    status: avgRank > lastAvg ? 'Improved' : (avgRank < lastAvg ? 'Deteriorated' : 'Stable')
                });

                lastAvg = avgRank;

                return `
                <div style="display: flex; flex-direction: column; align-items: center; gap: 4px;">
                    <div style="position: relative; width: 38px; height: 38px; background: ${color}; color: white; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 0.9rem; font-weight: 800; box-shadow: 0 4px 6px rgba(0,0,0,0.1); border: 2px solid rgba(255,255,255,0.2);">
                        ${avgRank}
                        ${trendIcon}
                    </div>
                    <span style="font-size: 0.65rem; font-weight: 700; color: #64748b;">'${yr.toString().slice(2)}</span>
                </div>
            `;
            }).join('');


            // IA Integration
            if (typeof IAModule !== 'undefined') {
                IAModule.getInterpretation('vista13').then(txt => {
                    const el = document.getElementById('v13_ia_analysis');
                    if (el) el.innerHTML = txt;
                });
            }

        })();
    </script>