<!-- Vista 9: Tipolog√≠as Cr√≠ticas por Comparativo -->
<div class="card mb-lg">
    <div class="location-source-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 600; letter-spacing: 0.5px;">
            <i class="fa-solid fa-location-dot"></i> <span class="comuna-fill">CARGANDO...</span>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span class="semana-fill">--</span>
        </div>
        <div id="sourceBadgeContainer"></div>
    </div>

    <div class="question-section"
        style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); 
            border-left: 4px solid var(--color-primary); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
        <h2 style="font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin: 0; letter-spacing: -0.02em;">
            ¬øEn qu√© delitos espec√≠ficos somos cr√≠ticos?
        </h2>
        <p style="color: var(--color-text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">
            Identificaci√≥n de delitos donde la comuna ocupa los peores rankings regionales o nacionales,
            independientemente del volumen total de casos.
        </p>
    </div>

    <div class="alert alert--info" style="margin-top: 1.5rem;">
        <strong>ü§ñ An√°lisis de Situaci√≥n:</strong> <span id="v9_ia_analysis">Cargando an√°lisis...</span>
    </div>

    <!-- Bottom 3 (Critical Rankings) -->
    <div id="v9_critical_container"
        style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 1rem; margin-bottom: 2rem;">
        <!-- Filled by JS -->
    </div>

    <div class="card chart-card" style="padding: 1.5rem;">
        <h3 class="section-title mb-lg" style="font-size: 1rem; color: #1e293b;">
            <i class="fa-solid fa-chart-column" style="color: #ef4444;"></i> Histograma Comparativo de Tasas (Comuna vs
            Regi√≥n vs Pa√≠s)
        </h3>
        <div class="chart-wrapper" style="height: 350px;">
            <canvas id="v9_chart_comparative"></canvas>
        </div>
    </div>

    <!-- Nota Metodol√≥gica -->
    <div class="methodological-note"
        style="background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--color-primary); padding: 1.25rem; border-radius: 0 8px 8px 0; margin-top: 2rem; display: flex; gap: 1rem; align-items: flex-start;">
        <i class="fa-solid fa-circle-info" style="color: var(--color-primary); margin-top: 3px;"></i>
        <div>
            <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem; font-weight: 800; color: var(--color-text);">Nota
                Metodol√≥gica</h4>
            <p style="margin: 0; font-size: 0.85rem; color: var(--color-text-muted); line-height: 1.5;">
                Este modelo anal√≠tico trabaja en dos fases: primero, prioriza los delitos con rankings cr√≠ticos a nivel
                regional y nacional para identificar vulnerabilidades de seguridad en la zona. Luego, eval√∫a las
                categor√≠as con mayor cantidad de casos usando tasas normalizadas (por cada 100.000 habitantes), lo que
                permite eliminar el efecto de la poblaci√≥n y comparar nuestro desempe√±o frente a los datos reales de la
                regi√≥n y el pa√≠s en la misma semana operativa del sistema STOP. Al evitar proyecciones o
                extrapolaciones, este an√°lisis entrega evidencia t√©cnica directa para ayudar a priorizar recursos y
                tomar decisiones estrat√©gicas a nivel directivo.
            </p>
        </div>
    </div>
</div>

<script>
    (async function initVista9_V2() {
        const waitForData = () => {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.STATE_DATA && window.STATE_DATA.isLoaded) resolve();
                    else setTimeout(check, 100);
                };
                check();
            });
        };

        await waitForData();
        const S = window.STATE_DATA;
        const C = window.COLS;

        document.querySelectorAll('.comuna-fill').forEach(el => el.textContent = S.comunaName);
        document.querySelectorAll('.semana-fill').forEach(el => el.textContent = S.semanaDetalle);

        const currentData = S.allDataHistory.filter(r => r[C.ID_SEMANA] === S.currentSemana);
        const factorPob = currentData[0]?.[C.FACTOR_POBLACION] || 1;

        // Fetch total communes in the region for ranking calculations
        let totalComunas = 52; // Fallback
        try {
            const conteoRes = await fetch('data/comunas/data_comuna_conteo.json');
            if (conteoRes.ok) {
                const conteoData = await conteoRes.json();
                const miConteo = conteoData.find(c => c.codcom == S.codcom);
                if (miConteo && miConteo.comunas) {
                    totalComunas = miConteo.comunas;
                    console.log(`üìç Vista 9: Total Regional detectado: ${totalComunas} comunas.`);
                }
            }
        } catch (e) {
            console.warn('‚ö†Ô∏è Vista 9: No se pudo cargar data_comuna_conteo, usando fallback 52.', e);
        }

        // Get Top 3 Critical by Ranking (Regional or National)
        const critical = currentData
            .filter(r => (r[C.RANK_NAC_SEM] || 346) < 30 || (r[C.RANK_REG_PROY] || totalComunas) < 5)
            .sort((a, b) => (a[C.RANK_NAC_SEM] || 346) - (b[C.RANK_NAC_SEM] || 346))
            .slice(0, 3);

        const container = document.getElementById('v9_critical_container');
        if (critical.length > 0) {
            container.innerHTML = critical.map(d => `
                <div style="background: white; border: 1px solid #fee2e2; border-radius: 12px; padding: 1.25rem; border-top: 6px solid #ef4444; position: relative;">
                    <div style="font-size: 0.7rem; font-weight: 800; color: #ef4444; text-transform: uppercase; margin-bottom: 5px; letter-spacing: 0.05em;">PUNTO CR√çTICO</div>
                    <div style="font-size: 1rem; font-weight: 800; color: #1e293b; margin-bottom: 10px; min-height: 2.4rem; line-height: 1.2;">${d[C.DELITO]}</div>
                    <div style="display: flex; align-items: flex-end; gap: 5px;">
                        <span style="font-size: 1.8rem; font-weight: 950; color: #1e293b; line-height: 1;">${d[C.RANK_NAC_SEM] || '--'}</span>
                        <span style="font-size: 0.8rem; font-weight: 700; color: #64748b; margin-bottom: 4px;">RANK NACIONAL</span>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.75rem; color: #94a3b8; font-weight: 600;">Posici√≥n regional: <strong>${d[C.RANK_REG_PROY] || '--'}</strong></div>
                </div>
            `).join('');
        } else {
            container.innerHTML = '<div class="text-muted" style="grid-column: 1/-1; padding: 2rem; border: 2px dashed #f1f5f9; border-radius: 12px; text-align: center;">No se registran tipolog√≠as en rangos cr√≠ticos regionales o nacionales esta semana.</div>';
        }

        // --- Histogram Chart ---
        // Sort by cases descending to get significant ones
        const top3ForChart = [...currentData].sort((a, b) => (b[C.CASOS_ACTUAL] || 0) - (a[C.CASOS_ACTUAL] || 0)).slice(0, 5); // Show top 5 instead of 3 for better chart
        const labels = top3ForChart.map(d => d[C.DELITO]);

        const ctx = document.getElementById('v9_chart_comparative').getContext('2d');
        const DataLabelsPlugin = window.ChartDataLabels || {};

        new Chart(ctx, {
            type: 'bar',
            plugins: [DataLabelsPlugin],
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Tasa Comunal',
                        data: top3ForChart.map(d => (d[C.TASA_SEMANAL] || 0).toFixed(1)),
                        backgroundColor: '#ef4444',
                        borderRadius: 4,
                        datalabels: {
                            color: '#ef4444',
                            font: { weight: 'bold', size: 10 },
                            anchor: 'end',
                            align: 'top',
                            offset: 0,
                            formatter: (v) => v > 0 ? v : ''
                        }
                    },
                    {
                        label: 'Tasa Regional',
                        data: top3ForChart.map(d => (d[C.TASA_REGIONAL] || 0).toFixed(1)),
                        backgroundColor: '#94a3b8',
                        borderRadius: 4,
                        datalabels: {
                            color: '#1e293b',
                            font: { weight: 'bold', size: 10 },
                            anchor: 'end',
                            align: 'top',
                            offset: 0,
                            formatter: (v) => v > 0 ? v : ''
                        }
                    },
                    {
                        label: 'Tasa Nacional',
                        data: top3ForChart.map(d => (d[C.TASA_NACIONAL] || 0).toFixed(1)),
                        backgroundColor: '#e2e8f0',
                        borderRadius: 4,
                        datalabels: {
                            color: '#64748b',
                            font: { weight: 'bold', size: 10 },
                            anchor: 'end',
                            align: 'top',
                            offset: 0,
                            formatter: (v) => v > 0 ? v : ''
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: { padding: { top: 20 } },
                plugins: {
                    legend: { position: 'top', labels: { font: { family: 'Outfit', weight: '600' } } },
                    tooltip: {
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleFont: { family: 'Outfit' }
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#f1f5f9' },
                        title: { display: true, text: 'Tasa Est. x 100k', font: { family: 'Outfit', size: 10 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: {
                            font: { family: 'Outfit', weight: '700', size: 9 },
                            maxRotation: 45,
                            minRotation: 0,
                            autoSkip: false
                        }
                    }
                }
            }
        });


        // IA Integration
        if (typeof IAModule !== 'undefined') {
            IAModule.getInterpretation('vista9').then(txt => {
                const el = document.getElementById('v9_ia_analysis');
                if (el) el.innerHTML = txt;
            });
        }

    })();
</script>