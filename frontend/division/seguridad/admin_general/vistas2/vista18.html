<!-- Vista 18: Evoluci贸n de Factores de Riesgo (Tipolog铆as Cr铆ticas) -->
<div class="card mb-lg">
    <div class="location-source-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 600; letter-spacing: 0.5px;">
            <i class="fa-solid fa-biohazard"></i> <span class="comuna-fill">CARGANDO...</span>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span>BALANCE DE VIOLENCIA</span>
        </div>
        <div id="sourceBadgeContainer"></div>
    </div>

    <div class="question-section"
        style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); 
            border-left: 4px solid var(--color-primary); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
        <h2 style="font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin: 0; letter-spacing: -0.02em;">
            驴Est谩 aumentando la violencia en los delitos?
        </h2>
        <p style="color: var(--color-text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">An谩lisis de la composici贸n
            cualitativa del delito: Violentos vs Contra la Propiedad. La peligrosidad es m谩s cr铆tica que el volumen.</p>
    </div>

    <div class="alert alert--info" style="margin-top: 1.5rem;">
        <strong> An谩lisis de Situaci贸n:</strong> <span id="v18_ia_analysis">Cargando an谩lisis...</span>
    </div>

    <div class="cards-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">
        <!-- Pie Balance -->
        <div class="card" style="padding: 1.5rem; text-align: center;">
            <h4
                style="margin: 0 0 1rem 0; font-size: 0.85rem; font-weight: 800; color: #64748b; text-transform: uppercase;">
                Balance de Peligrosidad (Semana Actual)</h4>
            <div class="chart-wrapper" style="height: 250px;">
                <canvas id="v18_chart_pie"></canvas>
            </div>
            <div id="v18_violence_index" style="margin-top: 1rem; font-size: 1.5rem; font-weight: 900; color: #ef4444;">
                --% Violencia</div>
        </div>

        <!-- Trend Chart -->
        <div class="card" style="padding: 1.5rem;">
            <h4
                style="margin: 0 0 1rem 0; font-size: 0.85rem; font-weight: 800; color: #64748b; text-transform: uppercase;">
                Evoluci贸n del ndice de Violencia (12 Sem)</h4>
            <div class="chart-wrapper" style="height: 250px;">
                <canvas id="v18_chart_trend"></canvas>
            </div>
        </div>
    </div>

    <!-- Definici贸n de Categor铆as -->
    <div class="card" style="margin-top: 1.5rem; padding: 1.5rem; border: 1px solid #e2e8f0; background: #fff;">
        <h4
            style="margin: 0 0 1rem 0; font-size: 0.9rem; font-weight: 800; color: #1e293b; display: flex; align-items: center; gap: 8px;">
            <i class="fa-solid fa-circle-info" style="color: var(--color-primary);"></i> Detalle por Categor铆a (Semana
            Actual)
        </h4>
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 1rem;">
            <!-- VIOLENTOS -->
            <div
                style="padding: 1rem; background: rgba(239, 68, 68, 0.05); border-radius: 8px; border: 1px solid rgba(239, 68, 68, 0.1);">
                <div
                    style="font-weight: 800; color: #ef4444; font-size: 0.8rem; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-triangle-exclamation"></i> VIOLENTOS
                </div>
                <ul id="v18_list_violentos"
                    style="margin: 0; padding-left: 1.2rem; font-size: 0.7rem; color: #4b5563; line-height: 1.6;">
                    <!-- Filled dynamically -->
                    <li>Cargando...</li>
                </ul>
            </div>

            <!-- A LA PROPIEDAD -->
            <div
                style="padding: 1rem; background: rgba(59, 130, 246, 0.05); border-radius: 8px; border: 1px solid rgba(59, 130, 246, 0.1);">
                <div
                    style="font-weight: 800; color: #3b82f6; font-size: 0.8rem; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-house-lock"></i> A LA PROPIEDAD
                </div>
                <ul id="v18_list_propiedad"
                    style="margin: 0; padding-left: 1.2rem; font-size: 0.7rem; color: #4b5563; line-height: 1.6;">
                    <!-- Filled dynamically -->
                    <li>Cargando...</li>
                </ul>
            </div>

            <!-- OTROS -->
            <div
                style="padding: 1rem; background: rgba(148, 163, 184, 0.05); border-radius: 8px; border: 1px solid rgba(148, 163, 184, 0.1);">
                <div
                    style="font-weight: 800; color: #64748b; font-size: 0.8rem; margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                    <i class="fa-solid fa-ellipsis"></i> OTROS
                </div>
                <ul id="v18_list_otros"
                    style="margin: 0; padding-left: 1.2rem; font-size: 0.7rem; color: #4b5563; line-height: 1.6;">
                    <!-- Filled dynamically -->
                    <li>Cargando...</li>
                </ul>
            </div>
        </div>
    </div>
</div>


<!-- Nota Metodol贸gica -->
<div class="methodological-note"
    style="background: rgba(59, 130, 246, 0.05); border-left: 3px solid var(--color-primary); padding: 1.25rem; border-radius: 0 8px 8px 0; margin-top: 2rem; display: flex; gap: 1rem; align-items: flex-start;">
    <i class="fa-solid fa-circle-info" style="color: var(--color-primary); margin-top: 3px;"></i>
    <div>
        <h4 style="margin: 0 0 0.25rem 0; font-size: 0.9rem; font-weight: 800; color: var(--color-text);">Nota
            Metodol贸gica</h4>
        <p style="margin: 0; font-size: 0.85rem; color: var(--color-text-muted); line-height: 1.5;">
            El <strong>ndice de Violencia</strong> se calcula como la proporci贸n de casos violentos (Homicidios, Robos
            con Violencia, etc.) sobre el total de delitos reportados. Este indicador permite priorizar la gesti贸n
            t谩ctica sobre la severidad delictual m谩s all谩 del volumen total de infracciones.
        </p>
    </div>
</div>

<script>
    (async function initVista18_V2() {
        const waitForData = () => {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.STATE_DATA && window.STATE_DATA.isLoaded) resolve();
                    else setTimeout(check, 100);
                };
                check();
            });
        };

        await waitForData();
        const S = window.STATE_DATA;
        const C = window.COLS;

        document.querySelectorAll('.comuna-fill').forEach(el => el.textContent = S.comunaName);

        const currentData = S.allDataHistory.filter(r => r[C.ID_SEMANA] === S.currentSemana);

        //  Clasificaci贸n Din谩mica desde delito_class.json 
        let taxonomy = {};
        try {
            const response = await fetch('./config/delito_class.json');
            if (response.ok) {
                const classes = await response.json();
                classes.forEach(c => {
                    let type = 'OTROS';
                    // Map JSON 'violencia' values to internal categories
                    if (c.violencia === 'Violentos') type = 'VIOLENTO';
                    else if (c.violencia === 'A la Propiedad') type = 'PROPIEDAD';
                    // 'Otros' remains 'OTROS'

                    if (c.delito) {
                        taxonomy[c.delito.toUpperCase().trim()] = type;
                    }
                });
            } else {
                console.warn('[V18] No se pudo cargar delito_class.json, usando fallback.');
            }
        } catch (e) {
            console.error('[V18] Error cargando clasificaci贸n:', e);
        }

        const classify = (delito) => {
            if (!delito) return 'OTROS';
            const d = delito.toUpperCase().trim();
            return taxonomy[d] || 'OTROS';
        };

        // --- Calculate Stats per Crime and Group ---
        const stats = {
            VIOLENTO: { total: 0, crimes: {} },
            PROPIEDAD: { total: 0, crimes: {} },
            OTROS: { total: 0, crimes: {} }
        };

        currentData.forEach(r => {
            const cat = classify(r[C.DELITO]);
            const count = r[C.CASOS_ACTUAL] || 0;
            const name = r[C.DELITO];

            // Safety check for category based on taxonomy default
            const target = stats[cat] ? stats[cat] : stats.OTROS;

            target.total += count;
            target.crimes[name] = (target.crimes[name] || 0) + count;
        });

        // --- Populate Details Lists ---
        const populateList = (listId, categoryKey) => {
            const container = document.getElementById(listId);
            if (!container) return;
            container.innerHTML = '';

            const groupData = stats[categoryKey];
            const sortedCrimes = Object.entries(groupData.crimes).sort((a, b) => b[1] - a[1]);

            if (sortedCrimes.length === 0) {
                container.innerHTML = '<li style="color: #94a3b8; font-style: italic;">Sin registros esta semana</li>';
                return;
            }

            sortedCrimes.forEach(([name, count]) => {
                const pct = groupData.total > 0 ? (count / groupData.total * 100).toFixed(1) : 0;

                const li = document.createElement('li');
                li.innerHTML = `<strong>${name}</strong>: ${count} <span style="color: #64748b;">(${pct}%)</span>`;
                container.appendChild(li);
            });
        };

        populateList('v18_list_violentos', 'VIOLENTO');
        populateList('v18_list_propiedad', 'PROPIEDAD');
        populateList('v18_list_otros', 'OTROS');

        // --- Top Level KPIs ---
        const totalCases = stats.VIOLENTO.total + stats.PROPIEDAD.total + stats.OTROS.total;
        const vPct = totalCases > 0 ? (stats.VIOLENTO.total / totalCases * 100) : 0;
        document.getElementById('v18_violence_index').textContent = `${vPct.toFixed(1)}% ndice Violencia`;

        // --- Pie Chart with Datalabels ---
        const pieCtx = document.getElementById('v18_chart_pie').getContext('2d');
        new Chart(pieCtx, {
            type: 'pie',
            data: {
                labels: ['Violentos', 'Propiedad', 'Otros'],
                datasets: [{
                    data: [stats.VIOLENTO.total, stats.PROPIEDAD.total, stats.OTROS.total],
                    backgroundColor: ['#ef4444', '#3b82f6', '#94a3b8'],
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                layout: {
                    padding: 20
                },
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: { enabled: false }, // Disable tooltip to prioritize datalabels
                    datalabels: {
                        color: '#fff',
                        font: { weight: 'bold', size: 11 },
                        textAlign: 'center',
                        formatter: (val, ctx) => {
                            if (val === 0) return '';
                            const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                            const pct = (val / total * 100).toFixed(1) + '%';
                            return `${val}\n(${pct})`;
                        },
                        display: 'auto'
                    }
                }
            },
            plugins: [ChartDataLabels]
        });

        // --- Trend 12 weeks ---
        const last12 = [...new Set(S.allDataHistory.map(r => r[C.ID_SEMANA]))].sort((a, b) => b - a).slice(0, 12).reverse();

        const trendDataViolento = last12.map(id => {
            const rows = S.allDataHistory.filter(r => r[C.ID_SEMANA] === id);
            const v = rows.filter(r => classify(r[C.DELITO]) === 'VIOLENTO').reduce((s, r) => s + (r[C.CASOS_ACTUAL] || 0), 0);
            const t = rows.reduce((s, r) => s + (r[C.CASOS_ACTUAL] || 0), 0);
            return t > 0 ? (v / t * 100).toFixed(1) : 0;
        });

        const trendDataPropiedad = last12.map(id => {
            const rows = S.allDataHistory.filter(r => r[C.ID_SEMANA] === id);
            const p = rows.filter(r => classify(r[C.DELITO]) === 'PROPIEDAD').reduce((s, r) => s + (r[C.CASOS_ACTUAL] || 0), 0);
            const t = rows.reduce((s, r) => s + (r[C.CASOS_ACTUAL] || 0), 0);
            return t > 0 ? (p / t * 100).toFixed(1) : 0;
        });

        const lineCtx = document.getElementById('v18_chart_trend').getContext('2d');
        new Chart(lineCtx, {
            type: 'line',
            data: {
                labels: last12.map(id => S.getDateLabel ? S.getDateLabel(id) : `S${id % 100}`),
                datasets: [
                    {
                        label: '% Violencia',
                        data: trendDataViolento,
                        borderColor: '#ef4444',
                        backgroundColor: 'rgba(239, 68, 68, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        datalabels: {
                            display: (ctx) => ctx.dataIndex % 2 === 0, // Show on even indices
                            align: 'top',
                            color: '#ef4444',
                            font: { weight: 'bold', size: 10 },
                            formatter: (v) => v + '%'
                        }
                    },
                    {
                        label: '% Propiedad',
                        data: trendDataPropiedad,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        fill: false,
                        tension: 0.4,
                        pointRadius: 4,
                        datalabels: {
                            display: (ctx) => ctx.dataIndex % 2 !== 0, // Show on odd indices
                            align: 'bottom',
                            color: '#3b82f6',
                            font: { weight: 'bold', size: 10 },
                            formatter: (v) => v + '%'
                        }
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    datalabels: { display: false } // Default off, controlled by dataset
                },
                scales: {
                    y: {
                        // Auto-scale (remove fixed min/max 0-100) to use space better
                        ticks: { callback: v => v + '%' },
                        grid: { color: '#f1f5f9' },
                        grace: '10%' // Add some breathing room
                    },
                    x: {
                        grid: { display: false }
                    }
                }
            },
            plugins: [ChartDataLabels] // Ensure plugin is active for this chart
        });

        // IA Integration
        if (typeof IAModule !== 'undefined') {
            IAModule.getInterpretation('vista18').then(txt => {
                const el = document.getElementById('v18_ia_analysis');
                if (el) el.innerHTML = txt;
            });
        }

    })();
</script>