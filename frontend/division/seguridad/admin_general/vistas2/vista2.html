<!-- Vista 2: Evoluci贸n Reciente (8 semanas) -->
<div class="card mb-lg">
    <div class="location-source-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 600; letter-spacing: 0.5px;">
            <i class="fa-solid fa-location-dot"></i> <span class="comuna-fill">CARGANDO...</span>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span class="semana-fill">--</span>
        </div>
        <div id="sourceBadgeContainer"></div>
    </div>

    <div class="question-section"
        style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); 
            border-left: 4px solid var(--color-primary); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
        <h2 style="font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin: 0; letter-spacing: -0.02em;">
            驴C贸mo ha evolucionado la delincuencia en los 煤ltimos meses?
        </h2>
        <p style="color: var(--color-text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">Tendencia de mediano plazo
            (24 semanas)
            con suavizado mediante media m贸vil de 4 semanas para eliminar ruido operacional.</p>
    </div>

    <div class="alert alert--info" style="margin-top: 1.5rem;">
        <strong> An谩lisis de Situaci贸n:</strong> <span id="v2_ia_analysis">Cargando an谩lisis...</span>
    </div>

    <div class="kpi-grid" style="margin-bottom: 2rem;">
        <div class="kpi-card">
            <div class="kpi-label">Total Periodo (24S)</div>
            <div class="kpi-value" id="v2_total_24s">--</div>
            <div class="kpi-change">Acumulado semestre</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Promedio Semanal</div>
            <div class="kpi-value" id="v2_avg_24s">--</div>
            <div class="kpi-change">Semanas monitoreadas</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Pico M谩ximo</div>
            <div class="kpi-value" id="v2_max_24s">--</div>
            <div class="kpi-change" id="v2_max_week">--</div>
        </div>
        <div class="kpi-card">
            <div class="kpi-label">Brecha Hist贸rica</div>
            <div class="kpi-value" id="v2_delta_hist">--</div>
            <div class="kpi-change" id="v2_delta_hist_label">vs Promedio Global</div>
        </div>
    </div>

    <!-- Trend Arrow Indicator -->
    <div
        style="display: flex; align-items: center; gap: 20px; margin-bottom: 2rem; padding: 1rem; background: #f8fafc; border-radius: 12px; border: 1px solid #e2e8f0;">
        <div id="v2_trend_icon"
            style="width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.5rem;">
            <i class="fa-solid fa-arrow-right"></i>
        </div>
        <div>
            <div
                style="font-size: 0.8rem; font-weight: 600; color: #64748b; text-transform: uppercase; letter-spacing: 0.05em;">
                Tendencia Actual</div>
            <div id="v2_trend_text" style="font-size: 1.2rem; font-weight: 800; color: #1e293b;">Calculando tendencia...
            </div>
        </div>
        <div style="margin-left: auto; text-align: right;">
            <div style="font-size: 0.8rem; font-weight: 600; color: #64748b;">VARIACIN MEDIA MVIL</div>
            <div id="v2_ma_change" style="font-size: 1.2rem; font-weight: 800; color: #1e293b;">--%</div>
        </div>
    </div>

    <!-- Main Chart -->
    <div class="chart-wrapper" style="height: 450px;">
        <canvas id="v2_chart_evolution"></canvas>
    </div>
</div>


<!-- Nota Metodol贸gica -->
<div class="row" style="margin-top: 2rem;">
    <div
        style="background-color: #f8fafc; border-left: 4px solid #cbd5e1; padding: 1rem; border-radius: 4px; color: #64748b; font-size: 0.85rem; line-height: 1.5;">
        <strong>Nota Metodol贸gica:</strong> Esta vista sintetiza la din谩mica delictual de los 煤ltimos 6 meses. Los
        indicadores superiores resumen el volumen acumulado, promedios y m谩ximos del periodo, destacando la
        <strong>Brecha Hist贸rica</strong> respecto al comportamiento estructural de la comuna. El gr谩fico contrasta la
        operaci贸n semanal con rangos de normalidad (Zona Sombreada), utilizando promedios de periodo (谩mbar), base
        hist贸rica (铆ndigo) y media m贸vil para deslindar variaciones c铆clicas de tendencias estructurales emergentes.
    </div>
</div>

<script>
    (async function initVista2_V2() {
        const waitForData = () => {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.STATE_DATA && window.STATE_DATA.isLoaded) resolve();
                    else setTimeout(check, 100);
                };
                check();
            });
        };

        await waitForData();
        const S = window.STATE_DATA;
        const C = window.COLS;

        // Header
        document.querySelectorAll('.comuna-fill').forEach(el => el.textContent = S.comunaName);
        document.querySelectorAll('.semana-fill').forEach(el => el.textContent = S.semanaDetalle);

        // Get last 8 weeks
        const allWeeksSorted = [...new Set(S.allDataHistory_total.map(r => r[C.ID_SEMANA]))].sort((a, b) => b - a);
        const last8_IDs = allWeeksSorted.slice(0, 24).reverse();

        const weeklyData = last8_IDs.map(id => S.allDataHistory_total.find(r => r[C.ID_SEMANA] === id) || {});

        const cases = weeklyData.map(r => r[C.CASOS_ACTUAL] || 0);
        const movingAvg = weeklyData.map(r => r[C.MEDIA_MOVIL_4S] || 0);
        const labels = last8_IDs.map(id => S.getDateLabel ? S.getDateLabel(id) : `Sem ${id % 100}`);

        // --- Promedio 24 Semanas ---
        const avg24 = cases.reduce((a, b) => a + b, 0) / cases.length;
        const avgData = Array(cases.length).fill(avg24);

        // --- Promedio Hist贸rico Global (Toda la Base) ---
        const globalAvg = S.allDataHistory_total.reduce((acc, r) => acc + (r[C.CASOS_ACTUAL] || 0), 0) / S.allDataHistory_total.length;
        const globalAvgData = Array(cases.length).fill(globalAvg);

        // Ranges (卤1 Sigma)
        const rangeUpper = weeklyData.map(r => (r[C.PROMEDIO_HIST] || 0) + (r[C.STD_HIST] || 0));
        const rangeLower = weeklyData.map(r => Math.max(0, (r[C.PROMEDIO_HIST] || 0) - (r[C.STD_HIST] || 0)));

        // Trend Logic
        const lastMA = movingAvg[movingAvg.length - 1];
        const prevMA = movingAvg[movingAvg.length - 2] || lastMA;
        const maVar = prevMA > 0 ? ((lastMA - prevMA) / prevMA * 100) : 0;

        // KPI Calculations (24 weeks)
        const total24 = cases.reduce((a, b) => a + b, 0);
        const max24 = Math.max(...cases);
        const maxIndex = cases.indexOf(max24);
        const maxWeekLabel = labels[maxIndex] || '--';
        const deltaGlobal = globalAvg > 0 ? ((avg24 - globalAvg) / globalAvg * 100) : 0;

        document.getElementById('v2_total_24s').textContent = total24;
        document.getElementById('v2_avg_24s').textContent = avg24.toFixed(1);
        document.getElementById('v2_max_24s').textContent = max24;
        document.getElementById('v2_max_week').textContent = `Semana: ${maxWeekLabel}`;
        const deltaEl = document.getElementById('v2_delta_hist');
        deltaEl.textContent = `${deltaGlobal >= 0 ? '+' : ''}${deltaGlobal.toFixed(1)}%`;
        deltaEl.style.color = deltaGlobal > 5 ? '#ef4444' : deltaGlobal < -5 ? '#10b981' : '#64748b';

        const trendIcon = document.getElementById('v2_trend_icon');
        const trendText = document.getElementById('v2_trend_text');
        const maChange = document.getElementById('v2_ma_change');

        maChange.textContent = `${maVar >= 0 ? '+' : ''}${maVar.toFixed(1)}%`;
        maChange.style.color = maVar > 2 ? '#ef4444' : maVar < -2 ? '#10b981' : '#64748b';

        if (maVar > 3) {
            trendIcon.innerHTML = '<i class="fa-solid fa-arrow-trend-up"></i>';
            trendIcon.style.background = 'rgba(239, 68, 68, 0.1)';
            trendIcon.style.color = '#ef4444';
            trendText.textContent = 'Expansi贸n Delictual';
            trendText.style.color = '#ef4444';
        } else if (maVar < -3) {
            trendIcon.innerHTML = '<i class="fa-solid fa-arrow-trend-down"></i>';
            trendIcon.style.background = 'rgba(16, 185, 129, 0.1)';
            trendIcon.style.color = '#10b981';
            trendText.textContent = 'Contracci贸n / Mejora';
            trendText.style.color = '#10b981';
        } else {
            trendIcon.innerHTML = '<i class="fa-solid fa-minus"></i>';
            trendIcon.style.background = 'rgba(100, 116, 139, 0.1)';
            trendIcon.style.color = '#64748b';
            trendText.textContent = 'Estabilidad Relativa';
            trendText.style.color = '#64748b';
        }

        // --- Chart ---
        const ctx = document.getElementById('v2_chart_evolution').getContext('2d');

        new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Casos Semanales',
                        data: cases,
                        borderColor: '#1e293b',
                        borderWidth: 2,
                        pointRadius: 4,
                        pointBackgroundColor: '#fff',
                        pointBorderWidth: 3,
                        zIndex: 10,
                        tension: 0,
                        datalabels: {
                            display: (ctx) => ctx.dataIndex % 2 === 0,
                            align: 'top',
                            offset: 5,
                            color: '#1e293b',
                            font: { weight: 'bold', size: 10 },
                            backgroundColor: 'rgba(255, 255, 255, 0.7)',
                            borderRadius: 4,
                            padding: 2
                        }
                    },
                    {
                        label: 'Media M贸vil',
                        data: movingAvg,
                        borderColor: '#3b82f6',
                        backgroundColor: 'transparent',
                        borderWidth: 2,
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: 'Rango Normalidad (Sup)',
                        data: rangeUpper,
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(148, 163, 184, 0.1)',
                        fill: '+1',
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: 'Rango Normalidad (Inf)',
                        data: rangeLower,
                        borderColor: 'transparent',
                        backgroundColor: 'rgba(148, 163, 184, 0.1)',
                        fill: false,
                        pointRadius: 0,
                        tension: 0.4
                    },
                    {
                        label: `Promedio 24 Semanas (${avg24.toFixed(1)})`,
                        data: avgData,
                        borderColor: '#fbbf24', // Amber for 24-week avg
                        borderWidth: 1.5,
                        borderDash: [5, 5],
                        pointRadius: 0,
                        fill: false
                    },
                    {
                        label: `L铆nea Base Hist贸rica (${globalAvg.toFixed(1)})`,
                        data: globalAvgData,
                        borderColor: '#6366f1', // Indigo for Global Baseline
                        borderWidth: 1,
                        borderDash: [2, 2],
                        pointRadius: 0,
                        fill: false
                    }
                ]
            },
            plugins: [ChartDataLabels],
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            font: { family: 'Outfit', weight: '600' },
                            filter: (item) => !item.text.includes('Rango')
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(15, 23, 42, 0.9)',
                        titleFont: { family: 'Outfit', size: 14 }
                    },
                    datalabels: {
                        display: false // Por defecto desactivado para todos
                    }
                },
                scales: {
                    y: {
                        grid: { color: '#f1f5f9' },
                        ticks: { font: { family: 'Outfit' } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { family: 'Outfit' } }
                    }
                }
            }
        });

    
        // IA Integration
        if (typeof IAModule !== 'undefined') {
            IAModule.getInterpretation('vista2').then(txt => {
                const el = document.getElementById('v2_ia_analysis');
                if (el) el.innerHTML = txt;
            });
        }

    })();
</script>