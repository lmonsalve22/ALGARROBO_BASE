<!-- Vista 20: Diagn贸stico de Delitos en Disipaci贸n (xitos Operativos) -->
<div class="card mb-lg">
    <div class="location-source-row"
        style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem;">
        <div style="font-size: 0.8rem; color: var(--color-primary); font-weight: 600; letter-spacing: 0.5px;">
            <i class="fa-solid fa-cloud-sun"></i> <span class="comuna-fill">CARGANDO...</span>
            <span style="margin: 0 8px; color: #cbd5e1;">/</span>
            <span>GESTIN DE XITO (CEAD)</span>
        </div>
        <div id="sourceBadgeContainer"></div>
    </div>

    <div class="question-section"
        style="background: linear-gradient(90deg, rgba(59, 130, 246, 0.1) 0%, transparent 100%); 
            border-left: 4px solid var(--color-primary); padding: 1.25rem; margin-bottom: 1.5rem; border-radius: 0 8px 8px 0;">
        <h2 style="font-size: 1.6rem; font-weight: 800; color: var(--color-text); margin: 0; letter-spacing: -0.02em;">
            驴Qu茅 delitos estamos logrando reducir con 茅xito?
        </h2>
        <p style="color: var(--color-text-muted); margin: 0.25rem 0 0 0; font-size: 0.95rem;">Identificaci贸n de
            tipolog铆as en fase de disipaci贸n: delitos con disminuci贸n sostenida y valores significativamente bajo su
            media hist贸rica.</p>
    </div>

    <div class="alert alert--info" style="margin-top: 1.5rem;">
        <strong> An谩lisis de Situaci贸n:</strong> <span id="v20_ia_analysis">Cargando an谩lisis...</span>
    </div>

    <!-- Success Grid -->
    <!-- Tabs or Split View -->
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem;">

        <!-- Short Term (STOP) -->
        <div class="card" style="padding: 1.5rem; border-left: 8px solid #10b981;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                <h3 class="section-title mb-lg" style="font-size: 1rem; color: #065f46; margin:0;"><i
                        class="fa-solid fa-arrow-trend-down"></i> Corto Plazo (STOP)</h3>
                <span
                    style="font-size: 0.7rem; background: #ecfdf5; color: #065f46; padding: 2px 8px; border-radius: 4px; font-weight: 700;">ltimas
                    Semanas</span>
            </div>
            <div id="v20_list_stop" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Filled by JS -->
            </div>
        </div>

        <!-- Long Term (CEAD) -->
        <div class="card" style="padding: 1.5rem; border-left: 8px solid #3b82f6;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 1rem;">
                <h3 class="section-title mb-lg" style="font-size: 1rem; color: #1e40af; margin:0;"><i
                        class="fa-solid fa-medal"></i> Largo Plazo (CEAD)</h3>
                <span
                    style="font-size: 0.7rem; background: #eff6ff; color: #1e40af; padding: 2px 8px; border-radius: 4px; font-weight: 700;">Tendencia
                    Anual</span>
            </div>
            <div id="v20_list_cead" style="display: flex; flex-direction: column; gap: 10px;">
                <!-- Filled by JS -->
            </div>
        </div>

    </div>

    <!-- Validation Note -->
    <div class="card"
        style="margin-top: 1.5rem; padding: 1.5rem; background: #f0fdf4; border: 1px solid #dcfce7; display: flex; align-items: center; gap: 20px;">
        <div style="font-size: 2rem; color: #10b981; opacity: 0.4;"><i class="fa-solid fa-clipboard-check"></i>
        </div>
        <div>
            <h4 style="margin: 0; font-size: 0.9rem; font-weight: 800; color: #166534;">Consolidaci贸n de Resultados
            </h4>
            <p style="margin: 5px 0 0 0; font-size: 0.8rem; color: #15803d; line-height: 1.5;">
                Las reducciones sostenidas en ambos plazos (corto y largo) son indicadoras de 茅xito estructural de
                las pol铆ticas implementadas.
            </p>
        </div>
    </div>
</div>


<!-- Nota Metodol贸gica -->
<div class="row" style="margin-top: 2rem;">
    <div
        style="background-color: #f8fafc; border-left: 4px solid #cbd5e1; padding: 1rem; border-radius: 4px; color: #64748b; font-size: 0.85rem; line-height: 1.5;">
        <strong>Nota Metodol贸gica:</strong> Esta vista utiliza datos del sistema <strong>CEAD (20 a帽os)</strong> para
        identificar si la tendencia delictual actual es estructural o coyuntural. Un alza sostenida por m谩s de 3 a帽os
        consecutivos indica un problema estructural que requiere intervenci贸n de pol铆tica p煤blica, no solo operativa.
    </div>
</div>

<script>
    (async function initVista20_V2() {
        const waitForData = () => {
            return new Promise((resolve) => {
                const check = () => {
                    if (window.STATE_DATA_CEAD && window.STATE_DATA_CEAD.isLoaded) resolve();
                    else setTimeout(check, 100);
                };
                check();
            });
        };

        await waitForData();
        if (window.STATE_DATA && window.STATE_DATA.isLoaded) {
            const S_STOP = window.STATE_DATA;
            const C_STOP = window.COLS;

            // Short Term: Dropping in last week
            const stopSuccess = S_STOP.allDataHistory.filter(r => r[C_STOP.ID_SEMANA] === S_STOP.currentSemana)
                .map(r => {
                    const act = r[C_STOP.CASOS_ACTUAL] || 0;
                    const ant = r[C_STOP.CASOS_ANT] || 0;
                    const delta = ant > 0 ? ((act - ant) / ant * 100) : 0;
                    return { ...r, delta, act, ant };
                })
                .filter(r => r.delta < -5 && r.ant > 0) // Significant drop (>5%)
                .sort((a, b) => a.delta - b.delta) // Most negative first
                .slice(0, 4);

            const listStop = document.getElementById('v20_list_stop');
            if (stopSuccess.length > 0) {
                listStop.innerHTML = stopSuccess.map(r => `
                    <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #f0fdf4; padding-bottom: 8px;">
                        <span style="font-weight: 700; color: #1e293b; font-size: 0.85rem;">${r[C_STOP.DELITO]}</span>
                        <span style="font-weight: 800; color: #10b981; font-size: 0.85rem;">${r.delta.toFixed(0)}%</span>
                    </div>
                `).join('');
            } else {
                listStop.innerHTML = '<div style="color: #94a3b8; font-size: 0.8rem; font-style: italic; text-align: center; padding: 1rem;">No se registran disminuciones significativas esta semana.</div>';
            }
        }

        const S = window.STATE_DATA_CEAD;
        const C = window.COLS_CEAD;

        document.querySelectorAll('.comuna-fill').forEach(el => el.textContent = S.comunaName);

        // Long Term: Dissipating (Very Negative Z-Score)
        const currentData = S.allDataHistory.filter(r => r[C.ID_PERIODO] === S.periodoId);

        const success = currentData
            .filter(r => (r[C.Z_SCORE] || 0) < -0.5 && (r[C.CASOS_ACTUAL] || 0) > 0 && r.stop_delito !== 'NO APLICA')
            .sort((a, b) => (a[C.Z_SCORE] || 0) - (b[C.Z_SCORE] || 0))
            .slice(0, 4);

        const listCead = document.getElementById('v20_list_cead');
        if (success.length > 0) {
            listCead.innerHTML = success.map(r => `
                <div style="display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #eff6ff; padding-bottom: 8px;">
                     <span style="font-weight: 700; color: #1e293b; font-size: 0.85rem;">
                        ${r.stop_delito || r[C.DELITO]}
                     </span>
                     <span style="font-weight: 800; color: #3b82f6; font-size: 0.85rem;">Z = ${(r[C.Z_SCORE] || 0).toFixed(2)}</span>
                </div>
            `).join('');
        } else {
            listCead.innerHTML = '<div style="color: #94a3b8; font-size: 0.8rem; font-style: italic; text-align: center; padding: 1rem;">No se registran tipolog铆as con disipaci贸n estructural (Z < -0.5).</div>';
        }


        // IA Integration
        if (typeof IAModule !== 'undefined') {
            IAModule.getInterpretation('vista20').then(txt => {
                const el = document.getElementById('v20_ia_analysis');
                if (el) el.innerHTML = txt;
            });
        }

    })();
</script>