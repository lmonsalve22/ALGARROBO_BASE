<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Licitaciones - Algarrobo</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .glass-card {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .step-progress {
            height: 8px;
            border-radius: 4px;
            background: #e2e8f0;
            overflow: hidden;
        }

        .step-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #3b82f6, #2563eb);
            transition: width 0.5s ease-in-out;
        }
    </style>
</head>

<body class="bg-gray-100 min-h-screen">
    <div id="headerRender"></div>
    <div class="flex">
        <div id="asideRender"></div>

        <main class="flex-1 p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-8">
                    <div>
                        <h1 class="text-3xl font-bold text-gray-800">Módulo de Licitaciones</h1>
                        <p class="text-gray-600">Seguimiento cronológico de 32 pasos (Mercado Público)</p>
                    </div>
                    <button onclick="openNewLicitacionModal()"
                        class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-3 rounded-xl shadow-lg flex items-center space-x-2 transition-all transform hover:scale-105">
                        <i class="fas fa-plus"></i>
                        <span>Iniciar Licitación</span>
                    </button>
                </div>

                <!-- Stats Summary -->
                <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                    <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-blue-500">
                        <p class="text-sm font-medium text-gray-500 uppercase">Total Procesos</p>
                        <p class="text-3xl font-bold text-gray-800" id="statTotal">0</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-emerald-500">
                        <p class="text-sm font-medium text-gray-500 uppercase">Abiertas</p>
                        <p class="text-3xl font-bold text-gray-800" id="statAbiertas">0</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-red-400">
                        <p class="text-sm font-medium text-gray-500 uppercase">Cerradas</p>
                        <p class="text-3xl font-bold text-gray-800" id="statCerradas">0</p>
                    </div>
                    <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-green-500">
                        <p class="text-sm font-medium text-gray-500 uppercase">Adjudicadas</p>
                        <p class="text-3xl font-bold text-gray-800" id="statAdjudicadas">0</p>
                    </div>
                </div>

                <!-- Bidding List -->
                <div class="glass-card rounded-2xl shadow-sm overflow-hidden">
                    <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                        <h2 class="text-xl font-semibold text-gray-800">Licitaciones</h2>
                        <div class="flex items-center space-x-2">
                            <span class="text-sm text-gray-500">Filtrar por:</span>
                            <select id="filterEstadoLic" onchange="applyFilter()"
                                class="bg-gray-50 border border-gray-200 text-sm rounded-lg p-1">
                                <option value="">Todas</option>
                                <option value="Abierta">Abiertas</option>
                                <option value="Cerrada">Cerradas</option>
                            </select>
                        </div>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="w-full text-left">
                            <thead class="bg-gray-50 text-gray-500 text-sm uppercase">
                                <tr>
                                    <th class="px-6 py-4 font-semibold">Proyecto</th>
                                    <th class="px-6 py-4 font-semibold">ID Mercado Público</th>
                                    <th class="px-6 py-4 font-semibold">Estado</th>
                                    <th class="px-6 py-4 font-semibold">Progreso (Paso actual)</th>
                                    <th class="px-6 py-4 font-semibold">Monto Estimado</th>
                                    <th class="px-6 py-4 font-semibold">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="licitacionesTable" class="divide-y divide-gray-100">
                                <!-- Carga dinámica -->
                                <tr>
                                    <td colspan="6" class="px-6 py-12 text-center text-gray-400">
                                        <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
                                        <p>Cargando procesos de licitación...</p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal: Nueva Licitación -->
    <div id="modalNueva"
        class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-md p-8 transform transition-all scale-95"
            id="modalContainer">
            <div class="flex justify-between items-center mb-6">
                <h3 class="text-2xl font-bold text-gray-800">Nueva Licitación</h3>
                <button onclick="closeModal()" class="text-gray-400 hover:text-gray-600"><i
                        class="fas fa-times"></i></button>
            </div>

            <!-- Alerta de licitación existente -->
            <div id="alertaLicExistente"
                class="hidden mb-4 p-3 bg-amber-50 border border-amber-200 rounded-xl text-amber-700 text-sm">
                <i class="fas fa-exclamation-triangle mr-1"></i>
                <span id="alertaLicTexto"></span>
            </div>

            <form id="formNueva" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Proyecto</label>
                    <select id="selectProyecto" name="proyecto_id"
                        class="w-full border-gray-200 rounded-xl shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        required>
                        <option value="">Cargando proyectos...</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nombre de la Licitación</label>
                    <input type="text" name="nombre_licitacion" placeholder="Ej: Construcción Plaza Algarrobo"
                        class="w-full border-gray-200 rounded-xl shadow-sm focus:border-blue-500 focus:ring-blue-500"
                        required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">ID Mercado Público (Opcional)</label>
                    <input type="text" name="id_mercado_publico" placeholder="Ej: 1234-56-LP24"
                        class="w-full border-gray-200 rounded-xl shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Presupuesto Estimado</label>
                    <input type="number" name="monto_estimado"
                        class="w-full border-gray-200 rounded-xl shadow-sm focus:border-blue-500 focus:ring-blue-500">
                </div>

                <div class="pt-4 flex space-x-3">
                    <button type="button" onclick="closeModal()"
                        class="flex-1 px-4 py-2 bg-gray-100 text-gray-700 rounded-xl hover:bg-gray-200 font-semibold transition-colors">Cancelar</button>
                    <button type="submit" id="btnIniciarWorkflow"
                        class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-xl hover:bg-blue-700 font-semibold shadow-md transition-colors">Iniciar
                        Workflow</button>
                </div>
            </form>
        </div>
    </div>

    <script src="../../../script/layout.js"></script>
    <script src="../../../script/api.js"></script>
    <script>
        let allLicitaciones = [];

        document.addEventListener('DOMContentLoaded', () => {
            loadLicitaciones();
            loadProyectosForSelect();
        });

        async function loadLicitaciones() {
            try {
                const data = await api.get('/licitaciones');
                allLicitaciones = data;
                renderLicitaciones(data);
                updateStats(data);
            } catch (err) {
                console.error(err);
            }
        }

        function updateStats(data) {
            document.getElementById('statTotal').textContent = data.length;
            const abiertas = data.filter(l => (l.estado_licitacion || 'Abierta') === 'Abierta').length;
            const cerradas = data.filter(l => l.estado_licitacion === 'Cerrada').length;
            document.getElementById('statAbiertas').textContent = abiertas;
            document.getElementById('statCerradas').textContent = cerradas;
        }

        function applyFilter() {
            const filter = document.getElementById('filterEstadoLic').value;
            if (!filter) {
                renderLicitaciones(allLicitaciones);
            } else {
                const filtered = allLicitaciones.filter(l => (l.estado_licitacion || 'Abierta') === filter);
                renderLicitaciones(filtered);
            }
        }

        function renderLicitaciones(data) {
            const table = document.getElementById('licitacionesTable');

            if (data.length === 0) {
                table.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-400">No hay licitaciones que coincidan.</td></tr>`;
                return;
            }

            table.innerHTML = data.map(l => {
                const progress = (l.pasos_completados / 32) * 100;
                const estado = l.estado_licitacion || 'Abierta';
                const estadoBadge = estado === 'Abierta'
                    ? '<span class="bg-emerald-100 text-emerald-700 px-2 py-1 rounded text-xs font-bold uppercase"><i class="fas fa-circle text-[6px] mr-1"></i>Abierta</span>'
                    : '<span class="bg-red-100 text-red-700 px-2 py-1 rounded text-xs font-bold uppercase"><i class="fas fa-lock text-[8px] mr-1"></i>Cerrada</span>';

                return `
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4">
                            <p class="font-bold text-gray-800">${l.nombre_licitacion}</p>
                            <p class="text-xs text-gray-500 italic">${l.proyecto_nombre}</p>
                        </td>
                        <td class="px-6 py-4">
                            <span class="bg-blue-50 text-blue-700 px-2 py-1 rounded text-xs font-mono">${l.id_mercado_publico || 'PENDIENTE'}</span>
                        </td>
                        <td class="px-6 py-4">
                            ${estadoBadge}
                        </td>
                        <td class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <div class="flex-1 step-progress">
                                    <div class="step-progress-fill" style="width: ${progress}%"></div>
                                </div>
                                <span class="text-xs font-semibold text-blue-600">${Math.round(progress)}%</span>
                            </div>
                            <p class="text-[10px] text-gray-400 mt-1 uppercase">Paso ${l.estado_actual_paso || 1} de 32 completado</p>
                        </td>
                        <td class="px-6 py-4 font-semibold text-gray-700">
                            $${Number(l.monto_estimado || 0).toLocaleString()}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <button onclick="window.location.href='seguimiento.html?id=${l.id}'" class="text-blue-600 hover:text-blue-800 font-medium flex items-center space-x-1">
                                <span>Gestionar</span>
                                <i class="fas fa-chevron-right text-xs"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function loadProyectosForSelect() {
            try {
                const data = await api.get('/proyectos');
                const select = document.getElementById('selectProyecto');
                select.innerHTML = '<option value="">-- Seleccione un Proyecto --</option>' +
                    data.map(p => `<option value="${p.id}">${p.nombre}</option>`).join('');

                // Validar en cambio de selección si el proyecto ya tiene licitación abierta
                select.addEventListener('change', () => {
                    const proyectoId = select.value;
                    const alerta = document.getElementById('alertaLicExistente');
                    const btnSubmit = document.getElementById('btnIniciarWorkflow');

                    if (!proyectoId) {
                        alerta.classList.add('hidden');
                        btnSubmit.disabled = false;
                        btnSubmit.classList.remove('opacity-50', 'cursor-not-allowed');
                        return;
                    }

                    // Buscar si hay licitación abierta para ese proyecto
                    const existente = allLicitaciones.find(l =>
                        l.proyecto_id == proyectoId && (l.estado_licitacion || 'Abierta') === 'Abierta'
                    );

                    if (existente) {
                        document.getElementById('alertaLicTexto').textContent =
                            `Este proyecto ya tiene una licitación abierta: "${existente.nombre_licitacion}". Debe cerrarla primero.`;
                        alerta.classList.remove('hidden');
                        btnSubmit.disabled = true;
                        btnSubmit.classList.add('opacity-50', 'cursor-not-allowed');
                    } else {
                        alerta.classList.add('hidden');
                        btnSubmit.disabled = false;
                        btnSubmit.classList.remove('opacity-50', 'cursor-not-allowed');
                    }
                });
            } catch (err) {
                console.error(err);
            }
        }

        function openNewLicitacionModal() {
            document.getElementById('alertaLicExistente').classList.add('hidden');
            document.getElementById('modalNueva').classList.remove('hidden');
            setTimeout(() => document.getElementById('modalContainer').classList.remove('scale-95'), 10);
        }

        function closeModal() {
            document.getElementById('modalContainer').classList.add('scale-95');
            setTimeout(() => document.getElementById('modalNueva').classList.add('hidden'), 200);
        }

        document.getElementById('formNueva').addEventListener('submit', async (e) => {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = Object.fromEntries(formData.entries());

            try {
                const res = await api.post('/licitaciones', data);
                if (res.id) {
                    closeModal();
                    window.location.href = `seguimiento.html?id=${res.id}`;
                }
            } catch (err) {
                // El backend devuelve 409 si ya existe licitación abierta
                const msg = err.message || 'Error al crear licitación';
                alert(msg);
            }
        });
    </script>
</body>

</html>