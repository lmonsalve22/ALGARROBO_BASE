<!DOCTYPE html>
<html lang="es">

<head>
    <script src="../../../script/router.js"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cronograma de Licitaciones - Algarrobo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#6366f1',
                    }
                }
            }
        }
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --gradient-primary: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
        }

        body {
            background-color: #f8fafc;
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 40px -10px rgba(0, 0, 0, 0.08);
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .calendar-day {
            min-height: 140px;
            transition: all 0.2s;
        }

        .calendar-day:hover {
            background-color: #f8fafc;
        }

        .calendar-day.other-month {
            background-color: #f1f5f9;
            opacity: 0.5;
        }

        .hito-item {
            font-size: 0.65rem;
            padding: 4px 8px;
            border-radius: 6px;
            margin-top: 4px;
            display: block;
            cursor: pointer;
            border-left: 3px solid transparent;
            transition: all 0.2s;
        }

        .hito-item:hover {
            transform: scale(1.02);
        }
    </style>
</head>

<body class="bg-slate-50 min-h-screen">
    <div id="headerRender"></div>
    <div class="flex">
        <div id="asideRender"></div>
        <main class="flex-1 p-8">
            <div class="max-w-7xl mx-auto">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <h1 class="text-3xl font-bold text-slate-800 tracking-tight">Cronograma de Licitaciones</h1>
                        <p class="text-slate-500 font-medium">Panel consolidado de hitos y plazos críticos</p>
                    </div>
                    <div class="flex bg-slate-200 p-1 rounded-xl">
                        <button onclick="window.switchView('calendar')" id="btnViewCalendar"
                            class="px-5 py-2 rounded-lg font-bold text-sm bg-white shadow-sm text-blue-600 transition-all">Calendario</button>
                        <button onclick="window.switchView('gantt')" id="btnViewGantt"
                            class="px-5 py-2 rounded-lg font-bold text-sm text-slate-600 hover:text-slate-800 transition-all">Línea
                            de Tiempo</button>
                    </div>
                </div>

                <!-- Barra de Filtros Integrada -->
                <div
                    class="glass-panel flex gap-4 p-4 rounded-2xl shadow-sm mb-6 w-full items-center bg-white justify-between animate-fade-in">
                    <div class="flex gap-4 flex-1">
                        <select id="filterProyecto" onchange="window.updateFilters()"
                            class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 font-bold">
                            <option value="">Todos los Proyectos</option>
                        </select>
                        <select id="filterEstado" onchange="window.updateFilters()"
                            class="bg-slate-50 border border-slate-200 text-slate-700 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5 font-bold">
                            <option value="">Cualquier Estado</option>
                            <option value="Pendiente">Pendiente</option>
                            <option value="En Proceso">En Proceso</option>
                            <option value="Completado">Completado</option>
                            <option value="Atrasado">Atrasado</option>
                        </select>
                    </div>
                    <button onclick="window.fetchEvents()"
                        class="text-slate-400 hover:text-blue-500 p-2 transition-colors">
                        <i class="fas fa-sync-alt"></i> Recargar
                    </button>
                </div>

                <div id="calendarViewContainer"
                    class="glass-panel rounded-[2.5rem] shadow-2xl overflow-hidden bg-white border border-slate-200 transition-opacity duration-300 animate-fade-in"
                    style="animation-delay: 0.1s">
                    <!-- Calendar Header -->
                    <div class="p-8 bg-slate-900 text-white flex justify-between items-center"
                        style="background: var(--gradient-primary)">
                        <div class="flex items-center space-x-6">
                            <button onclick="window.changeMonth(-1)"
                                class="w-10 h-10 flex items-center justify-center hover:bg-slate-800 rounded-full transition-all">
                                <i class="fas fa-chevron-left"></i>
                            </button>
                            <h2 id="currentMonthYear"
                                class="text-2xl font-black uppercase tracking-widest min-w-[200px] text-center">
                                Cargando...</h2>
                            <button onclick="window.changeMonth(1)"
                                class="w-10 h-10 flex items-center justify-center hover:bg-slate-800 rounded-full transition-all">
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                        <div class="flex items-center space-x-4">
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 rounded-full bg-blue-500"></div>
                                <span
                                    class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Aperturas</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 rounded-full bg-green-500"></div>
                                <span
                                    class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Preguntas</span>
                            </div>
                            <div class="flex items-center space-x-2">
                                <div class="w-3 h-3 rounded-full bg-red-500"></div>
                                <span
                                    class="text-[10px] uppercase font-bold text-slate-400 tracking-wider">Cierres</span>
                            </div>
                        </div>
                    </div>

                    <!-- Weekdays -->
                    <div class="grid grid-cols-7 text-center border-b border-slate-100 bg-slate-50/50">
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Lunes</div>
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Martes</div>
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Miércoles
                        </div>
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Jueves</div>
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Viernes</div>
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Sábado</div>
                        <div class="py-4 text-[10px] font-black text-slate-400 uppercase tracking-[0.2em]">Domingo</div>
                    </div>

                    <!-- Calendar Grid (Event Delegation) -->
                    <div id="calendarGrid" class="grid grid-cols-7 divide-x divide-y divide-slate-100 bg-white">
                        <!-- Dinámico -->
                    </div>
                </div>

                <!-- Timeline/Gantt View -->
                <div id="ganttViewContainer"
                    class="hidden glass-card rounded-[2.5rem] shadow-2xl p-8 bg-white border border-slate-200 transition-opacity duration-300 opacity-0">
                    <div class="flex justify-between items-center mb-6 border-b border-slate-100 pb-4">
                        <h2 class="text-xl font-bold text-slate-800">Línea de Tiempo Operativa</h2>
                    </div>
                    <div id="ganttList" class="space-y-6">
                        <!-- Linéas de tiempo dinámicas -->
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Modal Detalle Evento -->
    <div id="modalEvento"
        class="fixed inset-0 bg-black/60 backdrop-blur-sm hidden z-[9999] flex items-center justify-center p-4">
        <div class="bg-white rounded-3xl shadow-2xl w-full max-w-lg overflow-hidden transform transition-all">
            <div class="p-6 border-b border-gray-100 flex justify-between items-start bg-slate-50">
                <div>
                    <span id="modalEventoEstado"
                        class="text-[10px] font-black tracking-widest uppercase px-2 py-1 rounded-md bg-blue-100 text-blue-700 mb-2 inline-block">ESTADO</span>
                    <h3 id="modalEventoPaso" class="text-xl font-bold text-slate-800">Nombre del Paso</h3>
                    <p id="modalEventoLicitacion" class="text-sm font-medium text-slate-500 mt-1">Nombre Licitación</p>
                </div>
                <button onclick="window.cerrarModalEvento()"
                    class="text-gray-400 hover:text-red-500 hover:bg-red-50 p-2 rounded-xl transition-colors">
                    <i class="fas fa-times text-xl"></i>
                </button>
            </div>

            <div class="p-6 space-y-4">
                <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div class="w-10 h-10 rounded-full bg-indigo-100 text-indigo-600 flex items-center justify-center">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Fecha Designada</p>
                        <p id="modalEventoFecha" class="font-medium text-slate-800">Fecha del evento</p>
                    </div>
                </div>

                <div class="flex items-center gap-3 p-4 bg-slate-50 rounded-2xl border border-slate-100">
                    <div
                        class="w-10 h-10 rounded-full bg-emerald-100 text-emerald-600 flex items-center justify-center">
                        <i class="fas fa-project-diagram"></i>
                    </div>
                    <div>
                        <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Proyecto Relacionado
                        </p>
                        <p id="modalEventoProyecto" class="font-medium text-slate-800">Nombre del proyecto</p>
                    </div>
                </div>
            </div>

            <div class="p-6 bg-slate-50 border-t border-slate-100 flex gap-3">
                <button onclick="window.cerrarModalEvento()"
                    class="flex-1 px-4 py-3 bg-white border border-slate-200 text-slate-700 rounded-xl font-bold hover:bg-slate-50 transition-colors">
                    Volver
                </button>
                <a id="modalEventoLink" href="#"
                    class="flex-1 px-4 py-3 bg-blue-600 text-white text-center rounded-xl font-bold shadow-lg shadow-blue-500/30 hover:bg-blue-700 transition-colors">
                    Ficha de Seguimiento Completo
                </a>
            </div>
        </div>
    </div>

    <script src="../../../script/layout.js"></script>
    <script src="../../../script/api.js"></script>
    <script>
        // 1. Estado Centralizado
        const state = {
            events: [],
            filteredEvents: [],
            date: new Date(),
            view: 'calendar',
            filters: {
                proyecto: '',
                estado: ''
            }
        };

        // Utilidad de Sanitización HTML
        const escapeHTML = (str) => {
            if (!str) return '';
            return str.toString()
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        };

        // ============================================
        // FIX: Parseo seguro de fechas (patrón secplac)
        // Extrae YYYY-MM-DD como string puro, sin timezone
        // ============================================
        function safeDateString(dateStr) {
            if (!dateStr) return null;
            // Si ya es string YYYY-MM-DD, retornar directo
            if (typeof dateStr === 'string') {
                const match = dateStr.match(/^(\d{4}-\d{2}-\d{2})/);
                if (match) return match[1];
            }
            // Fallback: parsear y usar componentes UTC
            var d = new Date(dateStr);
            if (isNaN(d.getTime())) return null;
            var year = d.getUTCFullYear();
            var month = String(d.getUTCMonth() + 1).padStart(2, '0');
            var day = String(d.getUTCDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Cache Handler usando SessionStorage (5 minutos)
        const CACHE_KEY = 'eventsCache';
        const getCachedEvents = () => {
            const cached = sessionStorage.getItem(CACHE_KEY);
            if (cached) {
                const parsed = JSON.parse(cached);
                if (Date.now() - parsed.timestamp < 300000) return parsed.data; // 5 mins
            }
            return null;
        };
        const setCachedEvents = (data) => {
            sessionStorage.setItem(CACHE_KEY, JSON.stringify({ data, timestamp: Date.now() }));
        };

        document.addEventListener('DOMContentLoaded', async () => {
            // Delegación de eventos maestra en el calendario
            document.getElementById('calendarGrid').addEventListener('click', (e) => {
                const hitoNode = e.target.closest('[data-workflow-id]');
                if (hitoNode) window.abrirModalEventoById(hitoNode.dataset.workflowId);
            });

            await window.fetchEvents();
        });

        window.fetchEvents = async function () {
            try {
                const cached = getCachedEvents();
                if (cached) {
                    state.events = cached;
                    console.log("=== EVENTOS DESDE CACHE ===", state.events);
                } else {
                    state.events = await api.get('/licitaciones/calendario');
                    setCachedEvents(state.events);
                    console.log("=== EVENTOS CARGADOS DESDE API ===", state.events);
                }
                populateProjectFilter();
                window.updateFilters();
            } catch (err) {
                console.error('Error fetching calendar data:', err);
                state.events = [];
            }
        };

        function populateProjectFilter() {
            const select = document.getElementById('filterProyecto');
            const proyectos = [...new Set(state.events.map(e => e.proyecto_nombre).filter(Boolean))].sort();

            // Re-render select options
            let opts = `<option value="">Todos los Proyectos</option>`;
            proyectos.forEach(p => opts += `<option value="${escapeHTML(p)}">${escapeHTML(p)}</option>`);
            select.innerHTML = opts;
            select.value = state.filters.proyecto;
        }

        window.updateFilters = function () {
            state.filters.proyecto = document.getElementById('filterProyecto').value;
            state.filters.estado = document.getElementById('filterEstado').value;

            state.filteredEvents = state.events.filter(ev => {
                const matchProy = !state.filters.proyecto || ev.proyecto_nombre === state.filters.proyecto;
                const matchState = !state.filters.estado || ev.estado === state.filters.estado;
                return matchProy && matchState;
            });

            if (state.view === 'calendar') renderCalendar();
            else renderGantt();
        };

        // Renderizado del calendario con fechas seguras
        function renderCalendar() {
            const grid = document.getElementById('calendarGrid');
            const header = document.getElementById('currentMonthYear');

            const year = state.date.getFullYear();
            const month = state.date.getMonth();

            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);

            const monthNames = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            header.textContent = `${monthNames[month]} ${year}`;

            let startingDay = firstDay.getDay() - 1;
            if (startingDay === -1) startingDay = 6;

            const prevLastDay = new Date(year, month, 0).getDate();
            const totalCells = startingDay + lastDay.getDate();
            const nextPadding = (7 - (totalCells % 7)) % 7;

            let gridHTML = '';

            for (let i = startingDay; i > 0; i--) {
                gridHTML += generateDayHTML(prevLastDay - i + 1, true, false, null);
            }

            // FIX: Generar fecha de hoy como YYYY-MM-DD local (sin timezone)
            const now = new Date();
            const todayStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;

            for (let i = 1; i <= lastDay.getDate(); i++) {
                const dayStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(i).padStart(2, '0')}`;
                const isToday = todayStr === dayStr;
                gridHTML += generateDayHTML(i, false, isToday, dayStr);
            }

            for (let i = 1; i <= nextPadding; i++) {
                gridHTML += generateDayHTML(i, true, false, null);
            }

            grid.innerHTML = gridHTML;
        }

        function generateDayHTML(day, isOtherMonth, isToday, dateStr) {
            let html = `<div class="calendar-day p-4 ${isOtherMonth ? 'other-month' : ''}">`;

            html += `<div class="flex justify-between items-start mb-2">
                        <span class="text-sm ${isToday ? 'bg-blue-600 text-white w-7 h-7 flex items-center justify-center rounded-full font-bold shadow-md' : 'text-slate-400 font-bold'}">${day}</span>
                     </div>`;

            if (!isOtherMonth && dateStr) {
                const evs = getEventsForDateStr(dateStr);
                html += evs.map(ev => {
                    const colorClass = getEventCSSClasses(ev.paso_orden);
                    return `
                    <div class="hito-item ${colorClass}" data-workflow-id="${ev.workflow_id}" title="${escapeHTML(ev.proyecto_nombre)}&#10;${escapeHTML(ev.paso_nombre)}">
                        <div class="flex justify-between items-center mb-0.5">
                            <div class="font-black truncate uppercase text-[9px]">${escapeHTML(ev.paso_nombre)}</div>
                            <div class="text-[8px] font-bold px-1 rounded bg-white/50 uppercase">${escapeHTML(ev.estado)}</div>
                        </div>
                        <div class="truncate opacity-90 text-[10px]">${escapeHTML(ev.nombre_licitacion)}</div>
                    </div>`;
                }).join('');
            }
            html += `</div>`;
            return html;
        }

        // FIX: Comparación de fechas como strings YYYY-MM-DD puro (sin Date objects)
        function getEventsForDateStr(targetStr) {
            return state.filteredEvents.filter(ev => {
                const rawDate = ev.fecha_real || ev.fecha_planificada;
                if (!rawDate) return false;
                const evDateStr = safeDateString(rawDate);
                return evDateStr === targetStr;
            });
        }

        // Aislación CSS Avanzada de Tailwind Utilities
        function getEventCSSClasses(orden) {
            if (orden === 15) return 'bg-blue-100 text-blue-800 border-l-blue-600'; // Apertura
            if ([3, 5, 10, 12].includes(orden)) return 'bg-emerald-100 text-emerald-800 border-l-emerald-500'; // Preguntas
            if ([18, 20, 21, 23, 25].includes(orden)) return 'bg-red-100 text-red-800 border-l-red-500'; // Cierres
            return 'bg-slate-100 text-slate-700 border-l-slate-400';
        }

        // Throttle/Debounce básico para cambio de mes
        let monthChangeTimeout = null;
        window.changeMonth = function (offset) {
            if (monthChangeTimeout) clearTimeout(monthChangeTimeout);
            monthChangeTimeout = setTimeout(() => {
                state.date.setMonth(state.date.getMonth() + offset);
                renderCalendar();
            }, 50);
        };

        window.abrirModalEventoById = function (wId) {
            const ev = state.events.find(e => e.workflow_id == wId);
            if (ev) window.abrirModalEvento(ev);
        };

        window.abrirModalEvento = function (ev) {
            document.getElementById('modalEventoPaso').textContent = ev.paso_nombre;
            document.getElementById('modalEventoLicitacion').textContent = ev.nombre_licitacion;
            document.getElementById('modalEventoEstado').textContent = ev.estado;
            document.getElementById('modalEventoProyecto').textContent = ev.proyecto_nombre || 'N/A';

            // FIX: Usar safeDateString para mostrar la fecha correcta
            const rawDate = ev.fecha_real || ev.fecha_planificada;
            document.getElementById('modalEventoFecha').textContent = safeDateString(rawDate) || 'Sin fecha';

            document.getElementById('modalEventoLink').href = `seguimiento.html?id=${ev.licitacion_id}`;
            document.getElementById('modalEvento').classList.remove('hidden');
        };

        window.cerrarModalEvento = function () {
            document.getElementById('modalEvento').classList.add('hidden');
        };

        window.switchView = function (viewStr) {
            state.view = viewStr;
            const calContainer = document.getElementById('calendarViewContainer');
            const ganttContainer = document.getElementById('ganttViewContainer');
            const btnCal = document.getElementById('btnViewCalendar');
            const btnGantt = document.getElementById('btnViewGantt');

            if (viewStr === 'calendar') {
                calContainer.classList.remove('hidden');
                setTimeout(() => calContainer.classList.remove('opacity-0'), 10);
                ganttContainer.classList.add('opacity-0');
                setTimeout(() => ganttContainer.classList.add('hidden'), 300);

                btnCal.className = "px-5 py-2 rounded-lg font-bold text-sm bg-white shadow-sm text-blue-600 transition-all";
                btnGantt.className = "px-5 py-2 rounded-lg font-bold text-sm text-slate-600 hover:text-slate-800 transition-all";
                renderCalendar();
            } else {
                ganttContainer.classList.remove('hidden');
                setTimeout(() => ganttContainer.classList.remove('opacity-0'), 10);
                calContainer.classList.add('opacity-0');
                setTimeout(() => calContainer.classList.add('hidden'), 300);

                btnGantt.className = "px-5 py-2 rounded-lg font-bold text-sm bg-white shadow-sm text-blue-600 transition-all";
                btnCal.className = "px-5 py-2 rounded-lg font-bold text-sm text-slate-600 hover:text-slate-800 transition-all";
                renderGantt();
            }
        };

        // FIX: Parseo de timestamp para ordenamiento en Gantt, usando UTC
        function parseStandardDate(str) {
            if (!str) return 0;
            // Si es string YYYY-MM-DD, parsear manualmente en UTC
            if (typeof str === 'string') {
                const match = str.match(/^(\d{4})-(\d{2})-(\d{2})/);
                if (match) return Date.UTC(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
            }
            return new Date(str).getTime() || 0;
        }

        // Agrupación Temporal en Gantt
        function renderGantt() {
            const list = document.getElementById('ganttList');
            if (state.filteredEvents.length === 0) {
                list.innerHTML = `<div class="p-8 text-center text-slate-400 font-bold">No hay eventos que coincidan.</div>`;
                return;
            }

            const grouped = {};
            state.filteredEvents.forEach(ev => {
                if (!grouped[ev.licitacion_id]) {
                    grouped[ev.licitacion_id] = {
                        id: ev.licitacion_id,
                        nombre: ev.nombre_licitacion,
                        proyecto: ev.proyecto_nombre,
                        eventos: []
                    };
                }
                grouped[ev.licitacion_id].eventos.push(ev);
            });

            list.innerHTML = Object.values(grouped).map(g => {
                g.eventos.sort((a, b) => parseStandardDate(a.fecha_real || a.fecha_planificada) - parseStandardDate(b.fecha_real || b.fecha_planificada));

                let prevTime = null;
                const gEventsHtml = g.eventos.map(ev => {
                    const time = parseStandardDate(ev.fecha_real || ev.fecha_planificada);

                    let marginPx = 24;
                    if (prevTime && time) {
                        const diffDays = Math.abs((time - prevTime) / (1000 * 3600 * 24));
                        marginPx = Math.min(100, Math.max(24, diffDays * 5));
                    }
                    if (time) prevTime = time;

                    // FIX: Usar safeDateString en vez de reconstruir con Date local
                    const dateStr = safeDateString(ev.fecha_real || ev.fecha_planificada) || "Sin definir";

                    const isOk = ev.estado === 'Completado';
                    const dotColor = isOk ? 'bg-emerald-500 ring-emerald-100' : 'bg-blue-500 ring-blue-100';
                    return `
                        <div class="flex flex-col items-center min-w-[100px] max-w-[120px] group cursor-pointer shrink-0" 
                             style="margin-left: ${marginPx}px" 
                             onclick='window.abrirModalEventoById(${ev.workflow_id})'>
                             <div class="text-[9px] font-bold text-slate-500 mb-2">${dateStr}</div>
                             <div class="w-4 h-4 rounded-full ${dotColor} ring-4 shadow-sm group-hover:scale-125 transition-transform flex items-center justify-center">
                                ${isOk ? '<i class="fas fa-check text-[6px] text-white"></i>' : ''}
                             </div>
                             <div class="text-[10px] font-bold text-slate-700 mt-2 text-center leading-tight transition-colors group-hover:text-blue-600">${escapeHTML(ev.paso_nombre)}</div>
                             <div class="text-[8px] px-2 py-0.5 rounded-full ${isOk ? 'bg-emerald-100 text-emerald-700' : 'bg-slate-200 text-slate-600'} mt-1 font-bold truncate max-w-[90px]">${escapeHTML(ev.estado)}</div>
                        </div>`;
                }).join('');

                return `
                <div class="bg-slate-50 flex flex-col rounded-2xl p-6 border border-slate-100 hover:shadow-md transition-shadow">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <div>
                            <h3 class="font-bold text-slate-800 text-base flex items-center gap-2 max-w-lg truncate"><i class="fas fa-file-contract text-blue-500"></i> ${escapeHTML(g.nombre)}</h3>
                            <p class="text-[10px] text-slate-500 uppercase tracking-widest font-bold mt-1">${escapeHTML(g.proyecto)}</p>
                        </div>
                        <a href="seguimiento.html?id=${g.id}" class="px-4 py-2 shrink-0 bg-white rounded-lg border border-slate-200 text-blue-600 font-bold text-xs hover:bg-blue-50 transition-colors shadow-sm focus:ring-4 ring-blue-100/50">Ver Ficha Completa</a>
                    </div>
                    
                    <div class="relative pt-6 pb-4 -ml-4 pl-4 overflow-hidden">
                        <div class="absolute top-[40px] left-0 w-[200%] h-1 bg-slate-200 rounded-full z-0"></div>
                        <div class="flex justify-start relative z-10 overflow-x-auto gap-0 pb-4 custom-scrollbar px-2">
                           ${gEventsHtml}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar {
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }
    </style>
</body>

</html>