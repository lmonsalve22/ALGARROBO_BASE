<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Acceso - Reportes Ciudadanos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="../estilos/styles.css">
</head>

<body>
    <div id="login-app" class="welcome-container"
        style="padding:20px; max-width:400px; margin:0 auto; min-height:100vh; display:flex; flex-direction:column; justify-content:center;">

        <!-- Vista Bienvenida -->
        <div id="view-welcome" style="text-align:center;">
            <div class="logo-container" style="margin-bottom:20px;">
                <i class="fas fa-city" style="font-size:3rem; color:var(--primary);"></i>
            </div>
            <h1>Reportes Ciudadanos</h1>
            <p class="subtitle" style="margin-bottom:30px;">Mejoremos nuestra ciudad juntos</p>

            <button class="btn-primary" onclick="showView('login')">Iniciar Sesión</button>
            <button class="btn-secondary" onclick="showView('register')">Registrarse</button>
        </div>

        <!-- Vista Login -->
        <div id="view-login" style="display:none;">
            <button onclick="showView('welcome')"
                style="background:none;border:none;font-size:1.2rem;margin-bottom:10px;"><i
                    class="fas fa-arrow-left"></i></button>
            <h2>Iniciar Sesión</h2>
            <form id="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="login-email" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="login-password" required class="form-control">
                </div>
                <button type="submit" class="btn-submit">Entrar</button>
            </form>
            <div id="login-error" style="color:red; margin-top:10px; text-align:center;"></div>
        </div>

        <!-- Vista Registro -->
        <div id="view-register" style="display:none;">
            <button onclick="showView('welcome')"
                style="background:none;border:none;font-size:1.2rem;margin-bottom:10px;"><i
                    class="fas fa-arrow-left"></i></button>
            <h2>Crear Cuenta</h2>
            <form id="register-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <label>Nombre Completo</label>
                    <input type="text" id="reg-nombre" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="reg-email" required class="form-control">
                </div>
                <div class="form-group">
                    <label>Contraseña</label>
                    <input type="password" id="reg-password" required minlength="6" class="form-control">
                </div>
                <button type="submit" class="btn-submit">Registrarse</button>
            </form>
            <div id="reg-error" style="color:red; margin-top:10px; text-align:center;"></div>
        </div>

    </div>

    <script src="../scripts/api.js?v=2"></script>
    <script>
        // Verificar sesión existente
        const token = localStorage.getItem('token');
        const userStr = localStorage.getItem('user');

        if (token && userStr) {
            redirectUser(JSON.parse(userStr));
        }

        function showView(name) {
            ['welcome', 'login', 'register'].forEach(v => {
                document.getElementById('view-' + v).style.display = (v === name) ? 'block' : 'none';
            });
            // Limpiar errores
            document.getElementById('login-error').textContent = '';
            document.getElementById('reg-error').textContent = '';
        }

        function redirectUser(user) {
            const nivel = parseInt(user.nivel_acceso || 0);
            //console.log('Nivel de acceso:', nivel);
            if (nivel > 0) {
                window.location.href = 'funcionario.html';
            } else {
                window.location.href = 'vecino.html';
            }
        }

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const pwd = document.getElementById('login-password').value;
            const errDiv = document.getElementById('login-error');

            try {
                errDiv.textContent = 'Autenticando...';
                const data = await api.login(email, pwd);

                // Guardar sesión
                api.setToken(data.token);
                localStorage.setItem('user', JSON.stringify(data.user));

                redirectUser(data.user);
            } catch (error) {
                errDiv.textContent = 'Credenciales inválidas';
            }
        }

        async function handleRegister(e) {
            e.preventDefault();
            const nombre = document.getElementById('reg-nombre').value;
            const email = document.getElementById('reg-email').value;
            const pwd = document.getElementById('reg-password').value;
            const errDiv = document.getElementById('reg-error');

            try {
                errDiv.textContent = 'Registrando...';
                await api.register(nombre, email, pwd);
                alert('Registro exitoso. Por favor inicia sesión.');
                showView('login');
            } catch (error) {
                errDiv.textContent = error.message || 'Error en registro';
            }
        }
    </script>
</body>

</html>