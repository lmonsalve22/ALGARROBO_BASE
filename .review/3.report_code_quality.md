# ğŸ” REPORTE: code-reviewer â€” Clean Code & Web Performance
**Fecha**: 2026-02-19 | **Agente**: code-reviewer v2.1 | **EstÃ¡ndar**: Clean Code / LCP / INP / 60fps

---

## CQ-001 Â· DOM Thrashing: 15+ getElementById secuenciales sin cachÃ©
**ğŸ’¡ Hallazgo**: `updateDashboard()` realiza 15+ llamadas a `document.getElementById()` consecutivas. Cada acceso fuerza al browser a resolver el selector contra el live DOM tree.
**ğŸ—ï¸ Principio/MÃ©trica**: Layout Thrashing / INP
**ğŸ“ UbicaciÃ³n**: `frontend/division/secplan/admin_general/dashboard.html:731-798`
**ğŸ› ï¸ Refactor Sugerido**:
```javascript
// BEFORE: 15+ getElementById individuales
document.getElementById('totalProjects').textContent = projects.length;
document.getElementById('activeProjects').textContent = projects.length;
document.getElementById('statInversion').textContent = utils.formatCompactNumber(totalInversion);
// ... 12 mÃ¡s

// AFTER: CachÃ© de nodos + batch update
const DOM = {
    totalProjects: document.getElementById('totalProjects'),
    activeProjects: document.getElementById('activeProjects'),
    statInversion: document.getElementById('statInversion'),
    // ... todos los elementos
};

function updateDashboard(projects) {
    const data = computeKPIs(projects); // Separar cÃ¡lculo de rendering
    Object.entries(data).forEach(([key, value]) => {
        if (DOM[key]) DOM[key].textContent = value;
    });
}
```
**ğŸ“ˆ Beneficio**: Performance (reduce tree lookups) + Mantenibilidad (separaciÃ³n compute/render)

---

## CQ-002 Â· FunciÃ³n `logout()` duplicada en 2 archivos
**ğŸ’¡ Hallazgo**: `logout()` existe en `router.js:61-68` y `layout.js:298-304` con implementaciones ligeramente diferentes (router limpia 5 keys, layout limpia 4 keys y usa key `'token'` en vez de `'authToken'`).
**ğŸ—ï¸ Principio/MÃ©trica**: DRY / Single Source of Truth
**ğŸ“ UbicaciÃ³n**: `router.js:61` vs `layout.js:298`
**ğŸ› ï¸ Refactor Sugerido**:
```javascript
// router.js â€” ÃšNICA definiciÃ³n:
function logout() {
    ['isLoggedIn', 'authToken', 'userData', 'user_data', 'user', 'token'].forEach(
        k => localStorage.removeItem(k)
    );
    window.location.href = `${BASE}/frontend/index.html`;
}
// layout.js â€” ELIMINAR la funciÃ³n duplicada (lÃ­neas 298-304)
```
**ğŸ“ˆ Beneficio**: Mantenibilidad â€” evita sesiones "zombie" donde router limpia keys que layout no.

---

## CQ-003 Â· `toggleUserMenu()` y `toggleNotifications()` duplicadas
**ğŸ’¡ Hallazgo**: Ambas funciones estÃ¡n definidas en `router.js:70-77` y `layout.js:287-296`. La de router es la que se invoca primero (se carga antes), la de layout la sobrescribe sin aviso.
**ğŸ—ï¸ Principio/MÃ©trica**: DRY / Naming Collision
**ğŸ“ UbicaciÃ³n**: `router.js:70-77` vs `layout.js:287-296`
**ğŸ› ï¸ Refactor Sugerido**: Eliminar las definiciones en `layout.js:287-296` y `layout.js:306-311`. Mantener solo las de `router.js`.
**ğŸ“ˆ Beneficio**: Legibilidad â€” elimina shadowing implÃ­cito de funciones globales.

---

## CQ-004 Â· Listeners globales de click redundantes
**ğŸ’¡ Hallazgo**: Dos event listeners `document.addEventListener('click', ...)` para cerrar el menÃº de usuario. Uno en `router.js:81` (usa `closest('button[onclick="toggleUserMenu()"]')`) y otro en `layout.js:306` (usa `closest('[onclick*="toggleUserMenu"]')`). Diferentes selectores, misma intenciÃ³n.
**ğŸ—ï¸ Principio/MÃ©trica**: DRY / Memory Overhead
**ğŸ“ UbicaciÃ³n**: `router.js:81-88` + `layout.js:306-311`
**ğŸ› ï¸ Refactor Sugerido**: Mantener solo uno (preferir `layout.js` por ser mÃ¡s genÃ©rico con `[onclick*=...]`). Eliminar el de `router.js`.
**ğŸ“ˆ Beneficio**: Performance â€” reduce event handlers globales a la mitad.

---

## CQ-005 Â· Dead Code: `strToBytes`, `bytesToStr`, `getKey` posiblemente sin consumo
**ğŸ’¡ Hallazgo**: Las funciones `strToBytes()`, `bytesToStr()` y `getKey()` en `router.js:91-115` no son invocadas en ningÃºn archivo HTML ni JS del proyecto (segÃºn grep). La API key que decodifican no tiene un consumidor visible.
**ğŸ—ï¸ Principio/MÃ©trica**: Dead Code / YAGNI
**ğŸ“ UbicaciÃ³n**: `frontend/script/router.js:91-115`
**ğŸ› ï¸ Refactor Sugerido**: Verificar con stakeholder si `getKey()` se usa dinÃ¡micamente. Si NO: eliminar las 3 funciones. Si SÃ: mover a mÃ³dulo separado y documentar su propÃ³sito.
**ğŸ“ˆ Beneficio**: Legibilidad + Seguridad (reduce superficie de exposiciÃ³n de key).

---

## CQ-006 Â· Estilos inline repetidos en metric-cards
**ğŸ’¡ Hallazgo**: `dashboard.html` repite inline styles para `icon-circle` en 8 de 12 tarjetas KPI. Solo 4 usan clases CSS predefinidas (`.blue`, `.green`, `.purple`, `.orange`), las restantes usan `style="background: linear-gradient(...);"` inline.
**ğŸ—ï¸ Principio/MÃ©trica**: DRY / Mantenibilidad CSS
**ğŸ“ UbicaciÃ³n**: `dashboard.html:311-404` (filas 2 y 3 de KPIs)
**ğŸ› ï¸ Refactor Sugerido**:
```css
/* Agregar clases para los colores faltantes: */
.icon-circle.red    { background: linear-gradient(135deg, #fee2e2, #fecaca); color: #dc2626; }
.icon-circle.pink   { background: linear-gradient(135deg, #fce7f3, #fbcfe8); color: #db2777; }
.icon-circle.teal   { background: linear-gradient(135deg, #ccfbf1, #99f6e4); color: #0d9488; }
.icon-circle.amber  { background: linear-gradient(135deg, #fef3c7, #fde68a); color: #d97706; }
.icon-circle.indigo { background: linear-gradient(135deg, #e0e7ff, #c7d2fe); color: #4f46e5; }
.icon-circle.cyan   { background: linear-gradient(135deg, #cffafe, #a5f3fc); color: #0891b2; }
.icon-circle.rose   { background: linear-gradient(135deg, #ffe4e6, #fecdd3); color: #e11d48; }
.icon-circle.lime   { background: linear-gradient(135deg, #ecfccb, #d9f99d); color: #65a30d; }
```
**ğŸ“ˆ Beneficio**: Mantenibilidad â€” cambios de tema en un solo lugar.

---

## CQ-007 Â· `renderHeader()` y `renderSidebar()` ejecutan sin DOMContentLoaded
**ğŸ’¡ Hallazgo**: `layout.js:313-314` ejecuta `renderHeader("headerRender")` y `renderSidebar("asideRender")` como top-level statements. Si el script se carga en `<head>`, los contenedores no existen aÃºn en el DOM.
**ğŸ—ï¸ Principio/MÃ©trica**: Execution Order / Robustez
**ğŸ“ UbicaciÃ³n**: `frontend/script/layout.js:313-314`
**ğŸ› ï¸ Refactor Sugerido**: El null-check `if (!container) return;` en ambas funciones mitiga el crash, pero el renderizado simplemente no ocurre. AnÃ¡lisis indica que el `<script src="layout.js">` se carga al final del `<body>` (lÃ­nea 703 de `dashboard.html`), por lo que funciona en la prÃ¡ctica. Sin embargo, no hay garantÃ­a explÃ­cita.
**ğŸ“ˆ Beneficio**: Robustez â€” agregar DOMContentLoaded o `defer` como garantÃ­a formal.

---

## CQ-008 Â· Archivos monolÃ­ticos: dashboard.html > 1000 lÃ­neas
**ğŸ’¡ Hallazgo**: `admin_general/dashboard.html` tiene 1097 lÃ­neas mezclando HTML, CSS inline y JavaScript (~400 lÃ­neas de JS). No hay separaciÃ³n de archivos para la lÃ³gica de charts.
**ğŸ—ï¸ Principio/MÃ©trica**: Single Responsibility / Cohesion
**ğŸ“ UbicaciÃ³n**: `frontend/division/secplan/admin_general/dashboard.html`
**ğŸ› ï¸ Refactor Sugerido**: Extraer lÃ³gica JS a `dashboard.js` y estilos a `dashboard.css` o al tema compartido.
**ğŸ“ˆ Beneficio**: Mantenibilidad + Cacheo de recursos estÃ¡ticos.

---

## CQ-009 Â· `help.js`: Objeto `helpContent` de 377 lÃ­neas hardcoded
**ğŸ’¡ Hallazgo**: Todo el contenido de ayuda (11 secciones, ~375 lÃ­neas) estÃ¡ embebido como objeto JS literal en `help.js`. Cualquier cambio de texto requiere modificar cÃ³digo fuente.
**ğŸ—ï¸ Principio/MÃ©trica**: Data/Logic Separation
**ğŸ“ UbicaciÃ³n**: `frontend/script/help.js:5-377`
**ğŸ› ï¸ Refactor Sugerido**: Mover a `help-content.json` y cargar con `fetch()` o importar como ESM.
**ğŸ“ˆ Beneficio**: Mantenibilidad â€” permite ediciÃ³n por no-desarrolladores y localizaciÃ³n.

---

## ğŸ“Š RESUMEN

| CategorÃ­a | Cantidad |
|-----------|----------|
| Performance (DOM/Render) | 2 (CQ-001, CQ-007) |
| DRY / DuplicaciÃ³n | 4 (CQ-002, CQ-003, CQ-004, CQ-006) |
| Dead Code | 1 (CQ-005) |
| Mantenibilidad | 2 (CQ-008, CQ-009) |
