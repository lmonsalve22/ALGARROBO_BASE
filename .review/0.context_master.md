# ğŸ“˜ CONTEXTO MAESTRO: ALGARROBO_BASE â€” Geoportal Municipal

## ğŸ“‹ METADATA
- **Fecha**: 2026-02-19T20:51:00-03:00
- **Stack**: Vanilla JS (TailwindCSS CDN) + Python FastAPI (Backend)
- **Browser Support**: Modern only (ES2020+, `backdrop-filter`, Optional Chaining `?.`)
- **Criticidad**: **ALTA** â€” Sistema de gestiÃ³n municipal en producciÃ³n con datos sensibles
- **Repositorio**: `lmonsalve22/ALGARROBO_BASE`

---

## ğŸ¯ OBJETIVOS DE NEGOCIO
Plataforma web municipal para la Ilustre Municipalidad de Algarrobo (Chile). Gestiona el ciclo completo de proyectos de inversiÃ³n pÃºblica: cartera, presupuesto, geolocalizaciÃ³n, hitos, documentos, informes, reportes ciudadanos y chatbot IA. Audiencia: funcionarios municipales con tres niveles de acceso (admin_general, admin_proyectos, director_obras).

---

## ğŸ—ï¸ ARQUITECTURA TÃ‰CNICA

### PatrÃ³n
**MPA (Multi-Page Application)** con renderizado Client-Side (CSR). Sin SPA router â€” cada vista es un `.html` independiente que carga scripts compartidos vÃ­a `<script>` tags globales. PatrÃ³n **Procedural/Modular implÃ­cito** sin encapsulamiento formal.

### Estructura de Capas

```
ALGARROBO_BASE/
â”œâ”€â”€ frontend/
â”‚   â”œâ”€â”€ index.html                      # Login (punto de entrada)
â”‚   â”œâ”€â”€ script/
â”‚   â”‚   â”œâ”€â”€ api.js                      # HTTP Client (objeto global `api`)
â”‚   â”‚   â”œâ”€â”€ router.js                   # Auth guard + routing + ofuscaciÃ³n
â”‚   â”‚   â”œâ”€â”€ layout.js                   # Header/Sidebar rendering
â”‚   â”‚   â”œâ”€â”€ utils.js                    # Formatters (objeto global `utils`)
â”‚   â”‚   â””â”€â”€ help.js                     # Sistema de ayuda contextual
â”‚   â”œâ”€â”€ division/secplan/
â”‚   â”‚   â”œâ”€â”€ admin_general/   (15 vistas)  # Nivel acceso 10
â”‚   â”‚   â”œâ”€â”€ admin_proyectos/ (9 vistas)   # Nivel acceso 11
â”‚   â”‚   â””â”€â”€ director_obras/  (7 vistas)   # Nivel acceso 12
â”‚   â”œâ”€â”€ administracion/      (14 vistas)  # Panel superadmin
â”‚   â”œâ”€â”€ geoportal/           (4 vistas)   # Mapas Leaflet + SRI
â”‚   â””â”€â”€ assets/                           # Recursos estÃ¡ticos
â”œâ”€â”€ backend/
â”‚   â”œâ”€â”€ app21.py             (126KB)      # Monolito FastAPI
â”‚   â””â”€â”€ .env                              # âš ï¸ CREDENCIALES EXPUESTAS
â”œâ”€â”€ database/                (5 SQL)      # Schemas PostgreSQL
â””â”€â”€ movil/                                # App ciudadana (separada)
```

### Flujo de Datos
1. `index.html` â†’ POST `/auth/login` â†’ recibe JWT + userData.
2. JWT se almacena en `localStorage('authToken')`.
3. Cada pÃ¡gina protegida carga `router.js` â†’ `checkLoginStatus()` valida sesiÃ³n.
4. `api.js` inyecta `Bearer ${token}` en cada request vÃ­a getter dinÃ¡mico.
5. Vistas consultan endpoints REST y renderizan con `innerHTML` + template literals.

### Estrategia de MÃ³dulos
**Scripts globales** (`<script src="...">`) â€” sin ESM, sin bundler, sin tree-shaking. Cada HTML carga manualmente los scripts que necesita en orden de dependencia.

### Web APIs Utilizadas
- **Fetch API** (sin AbortController)
- **localStorage** (auth, sesiÃ³n, preferencias)
- **DOM API** (querySelector, getElementById, innerHTML masivo)
- **Intl.NumberFormat** (formateo CLP)
- **TextEncoder/TextDecoder** (ofuscaciÃ³n de keys)
- **atob** (decodificaciÃ³n Base64)
- **Chart.js** (grÃ¡ficos)
- **Leaflet** (mapas, solo geoportal)

### Web Standards Compliance
**Parcial**. Usa features ES2020+ (optional chaining, nullish coalescing, template literals, async/await, spread operator). No usa Web Components, Custom Events entre mÃ³dulos, ni Service Workers.

### Dependencias Externas (CDN)
| LibrerÃ­a | CDN | SRI |
|---|---|---|
| TailwindCSS (Play CDN) | cdn.tailwindcss.com | âŒ **NO** |
| Font Awesome 6.4 | cdnjs.cloudflare.com | âŒ **NO** |
| Chart.js | cdn.jsdelivr.net | âŒ **NO** |
| Leaflet | unpkg.com | âœ… SÃ (solo geoportal) |
| Google Fonts (Outfit) | fonts.googleapis.com | N/A |

### Restricciones de Entorno
- API backend en IP hardcoded: `https://186.67.61.251:8000`
- Base path hardcoded: `/ALGARROBO_BASE`
- Sin CSP (Content Security Policy) headers
- Sin Service Worker / Offline capability
- TailwindCSS via Play CDN: **NO apto para producciÃ³n** (genera CSS en runtime)

---

## âš ï¸ RESTRICCIONES Y ÃREAS SENSIBLES

### ğŸ”´ Archivos CrÃ­ticos â€” NO TOCAR sin anÃ¡lisis de impacto
| Archivo | RazÃ³n |
|---|---|
| `backend/app21.py` | Monolito de 126KB, toda la lÃ³gica server-side |
| `frontend/script/router.js` | Auth guard: ejecuta `checkLoginStatus()` al cargar |
| `frontend/script/api.js` | HTTP client global, logout automÃ¡tico en 401 |
| `backend/.env` | Credenciales DB (Neon PostgreSQL) â€” **DEBE ser excluido de git** |

### Deuda TÃ©cnica Identificada

1. **DuplicaciÃ³n masiva**: 30+ vistas HTML replican estructura, estilos y lÃ³gica JS inline. Las 3 carpetas de roles (`admin_general`, `admin_proyectos`, `director_obras`) contienen cÃ³digo casi idÃ©ntico.
2. **Funciones duplicadas**: `logout()`, `toggleUserMenu()`, `toggleNotifications()` definidas en `router.js` Y en `layout.js`.
3. **Global scope pollution**: `api`, `utils`, `userData`, `token`, `charts`, `colors` expuestos en `window`.
4. **Archivo deprecated**: `chat_deprecated.html` aÃºn presente en `admin_proyectos`.
5. **console.log en producciÃ³n**: `console.log(localStorage)` en dashboards y headers de roles inferiores.
6. **OfuscaciÃ³n dÃ©bil**: `getKey()` en `router.js` usa XOR reversible para ocultar una API key.
7. **Backend .env commiteado**: Credenciales PostgreSQL (Neon) en el repositorio.
8. **TailwindCSS Play CDN**: No diseÃ±ado para producciÃ³n segÃºn documentaciÃ³n oficial.

---

## ğŸ¯ INSTRUCCIONES ESPECÃFICAS PARA EL PIPELINE

### A **error-watcher**:
> **EnfÃ³cate en**:
> - `JSON.parse()` sin try/catch en `router.js:49` (`checkLoginStatus`).
> - Accesos a propiedades anidadas de `data.user` en `index.html:298-300` sin null-safety (`data.user.division.nombre`).
> - `removeChild` en alert auto-dismiss de `index.html:347` â€” posible race condition si el usuario navega antes de 4.5s.
> - `api.js:38`: `localStorage.clear()` borra TODO al recibir 401, incluyendo datos no relacionados.
> - Listeners en `layout.js:306` y `router.js:81` â€” ambos escuchan `click` global sin cleanup, se acumulan en navegaciÃ³n SPA-like.
> - `help.js:423`: querySelector con cadena de clases frÃ¡gil para actualizar iconos.

### A **compliance-reviewer**:
> **Prioriza**:
> - **Supply Chain**: 40+ pÃ¡ginas cargan TailwindCSS, Font Awesome y Chart.js sin `integrity` SRI.
> - **Secret Exposure**: `backend/.env` con credenciales PostgreSQL commiteadas. API key ofuscada con XOR en `router.js:100`.
> - **XSS surfacing**: 200+ usos de `innerHTML` con template literals interpolando datos de API sin sanitizaciÃ³n.
> - **Sensitive Storage**: JWT token + userData (PII: nombre, roles, nivel_acceso) en localStorage â€” accesible por XSS.
> - **Data Leak**: `console.log(localStorage)` en cÃ³digo de producciÃ³n (filtraciÃ³n de tokens en DevTools).

### A **code-reviewer**:
> **Validar**:
> - DOM Thrashing en `dashboard.html:731-798`: 15+ `getElementById` secuenciales sin cachÃ©.
> - DuplicaciÃ³n: `logout()` x2, `toggleUserMenu()` x2, `toggleNotifications()` x2 entre `router.js` y `layout.js`.
> - `utils.formatCompactNumber`: retorna `'$0'` para `0` vÃ¡lido (falsy check con `!number`).
> - Global listeners redundantes en `router.js:81` y `layout.js:306`.
> - Dead code: `strToBytes`, `bytesToStr`, `getKey` en `router.js` â€” verificar consumo real.

### A **architecture-reviewer**:
> **Evaluar**:
> - Ausencia de capa de estado (Store/State Management).
> - Acoplamiento UI-lÃ³gica: toda la business logic estÃ¡ inline en cada HTML.
> - 30+ archivos HTML con estructura idÃ©ntica â†’ candidatos a template/component system.
> - DirecciÃ³n de dependencias: vistas dependen directamente de globals, no de abstracciones.

---

## ğŸ“Š RESUMEN EJECUTIVO
1. **Robustez**: CÃ³digo funcional pero frÃ¡gil â€” mÃºltiples vectores de fallo en runtime por falta de null-safety y error handling.
2. **Seguridad**: ExposiciÃ³n CRÃTICA de credenciales en `.env` y supply chain sin SRI. Token JWT en localStorage vulnerable a XSS.
3. **Coherencia**: Alta deuda tÃ©cnica por duplicaciÃ³n masiva entre roles. Arquitectura procedural que no escala.





