# ğŸ› ï¸ REPORTE: refactor-suggester â€” Plan de AcciÃ³n Priorizado
**Fecha**: 2026-02-19 | **Agente**: refactor-suggester v2.1 | **EstÃ¡ndar**: Incremental Refactoring / Native JS

---

## 1ï¸âƒ£ QUICK WINS (P0/P1) â€” Bajo Riesgo, Alto Impacto

### REF-001 Â· Eliminar credenciales expuestas en `.env`
**ğŸ”¨ Refactor**: RotaciÃ³n de secretos + exclusiÃ³n de git
**ğŸ¯ Objetivo**: SEC-001 (Compliance)
**ğŸ’» CÃ³digo**:
```bash
# 1. Agregar a .gitignore
echo "backend/.env" >> .gitignore

# 2. Eliminar del tracking
git rm --cached backend/.env

# 3. Crear .env.example
echo 'DATABASE_URL="postgresql://user:password@host/db?sslmode=require"' > backend/.env.example

# 4. ROTACIÃ“N INMEDIATA de password en Neon Dashboard
```
**âš ï¸ Riesgo**: Bajo
**â±ï¸ Esfuerzo**: S (15 min + rotaciÃ³n en Neon)

---

### REF-002 Â· Agregar try/catch a `checkLoginStatus()`
**ğŸ”¨ Refactor**: Proteger JSON.parse contra datos corruptos
**ğŸ¯ Objetivo**: ERR-001 (Errors)
**ğŸ’» CÃ³digo**:
```javascript
// BEFORE (router.js:43-58)
function checkLoginStatus() {
    const userDataString = localStorage.getItem('userData') || localStorage.getItem('user_data');
    if (!userDataString) { /* redirect */ }
    const userData = JSON.parse(userDataString);  // ğŸ’¥ puede explotar
    // ...
}

// AFTER
function checkLoginStatus() {
    const userDataString = localStorage.getItem('userData') || localStorage.getItem('user_data');
    if (!userDataString) {
        window.location.href = `${BASE}/frontend/index.html`;
        return [null, null];
    }
    let userData;
    try {
        userData = JSON.parse(userDataString);
    } catch (e) {
        console.error('Datos de sesiÃ³n corruptos, limpiando...');
        ['isLoggedIn', 'authToken', 'userData', 'user_data', 'user'].forEach(
            k => localStorage.removeItem(k)
        );
        window.location.href = `${BASE}/frontend/index.html`;
        return [null, null];
    }
    const isLoggedIn = localStorage.getItem('isLoggedIn');
    const token = localStorage.getItem('authToken');
    if (!isLoggedIn || isLoggedIn !== 'true' || !token) {
        window.location.href = `${BASE}/frontend/index.html`;
        return [null, null];
    }
    return [token, userData];
}
```
**âš ï¸ Riesgo**: Bajo
**â±ï¸ Esfuerzo**: S (10 min)

---

### REF-003 Â· Null-safety en login response handler
**ğŸ”¨ Refactor**: Optional chaining en acceso a `data.user`
**ğŸ¯ Objetivo**: ERR-002 (Errors)
**ğŸ’» CÃ³digo**:
```javascript
// BEFORE (index.html:298-300)
const division = data.user.division && data.user.division.nombre
    ? data.user.division.nombre.toLowerCase() : 'secplan';
const roles = data.user.roles || [];
const rol = roles.length > 0 ? roles[0].nombre.toLowerCase() : 'admin_general';

// AFTER
const division = data.user?.division?.nombre?.toLowerCase() ?? 'secplan';
const roles = data.user?.roles ?? [];
const rol = roles[0]?.nombre?.toLowerCase() ?? 'admin_general';
```
**âš ï¸ Riesgo**: Bajo
**â±ï¸ Esfuerzo**: S (5 min)

---

### REF-004 Â· Eliminar `console.log(localStorage)` de producciÃ³n
**ğŸ”¨ Refactor**: Eliminar logs que exponen tokens
**ğŸ¯ Objetivo**: ERR-009, SEC-008 (Errors + Compliance)
**ğŸ’» CÃ³digo**:
```bash
# Archivos a limpiar:
# - division/secplan/director_obras/calendario.html:920
# - division/secplan/director_obras/dashboard.html:483
# - division/secplan/admin_proyectos/calendario.html:920
# - division/secplan/admin_proyectos/dashboard.html:482
# - division/secplan/director_obras/header.html:195
# Eliminar lÃ­neas: console.log(localStorage)
```
**âš ï¸ Riesgo**: Bajo
**â±ï¸ Esfuerzo**: S (10 min)

---

### REF-005 Â· Reemplazar `localStorage.clear()` por eliminaciÃ³n selectiva
**ğŸ”¨ Refactor**: Evitar borrar datos no-auth
**ğŸ¯ Objetivo**: ERR-004 (Errors)
**ğŸ’» CÃ³digo**:
```javascript
// BEFORE (api.js:38)
localStorage.clear();

// AFTER
['authToken', 'isLoggedIn', 'userData', 'user_data', 'user'].forEach(
    k => localStorage.removeItem(k)
);
```
**âš ï¸ Riesgo**: Bajo
**â±ï¸ Esfuerzo**: S (5 min)

---

### REF-006 Â· Eliminar funciones duplicadas en `layout.js`
**ğŸ”¨ Refactor**: Consolidar logout, toggleUserMenu, toggleNotifications
**ğŸ¯ Objetivo**: CQ-002, CQ-003, CQ-004 (Code Quality)
**ğŸ’» CÃ³digo**:
```javascript
// ELIMINAR de layout.js (lÃ­neas 287-311):
// - function toggleUserMenu() { ... }
// - function toggleNotifications() { ... }
// - function logout() { ... }
// - document.addEventListener('click', ...) â†’ para cerrar menÃº
// Mantener SOLO las definiciones en router.js
```
**âš ï¸ Riesgo**: Bajo (verificar que router.js siempre cargue antes que layout.js)
**â±ï¸ Esfuerzo**: S (15 min)

---

## 2ï¸âƒ£ MEJORAS DE CALIDAD (P2) â€” Riesgo Medio

### REF-007 Â· Agregar SRI a Font Awesome y Chart.js
**ğŸ”¨ Refactor**: Supply chain hardening
**ğŸ¯ Objetivo**: SEC-003 (Compliance)
**ğŸ’» CÃ³digo**:
```html
<!-- Font Awesome con SRI (generar hash real con srihash.org) -->
<link rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
      integrity="sha512-iecdLmaskl0HPYkZLRyzg..."
      crossorigin="anonymous" referrerpolicy="no-referrer" />

<!-- Chart.js con SRI -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"
        integrity="sha384-..."
        crossorigin="anonymous"></script>
```
**âš ï¸ Riesgo**: Medio (requiere fijar versiones exactas)
**â±ï¸ Esfuerzo**: M (40+ archivos para actualizar)

---

### REF-008 Â· Implementar `escapeHTML()` helper
**ğŸ”¨ Refactor**: SanitizaciÃ³n contra XSS
**ğŸ¯ Objetivo**: SEC-004 (Compliance)
**ğŸ’» CÃ³digo**:
```javascript
// Agregar a utils.js:
escapeHTML(str) {
    if (str == null) return '';
    const div = document.createElement('div');
    div.textContent = String(str);
    return div.innerHTML;
}

// Uso en innerHTML:
container.innerHTML = `<span>${utils.escapeHTML(project.nombre)}</span>`;
```
**âš ï¸ Riesgo**: Medio (requiere auditar 200+ usos de innerHTML)
**â±ï¸ Esfuerzo**: L (aplicaciÃ³n progresiva, empezar por datos de usuario)

---

### REF-009 Â· Cachear nodos DOM en dashboard
**ğŸ”¨ Refactor**: Eliminar DOM thrashing
**ğŸ¯ Objetivo**: CQ-001 (Code Quality)
**ğŸ’» CÃ³digo**:
```javascript
// dashboard.html â€” Cachear al inicio:
const KPI_ELEMENTS = {};
document.addEventListener('DOMContentLoaded', () => {
    ['totalProjects','activeProjects','statInversion','totalInversion',
     'statAvance','statAreas','statPrioritarios','statProfesionales',
     'statSectores','statMontoPromedio','statFinanciamientos',
     'statAnnoActivo','statMayorInversion','statEsteAnno','lastUpdate'
    ].forEach(id => KPI_ELEMENTS[id] = document.getElementById(id));
    loadDashboardData();
});

function updateKPI(id, value) {
    if (KPI_ELEMENTS[id]) KPI_ELEMENTS[id].textContent = value;
}
```
**âš ï¸ Riesgo**: Bajo
**â±ï¸ Esfuerzo**: M (aplicar a 3 dashboards)

---

### REF-010 Â· Migrar API key al backend
**ğŸ”¨ Refactor**: Eliminar secreto del frontend
**ğŸ¯ Objetivo**: SEC-006 (Compliance)
**ğŸ’» CÃ³digo**:
```python
# Backend (app21.py) â€” nuevo endpoint:
@app.get("/api/ai-config")
async def get_ai_config(user: User = Depends(get_current_user)):
    return {"endpoint": settings.AI_ENDPOINT, "temp_token": generate_temp_token()}

# Frontend â€” consumir:
const aiConfig = await api.get('/api/ai-config');
```
**âš ï¸ Riesgo**: Medio
**â±ï¸ Esfuerzo**: M (backend + frontend change)

---

## 3ï¸âƒ£ EVOLUCIÃ“N ARQUITECTÃ“NICA (P3) â€” Riesgo Alto, Impacto EstratÃ©gico

### REF-011 Â· Unificar vistas por rol â†’ Sistema de capabilities
**ğŸ”¨ Refactor**: Eliminar 25+ archivos duplicados
**ğŸ¯ Objetivo**: ARCH-002 (Architecture)
**ğŸ’» Concepto**:
```
# ANTES: 31 archivos (15+9+7)
division/secplan/admin_general/dashboard.html
division/secplan/admin_proyectos/dashboard.html  â† 85% idÃ©ntico
division/secplan/director_obras/dashboard.html   â† 85% idÃ©ntico

# DESPUÃ‰S: 15 archivos + 1 config
division/secplan/views/dashboard.html            â† vista Ãºnica
division/secplan/capabilities.js                 â† permisos por nivel
```
**âš ï¸ Riesgo**: Alto (refactor estructural mayor)
**â±ï¸ Esfuerzo**: L (2-3 dÃ­as, requiere testing exhaustivo)

---

### REF-012 Â· Migrar a mÃ³dulos ESM
**ğŸ”¨ Refactor**: Eliminar globals, habilitar tree-shaking
**ğŸ¯ Objetivo**: ARCH-004 (Architecture)
**ğŸ’» Concepto**:
```html
<!-- ANTES -->
<script src="router.js"></script>
<script src="api.js"></script>
<script src="utils.js"></script>

<!-- DESPUÃ‰S -->
<script type="module" src="script/main.js"></script>
```
```javascript
// main.js
import { api } from './api.js';
import { checkAuth, logout } from './router.js';
import { renderLayout } from './layout.js';

const [token, user] = checkAuth();
renderLayout(user);
```
**âš ï¸ Riesgo**: Alto (afecta todas las pÃ¡ginas)
**â±ï¸ Esfuerzo**: L (3-5 dÃ­as)

---

### REF-013 Â· Compilar TailwindCSS localmente
**ğŸ”¨ Refactor**: Eliminar dependencia de Play CDN
**ğŸ¯ Objetivo**: SEC-002 (Compliance)
**ğŸ’» Concepto**:
```bash
# InstalaciÃ³n
npm init -y
npm install -D tailwindcss
npx tailwindcss init

# Build
npx tailwindcss -i ./src/input.css -o ./frontend/css/tailwind.min.css --minify

# En HTML: reemplazar CDN por archivo local
# <script src="https://cdn.tailwindcss.com"></script>
# â†’ <link rel="stylesheet" href="/css/tailwind.min.css">
```
**âš ï¸ Riesgo**: Medio (puede haber clases Tailwind dinÃ¡micas que no detecte el purge)
**â±ï¸ Esfuerzo**: M (1 dÃ­a + verificaciÃ³n visual)

---

## ğŸ“Š ROADMAP SUGERIDO

| Sprint | Refactors | Esfuerzo Total | Impacto |
|--------|-----------|----------------|---------|
| **Sprint 1** (Urgente) | REF-001 â†’ REF-006 | ~1h | Seguridad + Estabilidad |
| **Sprint 2** (Semana 1) | REF-007 â†’ REF-010 | ~1-2 dÃ­as | Supply Chain + XSS |
| **Sprint 3** (Semana 2-3) | REF-011 â†’ REF-013 | ~5-8 dÃ­as | Arquitectura + Escalabilidad |
