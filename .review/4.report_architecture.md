# ğŸ—ï¸ REPORTE: architecture-reviewer â€” SPA/MPA Architecture & Design Patterns
**Fecha**: 2026-02-19 | **Agente**: architecture-reviewer v2.1 | **EstÃ¡ndar**: Frontend Architecture / Native Design Patterns

---

## ARCH-001 Â· Ausencia de capa de estado (State Management)

**ğŸ—ï¸ Aspecto**: GestiÃ³n de Estado Aplicativo
**ğŸ“ PatrÃ³n Detectado**: **Ninguno** â€” estado distribuido en variables locales de cada pÃ¡gina + `localStorage` como pseudo-store.
**âš ï¸ Riesgo ArquitectÃ³nico**: **Alto** â€” No existe una fuente de verdad para el estado de la aplicaciÃ³n.

**AnÃ¡lisis**:
- El "estado" estÃ¡ fragmentado en:
  - `localStorage`: auth token, userData, rememberUser, userRole.
  - Variables globales: `token`, `userData` (expuestas por `router.js:79`).
  - Variables locales: `projects`, `charts`, `colors` dentro de cada HTML.
- No hay mecanismo de reactividad: cambios en datos no propagan updates a la UI.
- Cada vista re-fetcha datos del servidor independientemente, sin cachÃ© compartida.

**ğŸ“ˆ RecomendaciÃ³n**:
Implementar un **Store minimalista** con patrÃ³n Observer:
```javascript
// store.js
const Store = {
    _state: {},
    _listeners: new Map(),
    
    get(key) { return this._state[key]; },
    set(key, value) {
        this._state[key] = value;
        (this._listeners.get(key) || []).forEach(fn => fn(value));
    },
    subscribe(key, fn) {
        if (!this._listeners.has(key)) this._listeners.set(key, []);
        this._listeners.get(key).push(fn);
        return () => this._listeners.get(key).splice(
            this._listeners.get(key).indexOf(fn), 1
        );
    }
};
```

---

## ARCH-002 Â· DuplicaciÃ³n masiva: 3 roles Ã— N vistas = cÃ³digo replicado

**ğŸ—ï¸ Aspecto**: Estrategia de Role-based Views
**ğŸ“ PatrÃ³n Detectado**: **Copy-Paste Inheritance** â€” cada carpeta de rol duplica las mismas vistas con variaciones mÃ­nimas.
**âš ï¸ Riesgo ArquitectÃ³nico**: **CrÃ­tico** â€” Multiplicador de deuda tÃ©cnica.

**AnÃ¡lisis**:
```
division/secplan/
â”œâ”€â”€ admin_general/   â†’ 15 archivos (dashboard, proyecto, mapa, informe, calendario, etc.)
â”œâ”€â”€ admin_proyectos/ â†’ 9 archivos  (subconjunto IDÃ‰NTICO con leves restricciones)
â””â”€â”€ director_obras/  â†’ 7 archivos  (subconjunto IDÃ‰NTICO con menos opciones)
```
- `dashboard.html` en las 3 carpetas comparte ~85% del cÃ³digo.
- `proyecto.html`, `mapa.html`, `informe.html`, `calendario.html` prÃ¡cticamente idÃ©nticos.
- Las diferencias se limitan a: visibilidad de botones (crear/editar/eliminar) y menÃº de navegaciÃ³n.

**CÃ¡lculo de impacto**: ~31 archivos HTML con ~80% de duplicaciÃ³n = **~25 archivos de cÃ³digo innecesario**.

**ğŸ“ˆ RecomendaciÃ³n**: **Template + Capability System**:
```
division/secplan/
â”œâ”€â”€ views/           â†’ 1 copia de cada vista (dashboard.html, proyecto.html, etc.)
â”œâ”€â”€ capabilities.js  â†’ define permisos por nivel de acceso
â””â”€â”€ view-guard.js    â†’ oculta/muestra elements basado en capabilities
```
```javascript
// capabilities.js
const CAPABILITIES = {
    10: { canCreate: true, canDelete: true, canAdmin: true, views: ['*'] },
    11: { canCreate: true, canDelete: false, canAdmin: false, views: ['dashboard','proyecto','mapa','informe','calendario','documento'] },
    12: { canCreate: false, canDelete: false, canAdmin: false, views: ['dashboard','proyecto','mapa','informe','calendario'] }
};
```

---

## ARCH-003 Â· Acoplamiento UI â†” LÃ³gica de Negocio (God HTML)

**ğŸ—ï¸ Aspecto**: SeparaciÃ³n de Concernientes
**ğŸ“ PatrÃ³n Detectado**: **Inline Monolith** â€” HTML, CSS y JS coexisten en cada archivo sin boundaries.
**âš ï¸ Riesgo ArquitectÃ³nico**: **Alto** â€” Imposibilita testing unitario y reutilizaciÃ³n.

**AnÃ¡lisis**:
- Ejemplo: `dashboard.html` (1097 lÃ­neas):
  - L1-216: HTML + CSS embebido
  - L700-1097: JavaScript inline con business logic (KPI calculations, chart configs, API calls)
- No existe capa de servicios intermediaria: vistas llaman directamente a `api.get()`.
- LÃ³gica de cÃ¡lculo de KPIs (promedios, conteos, agrupaciones) embebida en funciones de rendering.

**ğŸ“ˆ RecomendaciÃ³n**: Extraer capas:
```
script/
â”œâ”€â”€ api.js           â†’ HTTP Client (ya existe)
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ projectService.js    â†’ fetch + transformaciÃ³n de datos
â”‚   â””â”€â”€ userService.js       â†’ auth + user management
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ kpiCard.js           â†’ renderizado de tarjetas
â”‚   â””â”€â”€ chartBuilder.js      â†’ factory de Chart.js
â””â”€â”€ pages/
    â””â”€â”€ dashboardController.js â†’ orquestaciÃ³n
```

---

## ARCH-004 Â· Global Scope Pollution: 10+ sÃ­mbolos en window

**ğŸ—ï¸ Aspecto**: Encapsulamiento / Module Boundaries
**ğŸ“ PatrÃ³n Detectado**: **Script Tag Loading** sin ESM
**âš ï¸ Riesgo ArquitectÃ³nico**: **Medio-Alto** â€” Colisiones de nombres, dependencias implÃ­citas.

**AnÃ¡lisis de globals expuestos**:
| SÃ­mbolo | Archivo | Tipo |
|---------|---------|------|
| `API_CONFIG` | api.js | const |
| `api` | api.js | const |
| `BASE` | router.js | const |
| `diccionarioRutas` | router.js | const |
| `token` | router.js | const (top-level) |
| `userData` | router.js | const (top-level) |
| `utils` | utils.js | const |
| `helpContent` | help.js | const |
| `logout()` | router.js + layout.js | function |
| `toggleUserMenu()` | router.js + layout.js | function |
| `checkLoginStatus()` | router.js | function |
| `showToast()` | layout.js | function |
| `showHelpModal()` | help.js | function |
| `charts` | dashboard.html | let |
| `colors` | dashboard.html | const |

**ğŸ“ˆ RecomendaciÃ³n**: Migrar a mÃ³dulos ESM:
```html
<script type="module" src="script/main.js"></script>
```
```javascript
// main.js
import { api } from './api.js';
import { checkAuth } from './router.js';
import { renderLayout } from './layout.js';
```

---

## ARCH-005 Â· ComunicaciÃ³n entre componentes: Inexistente

**ğŸ—ï¸ Aspecto**: Inter-Component Communication
**ğŸ“ PatrÃ³n Detectado**: **Ninguno** â€” los "componentes" (header, sidebar, main content) no se comunican entre sÃ­.
**âš ï¸ Riesgo ArquitectÃ³nico**: **Medio** â€” Limita la capacidad de crear funcionalidades interactivas.

**AnÃ¡lisis**:
- Header, Sidebar y Content son renderizados independientemente.
- No hay Custom Events, Event Bus, ni Pub/Sub.
- El sidebar no reacciona a cambios de estado en el contenido principal.
- Los filtros de proyecto no propagan cambios al mapa o calendario.

**ğŸ“ˆ RecomendaciÃ³n**: Implementar un Event Bus simple:
```javascript
// eventBus.js
const EventBus = {
    _events: {},
    on(event, fn) { (this._events[event] ??= []).push(fn); },
    off(event, fn) { this._events[event] = (this._events[event] || []).filter(f => f !== fn); },
    emit(event, data) { (this._events[event] || []).forEach(fn => fn(data)); }
};
```

---

## ARCH-006 Â· Template Management: Strings HTML en JavaScript

**ğŸ—ï¸ Aspecto**: Estrategia de Renderizado
**ğŸ“ PatrÃ³n Detectado**: **String Concatenation** â€” template literals para generar HTML.
**âš ï¸ Riesgo ArquitectÃ³nico**: **Medio** â€” Propenso a XSS, difÃ­cil de mantener, sin validaciÃ³n.

**AnÃ¡lisis**:
- `layout.js`: renderHeader() y renderSidebar() generan bloques de 80+ lÃ­neas de HTML via template literals.
- `help.js`: modal de 30 lÃ­neas generado como string.
- Vistas: tablas de proyectos construidas con `.map()` â†’ `innerHTML`.
- No se usa `DocumentFragment`, `cloneNode`, `<template>`, ni Web Components.

**ğŸ“ˆ RecomendaciÃ³n (evolutiva)**:
1. **Inmediato**: Usar `<template>` elements en HTML + `cloneNode` para instanciaciÃ³n.
2. **Mediano plazo**: Web Components para header, sidebar, toast, modal.
3. **Largo plazo**: Considerar lit-html o hyperHTML para rendering declarativo sin framework.

---

## ğŸ“Š DIAGRAMA DE DEPENDENCIAS ACTUAL

```
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  index.html â”‚ (Login)
                    â”‚  (standalone)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ redirect
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â–¼               â–¼               â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚admin_generalâ”‚ â”‚admin_proyectâ”‚ â”‚director_obraâ”‚
    â”‚  (15 vistas)â”‚ â”‚  (9 vistas) â”‚ â”‚  (7 vistas) â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
           â”‚               â”‚               â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ <script src="...">
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚   GLOBALS   â”‚
                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
                    â”‚ router.js   â”‚ â†’ auth guard, routing, globals
                    â”‚ api.js      â”‚ â†’ HTTP client
                    â”‚ utils.js    â”‚ â†’ formatters
                    â”‚ layout.js   â”‚ â†’ header/sidebar render
                    â”‚ help.js     â”‚ â†’ modal system
                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
                           â”‚ fetch()
                    â”Œâ”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”
                    â”‚  Backend    â”‚
                    â”‚ app21.py    â”‚ (FastAPI)
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š CONCLUSIÃ“N ARQUITECTÃ“NICA

| Aspecto | Estado | Prioridad de Mejora |
|---------|--------|---------------------|
| Capas de separaciÃ³n | ğŸ”´ Inexistente | P1 |
| DuplicaciÃ³n de cÃ³digo | ğŸ”´ CrÃ­tica (30+ archivos) | P0 |
| State Management | ğŸ”´ Inexistente | P2 |
| Module System | ğŸŸ¡ Global Scripts | P2 |
| Component Communication | ğŸŸ¡ No existe | P3 |
| Template Strategy | ğŸŸ¡ String-based | P3 |
