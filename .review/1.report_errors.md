# ğŸ› ï¸ REPORTE: error-watcher â€” Runtime Reliability
**Fecha**: 2026-02-19 | **Agente**: error-watcher v2.1 | **EstÃ¡ndar**: Vanilla JS Runtime Reliability

---

## ERR-001 Â· `JSON.parse` sin protecciÃ³n en auth guard
**â— Problema**: `checkLoginStatus()` parsea `userData` de localStorage sin `try/catch`. Si el valor es corrupto o malformado, lanza excepciÃ³n no capturada que bloquea la carga de TODAS las pÃ¡ginas protegidas.
**ğŸ“ UbicaciÃ³n**: `frontend/script/router.js:49`
**ğŸ’¥ Escenario de Fallo**:
1. Usuario manipula `localStorage` manualmente (DevTools, extensiÃ³n).
2. Se almacena un string no-JSON en `userData`.
3. `JSON.parse(userDataString)` lanza `SyntaxError`.
4. Script aborta â†’ pÃ¡gina queda en blanco sin redirect a login.
**âš ï¸ Impacto**: **CrÃ­tico** â€” Bloquea toda la aplicaciÃ³n.
**ğŸ› ï¸ Fix Sugerido**:
```javascript
let userData;
try {
    userData = JSON.parse(userDataString);
} catch (e) {
    console.error('userData corrupta, redirigiendo a login');
    localStorage.clear();
    window.location.href = `${BASE}/frontend/index.html`;
    return [null, null];
}
```

---

## ERR-002 Â· Acceso a propiedades anidadas sin null-safety en login
**â— Problema**: Tras login exitoso se accede a `data.user.division.nombre` y `data.user.roles[0].nombre` sin verificar existencia de objetos intermedios.
**ğŸ“ UbicaciÃ³n**: `frontend/index.html:298-300`
**ğŸ’¥ Escenario de Fallo**:
1. Backend retorna `user` sin campo `division` o con `roles: []`.
2. `data.user.division.nombre` â†’ `TypeError: Cannot read properties of undefined`.
3. Login se aborta en `.catch()`, usuario no puede entrar al sistema.
**âš ï¸ Impacto**: **Alto** â€” Login bloqueado para usuarios sin divisiÃ³n/rol asignado.
**ğŸ› ï¸ Fix Sugerido**:
```javascript
const division = data.user?.division?.nombre?.toLowerCase() ?? 'secplan';
const roles = data.user?.roles ?? [];
const rol = roles.length > 0 ? roles[0]?.nombre?.toLowerCase() ?? 'admin_general' : 'admin_general';
```

---

## ERR-003 Â· Race condition en removeChild de alertas
**â— Problema**: `showAlert()` programa `removeChild(alertDiv)` a los 4.5s. Si el contenedor es limpiado antes (por `clearAlerts()` o nueva alerta), `removeChild` falla porque el nodo ya no es hijo.
**ğŸ“ UbicaciÃ³n**: `frontend/index.html:347`
**ğŸ’¥ Escenario de Fallo**:
1. Usuario envÃ­a formulario â†’ se muestra alerta de error.
2. Usuario reenvÃ­a antes de 4.5s â†’ `clearAlerts()` ejecuta `innerHTML = ''`.
3. setTimeout previo ejecuta `alertContainer.removeChild(alertDiv)` â†’ `DOMException: Node not found`.
**âš ï¸ Impacto**: **Medio** â€” Error silencioso en consola, UX no afectada visualmente.
**ğŸ› ï¸ Fix Sugerido**:
```javascript
setTimeout(() => {
    if (alertDiv.parentNode === alertContainer) {
        alertContainer.removeChild(alertDiv);
    }
}, 500);
```

---

## ERR-004 Â· `localStorage.clear()` destruye datos no relacionados en 401
**â— Problema**: Al recibir un 401, `api.js` ejecuta `localStorage.clear()` que borra TODOS los datos, incluyendo `rememberUser`, preferencias de UI y datos de otras aplicaciones en el mismo dominio.
**ğŸ“ UbicaciÃ³n**: `frontend/script/api.js:38`
**ğŸ’¥ Escenario de Fallo**:
1. Token expira durante uso normal.
2. `localStorage.clear()` borra preferencias de "RecuÃ©rdame" y cualquier estado local persistido.
3. Post-login, usuario pierde configuraciÃ³n guardada.
**âš ï¸ Impacto**: **Medio** â€” PÃ©rdida de datos de preferencias.
**ğŸ› ï¸ Fix Sugerido**:
```javascript
// Reemplazar localStorage.clear() con eliminaciÃ³n selectiva:
['authToken', 'isLoggedIn', 'userData', 'user_data', 'user'].forEach(k => localStorage.removeItem(k));
```

---

## ERR-005 Â· Listeners globales duplicados sin cleanup
**â— Problema**: `router.js:81` y `layout.js:306` registran cada uno un listener `click` en `document` para cerrar el menÃº de usuario. Ambos se ejecutan en cada clic, y no se remueven nunca.
**ğŸ“ UbicaciÃ³n**: `frontend/script/router.js:81` y `frontend/script/layout.js:306`
**ğŸ’¥ Escenario de Fallo**:
1. Cada pÃ¡gina carga ambos scripts.
2. Se registran 2 listeners idÃ©nticos en `document`.
3. Al navegar entre pÃ¡ginas (si se implementa SPA), se acumulan.
**âš ï¸ Impacto**: **Bajo** â€” Overhead menor en MPA actual, pero obstÃ¡culo para evoluciÃ³n a SPA.
**ğŸ› ï¸ Fix Sugerido**: Consolidar en un Ãºnico archivo. Eliminar las funciones duplicadas de `layout.js:287-311`.

---

## ERR-006 Â· querySelector frÃ¡gil para actualizar iconos en help modal
**â— Problema**: `showHelpModal()` usa un selector CSS enorme con 12 clases Font Awesome concatenadas para buscar el icono existente y actualizarlo. Si Font Awesome cambia nombres de clases o se agrega un nuevo tipo de ayuda, el selector falla silenciosamente.
**ğŸ“ UbicaciÃ³n**: `frontend/script/help.js:423`
**ğŸ’¥ Escenario de Fallo**:
1. Se agrega un nuevo `helpContent` con icono `fa-wrench`.
2. querySelector no lo incluye en la cadena de OR â†’ `.remove()` se invoca en `null`.
3. `TypeError: Cannot read properties of null`.
**âš ï¸ Impacto**: **Medio** â€” Crash al abrir ayuda de nueva secciÃ³n.
**ğŸ› ï¸ Fix Sugerido**:
```javascript
// Usar un data-attribute dedicado:
const iconEl = modal.querySelector('[data-help-icon]');
if (iconEl) {
    iconEl.className = `fas ${content.icon} text-xl`;
}
```

---

## ERR-007 Â· `checkLoginStatus()` ejecuta en top-level â€” bloquea rendering
**â— Problema**: `router.js:79` ejecuta `checkLoginStatus()` como statement top-level. Si `localStorage` estÃ¡ vacÃ­o, dispara `window.location.href` inmediatamente, antes de que el DOM se renderice. En caso de redirecciÃ³n fallida, la destructuraciÃ³n `const [token, userData]` recibe `[null, null]` pero el cÃ³digo downstream puede acceder `userData.nombre`.
**ğŸ“ UbicaciÃ³n**: `frontend/script/router.js:79`
**ğŸ’¥ Escenario de Fallo**:
1. Script se carga en `<head>` (lÃ­nea 5 de `dashboard.html`).
2. `checkLoginStatus()` ejecuta antes de DOMContentLoaded.
3. Si la redirecciÃ³n es bloqueada por extensiones, `userData = null` y las funciones de `layout.js` fallan.
**âš ï¸ Impacto**: **Alto** â€” PÃ¡gina en blanco si el redirect es interceptado.
**ğŸ› ï¸ Fix Sugerido**: Envolver en `DOMContentLoaded` o verificar `userData !== null` en `layout.js` antes de usarlo.

---

## ERR-008 Â· `formatCompactNumber` retorna '$0' para valores legÃ­timos de 0
**â— Problema**: La funciÃ³n usa `if (!number) return '$0'` â€” esto incluye `0`, `NaN`, `null`, `undefined`, y `""`. Un proyecto con monto legÃ­timo de `$0` es indistinguible de un error de datos.
**ğŸ“ UbicaciÃ³n**: `frontend/script/utils.js:47`
**ğŸ’¥ Escenario de Fallo**:
1. Proyecto con monto `0` (ej: donaciÃ³n, trabajo voluntario).
2. `formatCompactNumber(0)` â†’ `'$0'` por path correcto, pero `formatCompactNumber(NaN)` â†’ tambiÃ©n `'$0'`.
3. No se puede distinguir dato vÃ¡lido de error.
**âš ï¸ Impacto**: **Bajo** â€” Funcional pero semÃ¡nticamente incorrecto.
**ğŸ› ï¸ Fix Sugerido**:
```javascript
formatCompactNumber(number) {
    if (number == null || isNaN(number)) return '$0';
    // ... resto de la lÃ³gica
}
```

---

## ERR-009 Â· `console.log(localStorage)` en producciÃ³n
**â— Problema**: MÃºltiples archivos de dashboards y headers de roles inferiores imprimen el contenido completo de `localStorage` (incluyendo tokens JWT y datos de usuario) en la consola.
**ğŸ“ UbicaciÃ³n**:
- `division/secplan/director_obras/calendario.html:920`
- `division/secplan/director_obras/dashboard.html:483`
- `division/secplan/admin_proyectos/calendario.html:920`
- `division/secplan/admin_proyectos/dashboard.html:482`
- `division/secplan/director_obras/header.html:195`
**ğŸ’¥ Escenario de Fallo**:
1. Cualquier usuario abre DevTools.
2. Token JWT y PII visibles en plaintext en consola.
**âš ï¸ Impacto**: **Alto** â€” FiltraciÃ³n de credenciales.
**ğŸ› ï¸ Fix Sugerido**: Eliminar todas las lÃ­neas `console.log(localStorage)`.

---

## ğŸ“Š RESUMEN DE SEVERIDAD

| Severidad | Cantidad | IDs |
|-----------|----------|-----|
| ğŸ”´ CrÃ­tico | 1 | ERR-001 |
| ğŸŸ  Alto | 3 | ERR-002, ERR-007, ERR-009 |
| ğŸŸ¡ Medio | 3 | ERR-003, ERR-004, ERR-006 |
| ğŸŸ¢ Bajo | 2 | ERR-005, ERR-008 |
